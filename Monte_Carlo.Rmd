---
title: "Monte Carlo Simulation"
author: "Danny Ettelson"
date: "1/21/2019"
output:
  pdf_document: default
  word_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r loadlib}

library(tidyverse)
library(dplyr)
library(RColorBrewer)
library(lubridate)

```


CONTEXT


```{r hourly_demand, message=FALSE, warning=FALSE}

source("hourly_demand_function.R")


#hourly_demand()

#test <- hourly_demand(method = 2, ....)

```



SIMULATION



```{r simulation}


simulation <- function(simulations = 100, 
                       methods_included = c(1:3),
                       sim_method = mthd,
                       sim_avg_elasticity = avg_elst,
                       sim_seg = sg,
                       sim_month = mth, #baseline month
                       sim_year = yr, #baseline year
                       sim_include_wknds = wknds,
                       sim_charger_power = pwr,
                       sim_elasticity_schedule = sch, 
                       sim_price_change = p_c, 
                       sim_intervention_hours = i_h,
                       sim_intervention_chargers = int_ch,
                       sim_price_change_2 = p_c_2,
                       sim_intervention_hours_2 = i_h_2,
                       sim_int_equals_baseline = int_e_b, 
                       sim_throttle_amount = t_a, 
                       sim_throttle_hours = t_h,
                       sim_air_pollution_comm = a_p_co,
                       sim_price_comm = p_co,
                       sim_curt_year=c_yr,
                       sim_new_tou = n_tou) {

  ##create lists to sample from for each variable to sample from
  #method
  method_draws <- sample(methods_included, simulations, replace = TRUE)
  
  #self and cross elasticities 
  #eliminate cross elasticities from 0 to 1
   if(sim_method == 4) {
    Elasticities <- Elasticities_cross
  } else{
    Elasticities <- Elasticities_no_cross
  }
  
   if(sim_include_wknds == TRUE) {
    Elasticities <- Elasticities
  } else {
    Elasticities <- Elasticities[1:8] # filters for first 6 elasticities (first two columsn are hour and period)
  }

  elasticity_draws <- sample(3:length(Elasticities),simulations,replace = TRUE)
  
  #average elasticty 
  avg_elasticity_possibilities <- seq(from = -0.8, to = -0.04, by = 0.01)
  avg_elasticity_draws <- sample(avg_elasticity_possibilities, simulations, replace = TRUE)
  
  #comm (not set to be a sample, but could be)
  comm_possibilities <- seq(from=0.2, to=1, by=.01)
  comm_draws <-  sample(comm_possibilities,simulations, replace = TRUE)

  #create empty data frame for simulation fcn to populate
  sim_result <- hourly_demand()
  sim_result_EV_Demand <- sim_result$EV_Demand %>% 
    mutate(method_draw = 0, elasticity_draw = 0) %>% 
      mutate(avg_elasticity_draw = 0)
  sim_result_EV_Demand <- sim_result_EV_Demand[0,]


  for(i in seq(simulations)){
    run_i <- hourly_demand(method = method_draws[i],
                       avg_elasticity = avg_elasticity_draws[i],
                       seg = sim_seg,
                       month = sim_month, 
                       year = sim_year,
                       include_wknds = sim_include_wknds,
                       charger_power = sim_charger_power,
                       elasticity_schedule = elasticity_draws[i], 
                       price_change = sim_price_change, 
                       intervention_hours = sim_intervention_hours,
                       intervention_chargers = sim_intervention_chargers,
                       price_change_2 = sim_price_change_2,
                       intervention_hours_2 = sim_intervention_hours_2,
                       int_equals_baseline = sim_int_equals_baseline, 
                       throttle_amount = sim_throttle_amount, 
                       throttle_hours = sim_throttle_hours,
                       air_pollution_comm = sim_air_pollution_comm,
                       price_comm = sim_price_comm,
                       curt_year=sim_curt_year,
                       new_tou=sim_new_tou)

    
    run_i_EV_Demand <- run_i$EV_Demand %>% 
      mutate(method_draw = method_draws[i], elasticity_draw = elasticity_draws[i]) %>% 
      mutate(avg_elasticity_draw = elasticity_draws[i])
  
    sim_result_EV_Demand <- rbind(sim_result_EV_Demand,run_i_EV_Demand)
  
  
  }

      sim_result_summary <- group_by(sim_result_EV_Demand, Hr) %>% 
    summarise_at(vars(Xf, P0, Xi, X0, P1, X1, Xint_effect, Xf, Curt, I01),funs(mean,min,max))
      
      names(sim_result_summary[-1]) <- "NULL" #to avoid a dumb error

  
  return(list(sim_result_EV_Demand = sim_result_EV_Demand, sim_result_summary = sim_result_summary))
}


#sim1 <- simulation()
```


## Graph code template

```{r eval=FALSE}
ggplot(INSERT_SIMULATION_RUN$sim_result_summary) +
      geom_line(aes(x = Hr, y = Xf_mean,color = "Intervention Demand"), 
                size = 2.5, 
                alpha = 0.75) + #This is the Xf line
      
      geom_line(aes(x = Hr,
                    y = X0_mean,
                    color = "Baseline Demand"), 
                size = 2.5, 
                alpha = 0.75) + #This is the X0 line
      ggtitle("INSERT TITLE HERE") +
      xlab("Hour of the Day") +
      ylab("Electricity Demand (kilowatts)") +
      
      geom_rect(aes(xmin= INSERT_DISCOUNT_START_TIME,
                    xmax=INSERT_DISCOUNT_END_TIME,
                    ymin=-Inf,
                    ymax=Inf,
                    fill = "Discount"),
                alpha=0.02) + #this is the discount rectangle REMOVE IF NO DISCOUNT
      
      geom_rect(aes(xmin=INSERT_REBATE_START_TIME,
                    xmax=INSERT_REBATE_END_TIME,
                    ymin=-Inf,
                    ymax=Inf,
                    fill="Rebate"),
                alpha=0.02) + #This is the rebate rectangle REMOVE IF NO REBATE
      
      geom_rect(aes(xmin= INSERT_THROTTLE_START_TIME,
                    xmax=INSERT_THROTTLE_END_TIME,
                    ymin=-Inf,
                    ymax=Inf,
                    fill = "Throttle"),
                alpha=0.02) + #this is the throttle rectangle REMOVE IF NO THROTTLE
      
      scale_x_continuous(limits = c(1,24),breaks = c(1:24), expand = c(0,0)) +
      scale_y_continuous(expand = c(0,0)) +
      scale_fill_brewer("Interventions",palette = "Set2" , guide = guide_legend(override.aes = list(alpha = 0.5))) +
      scale_color_brewer("Demand", palette = "Dark2", direction = -1) +
      #scale_fill_manual('Interventions', values = c("Disount" = 'cadetblue3',"Rebate" = 'thistle3', "Throttle" = 'darksalmon'),  guide = guide_legend(override.aes = list(alpha = 0.5))) +
      theme(legend.position = "bottom") +
      theme_classic()
```







Chunk below takes a LONG TIME to run

```{r simulation_aggregation, eval=FALSE, include=FALSE}


sim_agg <- data.frame(month = rep(1:12, each = 4), segment = rep(c("Workplace", "Multi Unit Dwelling", "Fleet", "Destination Center"),12))

summer_i_h <- c(12:15) #option 1
winter_i_h <- c(17:21) #option 2

sim_agg <- sim_agg %>% 
  mutate(price_change = ifelse(month %in% c(6:9),-0.05,0.1), intervention_hours = (ifelse(month %in% c(6:9), 1, 2)))

sim_annual_aggregated <- data.frame()


for (i in seq(1,48,1)) {
  
  sim_i <- simulation(simulations = 10,
             sim_price_change = sim_agg$price_change[i],
             sim_seg = sim_agg$segment[i],
             sim_intervention_hours = ifelse(sim_agg$intervention_hours[i] == 1, summer_i_h, winter_i_h),
             sim_month = sim_agg$month[i])
  
  
  sim_i_summary <- sim_i$sim_result_EV_Demand %>% 
    mutate(price_change = sim_agg$price_change[i], segmnt = sim_agg$segment[i], int_hrs =  sim_agg$intervention_hours[i], sim_month  = sim_agg$month[i])
  
  sim_annual_aggregated <- rbind(sim_annual_aggregated, sim_i_summary)
  
}


```

EMISSIONS + ALL OUTPUTS


#Emission Fcn
```{r emissions_outputs}

#Load default periods (intervention hour is set above); decide if moving these defaults above; and default year
pk <- c(17:21) #target window to shift out off (this is only used in the output calculations below, not for the function)
yr <- 2018 # only real options are 2030 or 2018. if you pick anything else it defualts to 2018. 

#Insert costs ($/kg)
NOXcost <- 21.93 #$/kg
Curtailmentcost <- 0.15 #$/MWH
CO2cost <-0.05 #$/kg

#emissions_x <- emission_output(run_x$EV_Demand)
# emissions_x<- emission_output(hourly_demand()) 
# Emissionfcn <- function (EV_Demand_run1, peak_hour = pk) {
# add a column to output of hourly demand that specifies intervention hours (binary 1: 0; intervention hours = 1; not = 0); read that in for intervention hour; read in peak hours as another input; then calculate everything else other hour of concern (peak), and other
#}

emissions_fcn <- function(EVDemand, peak_hours = pk, emissions_year = yr) {

#Load emissiosn factors  based on year
   # Elasticity 
  if(emissions_year == 2030) {
    Hourly_EF <- read_csv("Hrly_EF_2030.csv")
  } else{
   Hourly_EF <- read_csv("Hrly_EF_2018.csv")
  }
  
#Create Date Frame for Emissions Outputs
Emissions <- data.frame(Hr = c(1:24)) %>% 
  mutate(CO2Baseline=Hourly_EF$CO2Baseline) %>% 
  mutate(CO2Marginal=Hourly_EF$CO2Marginal_gas) %>% 
  mutate(NOXBaseline=Hourly_EF$NOXBaseline) %>% 
  mutate(NOXMarginal=Hourly_EF$NOXMarginal_gas) %>% #want to change this so it selects the baseline and marginal based on year input and the gas/no gas scenario automatically in the function
  mutate(PercSolar=Hourly_EF$SolarPerc) %>% 
  mutate(I01 = EVDemand$sim_result_summary$I01_mean) %>% 
  mutate(Xi = EVDemand$sim_result_summary$Xi_mean) %>% # column for initial demand at each hour not scaled
  mutate(X0 = EVDemand$sim_result_summary$X0_mean) %>% # column for initial demand at each hour scaled by chargers
  mutate(Xf = EVDemand$sim_result_summary$Xf_mean) %>% 
  mutate(curt = EVDemand$sim_result_summary$Curt_mean) %>% 
  mutate(Xdelta = EVDemand$sim_result_summary$Xint_effect_mean) %>% 
     # column for new demand at each hour. we'll need to update "Xt" to reflect the new column post comms/all interventions
  mutate(Pbase = EVDemand$sim_result_summary$P0_mean*EVDemand$sim_result_summary$X0_mean) %>% #total price paid in that hour ($/kwh * kwh)
  mutate(Pnew = EVDemand$sim_result_summary$P1_mean*EVDemand$sim_result_summary$Xf_mean) #total price paid in that hour ($/kwh * kwh)

Emissions <- Emissions %>% 
  mutate(Xcurtpot = Xdelta*PercSolar) 

Emissions <- Emissions %>% 
  mutate(Xcurt = ifelse(Xcurtpot<curt,ifelse(curt == 0,0,Xcurtpot),curt)) %>% #sum and run percentages on Xcurt 
  mutate(Xextra = ifelse(Xcurtpot>curt, ifelse(Xcurt-Xcurtpot< 0,0, Xcurt-Xcurtpot),0))

#Calculate emissions for baseline demand (scaled and not)
Emissions <- Emissions %>%
  #mutate (CO2Xi = Xi*CO2Baseline) %>% 
  #mutate (NOXXi = Xi*NOXBaseline) %>% 
  mutate (CO2X0 = X0*CO2Baseline) %>% 
  mutate (NOXX0 = X0*NOXBaseline)

#calculate change in emissions
Emissions <- Emissions %>%
  mutate (CO2Xdelta = Xdelta*CO2Marginal) %>% 
  mutate (NOXXdelta= Xdelta*NOXMarginal)

Emissions <- Emissions %>%
  mutate(CO2Xdelta = ifelse(-CO2Xdelta > CO2X0, -CO2X0, CO2Xdelta)) %>% 
mutate (NOXXdelta = ifelse(-NOXXdelta > NOXX0, -NOXX0, NOXXdelta))

#calculate emissions for final
Emissions <- Emissions %>%
  mutate (CO2Xf = CO2X0+CO2Xdelta) %>% # baseline emissions - change for emissions associated with final demand
  mutate (NOXXf = NOXX0+NOXXdelta)

#Set intervention hours, peak hours, other hours based on intervention hours selected for hourly demand fcn and peak hours input above. 
#Find interventions hours
intervention_emission_hours <- which(Emissions[,7] == 1) #pulls intervention hours from initial hourly demand fcn
#Find other hours based on intervention hours set in hourly function and peak hour input
other_emission_hours <- c(1:24) #create 1:24 for all other hours
other_emission_hours <-other_emission_hours[!other_emission_hours %in% intervention_emission_hours] #remove the intervention hours
other_emission_hours <-other_emission_hours[!other_emission_hours %in% peak_hours] #remove the pk hours

## Final summations
# sum baseload by period
 X0_i_h <- sum(Emissions$X0[intervention_emission_hours]) 
 X0_pk <- sum(Emissions$X0[peak_hours]) 
 X0_o_h <- sum(Emissions$X0[other_emission_hours]) 
 X0_sum <- sum(Emissions$X0)
 
# sum final load by period
  Xf_i_h <- sum(Emissions$Xf[intervention_emission_hours]) 
  Xf_pk <- sum(Emissions$Xf[peak_hours]) 
  Xf_o_h <- sum(Emissions$Xf[other_emission_hours]) 
  Xf_sum <- sum(Emissions$Xf)
 
# sum intervention change by period
 Xdelta_i_h <- sum(Emissions$Xdelta[intervention_emission_hours]) 
 Xdelta_pk <- sum(Emissions$Xdelta[peak_hours]) 
 Xdelta_o_h <- sum(Emissions$Xdelta[other_emission_hours]) 
 Xdelta_sum <- sum(Emissions$Xdelta)

# sum baseline cost by period
 P0_i_h <- sum(Emissions$Pbase[intervention_emission_hours]) 
 P0_pk <- sum(Emissions$Pbase[peak_hours]) 
 P0_o_h <- sum(Emissions$Pbase[other_emission_hours]) 
 P0_sum <- sum(Emissions$Pbase)
 
# sum final cost by period
 Pf_i_h <- sum(Emissions$Pnew[intervention_emission_hours]) 
 Pf_pk <- sum(Emissions$Pnew[peak_hours]) 
 Pf_o_h <- sum(Emissions$Pnew[other_emission_hours]) 
 Pf_sum <- sum(Emissions$Pnew)

# sum change in cost by period
 Pdelta_i_h <- Pf_i_h - P0_i_h 
 Pdelta_pk <- Pf_pk - P0_pk
 Pdelta_o_h <- Pf_o_h - P0_o_h
 Pdelta_sum <- Pf_sum - P0_sum
 
#Sum base emissions by period (intervention window, peak window, other)
 CO2X0_i_h <- sum(Emissions$CO2X0[intervention_emission_hours]) 
 CO2X0_pk <- sum(Emissions$CO2X0[peak_hours]) 
 CO2X0_o_h <- sum(Emissions$CO2X0[other_emission_hours]) 
 CO2X0_sum <- sum(Emissions$CO2X0)
 NOXX0_i_h <- sum(Emissions$NOXX0[intervention_emission_hours])
 NOXX0_pk <- sum(Emissions$NOXX0[peak_hours])
 NOXX0_o_h <- sum(Emissions$NOXX0[other_emission_hours]) 
 NOXX0_sum <- sum(Emissions$NOXX0)
 
#Sum final emissions by period (intervention window, peak window, other)
 CO2Xf_i_h <- sum(Emissions$CO2Xf[intervention_emission_hours]) #11-3 window
 CO2Xf_pk <- sum(Emissions$CO2Xf[peak_hours]) #peak 4pm-9pm window
 CO2Xf_o_h <- sum(Emissions$CO2Xf[other_emission_hours]) #all other hours
 CO2Xf_sum <- sum(Emissions$CO2Xf)
 NOXXf_i_h <- sum(Emissions$NOXXf[intervention_emission_hours]) #11-3 window
 NOXXf_pk <- sum(Emissions$NOXXf[peak_hours]) #peak 4pm-9pm window
 NOXXf_o_h <- sum(Emissions$NOXXf[other_emission_hours]) #all other hours
 NOXXf_sum <- sum(Emissions$NOXXf)
 
#Sum change in emissions by period (intervention window, peak window, other)
 CO2Xdelta_i_h <- sum(Emissions$CO2Xdelta[intervention_emission_hours]) #11-3 window
 CO2Xdelta_pk <- sum(Emissions$CO2Xdelta[peak_hours]) #peak 4pm-9pm window
 CO2Xdelta_o_h <- sum(Emissions$CO2Xdelta[other_emission_hours]) #all other hours
 CO2Xdelta_sum <- sum(Emissions$CO2Xdelta)
 NOXXdelta_i_h <- sum(Emissions$NOXXdelta[intervention_emission_hours]) #11-3 window
 NOXXdelta_pk <- sum(Emissions$NOXXdelta[peak_hours]) #peak 4pm-9pm window
 NOXXdelta_o_h <- sum(Emissions$NOXXdelta[other_emission_hours]) #all other hours
 NOXXdelta_sum <- sum(Emissions$NOXXdelta)

#Calculate NOx impacts in DACs vs not (assuming peaker DACs account for 25% of load, even though they account for 70% of plants)
 NOxDACXdelta_i_h <- 0
 NOxDACXdelta_pk <- NOXXdelta_pk*.25 *.70
 NOxDACXdelta_o_h <- 0
 NOxDACXdelta_sum <- NOxDACXdelta_pk
 
 
#Put into new df
Emissions_Table <- data.frame(Time= c("intervention hours", "peak period", "other", "Total"), Xinitial = c(X0_i_h, X0_pk, X0_o_h, X0_sum), Xfinal = c(Xf_i_h, Xf_pk, Xf_o_h, Xf_sum), Xchange = c(Xdelta_i_h, Xdelta_pk, Xdelta_o_h, Xdelta_sum), CustCostInitial = c(P0_i_h, P0_pk, P0_o_h, P0_sum), CustCostFinal = c(Pf_i_h, Pf_pk, Pf_o_h, Pf_sum), CustCostChange = c(Pdelta_i_h, Pdelta_pk, Pdelta_o_h, Pdelta_sum), CO2Initial = c(CO2X0_i_h, CO2X0_pk, CO2X0_o_h, CO2X0_sum), CO2Final = c(CO2Xf_i_h, CO2Xf_pk, CO2Xf_o_h, CO2Xf_sum), CO2Change = c(CO2Xdelta_i_h, CO2Xdelta_pk, CO2Xdelta_o_h, CO2Xdelta_sum), NOXInitial = c(NOXX0_i_h, NOXX0_pk, NOXX0_o_h, NOXX0_sum), NOXFinal = c(NOXXf_i_h, NOXXf_pk, NOXXf_o_h, NOXXf_sum), NOXChange = c(NOXXdelta_i_h, NOXXdelta_pk, NOXXdelta_o_h, NOXXdelta_sum), NOXChangeDAC = c(0, NOxDACXdelta_pk, 0, 0))
#Note: there's got to be a cleaner way to calculate these totals.  

#Calculate cost reduction from NOX reduction (only doing it for the change)
Emissions_Table <- Emissions_Table %>% 
  mutate(NOXChangeCost = NOXChange*NOXcost) %>% #this is in dollars
  mutate(CO2ChangeCost = CO2Change*CO2cost)
 
#Curtailment Cost Reduction
Xcurtpotential <- sum(Emissions$Xcurt)
Xcurtextra <- sum(Emissions$Xextra) 
Xcurtproportion <- Xcurtpotential/sum(Emissions$curt)

Curtailmentcost <- Xcurtpotential*-Curtailmentcost
#add to output table
Emissions_Table <- Emissions_Table %>% 
   mutate(RedCurtProp = c("NA", "NA", "NA", Xcurtproportion), SolarNonCurt= c("NA", "NA", "NA", Xcurtextra), ChangeCurtCost = c("NA", "NA", "NA", Curtailmentcost))

Emissions_Table <- Emissions_Table %>% 
  mutate(PropDemandChange = Xchange/Xinitial) %>% 
  mutate(PropCO2Change = CO2Change/CO2Initial) %>% 
  mutate(PropNOXChange = NOXChange/NOXInitial) %>% 
  mutate(PropCustCostChange = CustCostChange/CustCostInitial)


return(list(Emissions=Emissions, Emissions_Table=Emissions_Table))
}

#Test_emissions <- emissions_fcn(sim1) or Test_emissions <- emissions_fcn(EVDemand = simulation())

#defaults below
#emissions_fcn defaults. peak_hours 17:21 and emissions year 2018. only change if need to make 2030 run. Then: emissions_year = 2030. Always run on the output from your simulation table. see example below with defaults. #PM1_output_table <- emissions_fcn(PM1) to run defaults
#PM1_output_table <- emissions_fcn(EVDemand = PM1, peak_hours = c(17:21), emissions_year = 2019)

```

#emission fcn events
```{r emissions_fcn_event}

#Load default periods (intervention hour is set above); decide if moving these defaults above; and default year
pk <- c(17:21) #target window to shift out off (this is only used in the output calculations below, not for the function)
yr <- 2018 # only real options are 2030 or 2018. if you pick anything else it defualts to 2018. 
i_h_e <- c(12:15)

#Insert costs ($/kg)
NOXcost <- 21.93 #$/kg
Curtailmentcost <- 0.15 #$/kWh
CO2cost <-0.05 #$/kg


#emissions_x <- emission_output(run_x$EV_Demand)
# emissions_x<- emission_output(hourly_demand()) 
# Emissionfcn <- function (EV_Demand_run1, peak_hour = pk) {
# add a column to output of hourly demand that specifies intervention hours (binary 1: 0; intervention hours = 1; not = 0); read that in for intervention hour; read in peak hours as another input; then calculate everything else other hour of concern (peak), and other
#}

emissions_fcn_event <- function(EVDemand, peak_hours = pk, emissions_year = yr, intervention_hours = i_h_e) {

#Load emissiosn factors  based on year
   # Elasticity 
  if(emissions_year == 2030) {
    Hourly_EF <- read_csv("Hrly_EF_2030.csv")
  } else{
   Hourly_EF <- read_csv("Hrly_EF_2018.csv")
  }
  
#Create Date Frame for Emissions Outputs
Emissions <- data.frame(Hr = c(1:24)) %>% 
  mutate(CO2Baseline=Hourly_EF$CO2Baseline) %>% 
  mutate(CO2Marginal=Hourly_EF$CO2Marginal_gas) %>% 
  mutate(NOXBaseline=Hourly_EF$NOXBaseline) %>% 
  mutate(NOXMarginal=Hourly_EF$NOXMarginal_gas) %>% #want to change this so it selects the baseline and marginal based on year input and the gas/no gas scenario automatically in the function
  mutate(PercSolar=Hourly_EF$SolarPerc) %>% 
#  mutate(I01 = EVDemand$I01) %>% 
  mutate(Xi = EVDemand$Xi) %>% # column for initial demand at each hour not scaled
  mutate(X0 = EVDemand$X0) %>% # column for initial demand at each hour scaled by chargers
  mutate(Xf = EVDemand$Event_Usage) %>% 
  mutate(curt = EVDemand$Curt) %>% 
 # mutate(Xdelta = EVDemand$EV_Demand$Xint_effect) %>% 
     # column for new demand at each hour. we'll need to update "Xt" to reflect the new column post comms/all interventions
  mutate(Pbase = EVDemand$P0*EVDemand$X0)  %>% #total price paid in that hour ($/kwh * kwh)
 mutate(Pnew = EVDemand$P1*EVDemand$Event_Usage) #total price paid in that hour ($/kwh * kwh)

Emissions <- Emissions %>% 
  mutate(Xdelta = Xf - X0)

Emissions <- Emissions %>% 
  mutate(Xcurtpot = Xdelta*PercSolar) 

Emissions <- Emissions %>% 
  mutate(Xcurt = ifelse(Xcurtpot<curt,ifelse(curt == 0,0,Xcurtpot),curt)) %>% #sum and run percentages on Xcurt 
  mutate(Xextra = ifelse(Xcurtpot>curt, ifelse(Xcurt-Xcurtpot< 0,0, Xcurt-Xcurtpot),0))

#Calculate emissions for baseline demand (scaled and not)
Emissions <- Emissions %>%
  #mutate (CO2Xi = Xi*CO2Baseline) %>% 
  #mutate (NOXXi = Xi*NOXBaseline) %>% 
  mutate (CO2X0 = X0*CO2Baseline) %>% 
  mutate (NOXX0 = X0*NOXBaseline)

#calculate change in emissions
Emissions <- Emissions %>%
  mutate (CO2Xdelta = Xdelta*CO2Marginal) %>% 
  mutate (NOXXdelta= Xdelta*NOXMarginal)

#calculate emissions for final
Emissions <- Emissions %>%
  mutate (CO2Xf = CO2X0+CO2Xdelta) %>% # baseline emissions - change for emissions associated with final demand
  mutate (NOXXf = NOXX0+NOXXdelta)

#Set intervention hours, peak hours, other hours based on intervention hours selected for hourly demand fcn and peak hours input above. 
#Find interventions hours
intervention_emission_hours <- intervention_hours #pulls intervention hours from parameter intput
#Find other hours based on intervention hours set in hourly function and peak hour input
other_emission_hours <- c(1:24) #create 1:24 for all other hours
other_emission_hours <-other_emission_hours[!other_emission_hours %in% intervention_emission_hours] #remove the intervention hours
other_emission_hours <-other_emission_hours[!other_emission_hours %in% peak_hours] #remove the pk hours

## Final summations
# sum baseload by period
 X0_i_h <- sum(Emissions$X0[intervention_emission_hours]) 
 X0_pk <- sum(Emissions$X0[peak_hours]) 
 X0_o_h <- sum(Emissions$X0[other_emission_hours]) 
 X0_sum <- sum(Emissions$X0)
 
# sum final load by period
  Xf_i_h <- sum(Emissions$Xf[intervention_emission_hours]) 
  Xf_pk <- sum(Emissions$Xf[peak_hours]) 
  Xf_o_h <- sum(Emissions$Xf[other_emission_hours]) 
  Xf_sum <- sum(Emissions$Xf)
 
# sum intervention change by period
 Xdelta_i_h <- sum(Emissions$Xdelta[intervention_emission_hours]) 
 Xdelta_pk <- sum(Emissions$Xdelta[peak_hours]) 
 Xdelta_o_h <- sum(Emissions$Xdelta[other_emission_hours]) 
 Xdelta_sum <- sum(Emissions$Xdelta)

# sum baseline cost by period
 P0_i_h <- sum(Emissions$Pbase[intervention_emission_hours]) 
 P0_pk <- sum(Emissions$Pbase[peak_hours]) 
 P0_o_h <- sum(Emissions$Pbase[other_emission_hours]) 
 P0_sum <- sum(Emissions$Pbase)
 
# sum final cost by period
 Pf_i_h <- sum(Emissions$Pnew[intervention_emission_hours]) 
 Pf_pk <- sum(Emissions$Pnew[peak_hours]) 
 Pf_o_h <- sum(Emissions$Pnew[other_emission_hours]) 
 Pf_sum <- sum(Emissions$Pnew)

# sum change in cost by period
 Pdelta_i_h <- Pf_i_h - P0_i_h 
 Pdelta_pk <- Pf_pk - P0_pk
 Pdelta_o_h <- Pf_o_h - P0_o_h
 Pdelta_sum <- Pf_sum - P0_sum
 
#Sum base emissions by period (intervention window, peak window, other)
 CO2X0_i_h <- sum(Emissions$CO2X0[intervention_emission_hours]) 
 CO2X0_pk <- sum(Emissions$CO2X0[peak_hours]) 
 CO2X0_o_h <- sum(Emissions$CO2X0[other_emission_hours]) 
 CO2X0_sum <- sum(Emissions$CO2X0)
 NOXX0_i_h <- sum(Emissions$NOXX0[intervention_emission_hours])
 NOXX0_pk <- sum(Emissions$NOXX0[peak_hours])
 NOXX0_o_h <- sum(Emissions$NOXX0[other_emission_hours]) 
 NOXX0_sum <- sum(Emissions$NOXX0)
 
#Sum final emissions by period (intervention window, peak window, other)
 CO2Xf_i_h <- sum(Emissions$CO2Xf[intervention_emission_hours]) #11-3 window
 CO2Xf_pk <- sum(Emissions$CO2Xf[peak_hours]) #peak 4pm-9pm window
 CO2Xf_o_h <- sum(Emissions$CO2Xf[other_emission_hours]) #all other hours
 CO2Xf_sum <- sum(Emissions$CO2Xf)
 NOXXf_i_h <- sum(Emissions$NOXXf[intervention_emission_hours]) #11-3 window
 NOXXf_pk <- sum(Emissions$NOXXf[peak_hours]) #peak 4pm-9pm window
 NOXXf_o_h <- sum(Emissions$NOXXf[other_emission_hours]) #all other hours
 NOXXf_sum <- sum(Emissions$NOXXf)
 
#Sum change in emissions by period (intervention window, peak window, other)
 CO2Xdelta_i_h <- sum(Emissions$CO2Xdelta[intervention_emission_hours]) #11-3 window
 CO2Xdelta_pk <- sum(Emissions$CO2Xdelta[peak_hours]) #peak 4pm-9pm window
 CO2Xdelta_o_h <- sum(Emissions$CO2Xdelta[other_emission_hours]) #all other hours
 CO2Xdelta_sum <- sum(Emissions$CO2Xdelta)
 NOXXdelta_i_h <- sum(Emissions$NOXXdelta[intervention_emission_hours]) #11-3 window
 NOXXdelta_pk <- sum(Emissions$NOXXdelta[peak_hours]) #peak 4pm-9pm window
 NOXXdelta_o_h <- sum(Emissions$NOXXdelta[other_emission_hours]) #all other hours
 NOXXdelta_sum <- sum(Emissions$NOXXdelta)

#Calculate NOx impacts in DACs vs not (assuming peaker DACs account for 25% of load, even though they account for 70% of plants)
 NOxDACXdelta_i_h <- 0
 NOxDACXdelta_pk <- NOXXdelta_pk*.25 *.70
 NOxDACXdelta_o_h <- 0
 NOxDACXdelta_sum <- NOxDACXdelta_pk
 
 
#Put into new df
Emissions_Table <- data.frame(Time= c("intervention hours", "peak period (17-21)", "other", "Total"), Xinitial = c(X0_i_h, X0_pk, X0_o_h, X0_sum), Xfinal = c(Xf_i_h, Xf_pk, Xf_o_h, Xf_sum), Xchange = c(Xdelta_i_h, Xdelta_pk, Xdelta_o_h, Xdelta_sum), CustCostInitial = c(P0_i_h, P0_pk, P0_o_h, P0_sum), CustCostFinal = c(Pf_i_h, Pf_pk, Pf_o_h, Pf_sum), CustCostChange = c(Pdelta_i_h, Pdelta_pk, Pdelta_o_h, Pdelta_sum), CO2Initial = c(CO2X0_i_h, CO2X0_pk, CO2X0_o_h, CO2X0_sum), CO2Final = c(CO2Xf_i_h, CO2Xf_pk, CO2Xf_o_h, CO2Xf_sum), CO2Change = c(CO2Xdelta_i_h, CO2Xdelta_pk, CO2Xdelta_o_h, CO2Xdelta_sum), NOXInitial = c(NOXX0_i_h, NOXX0_pk, NOXX0_o_h, NOXX0_sum), NOXFinal = c(NOXXf_i_h, NOXXf_pk, NOXXf_o_h, NOXXf_sum), NOXChange = c(NOXXdelta_i_h, NOXXdelta_pk, NOXXdelta_o_h, NOXXdelta_sum), NOXChangeDAC = c(0, NOxDACXdelta_pk, 0, 0))
#Note: there's got to be a cleaner way to calculate these totals.  

#Calculate cost reduction from NOX reduction (only doing it for the change)
Emissions_Table <- Emissions_Table %>% 
  mutate(NOXChangeCost = NOXChange*NOXcost) %>% #this is in dollars
  mutate(CO2ChangeCost = CO2Change*CO2cost)
 
#Curtailment Cost Reduction
Xcurtpotential <- sum(Emissions$Xcurt) #eek. this 75% is weird and doesn't match the solar fuel mix %. we need another column for solar reduction potential in the fuel mix. 
Xcurtextra <- sum(Emissions$Xextra) 
Xcurtproportion <- Xcurtpotential/sum(Emissions$curt)

Curtailmentcost <- Xcurtpotential*-Curtailmentcost
#add to output table
Emissions_Table <- Emissions_Table %>% 
   mutate(RedCurtProp = c("NA", "NA", "NA", Xcurtproportion), SolarNonCurt= c("NA", "NA", "NA", Xcurtextra), ChangeCurtCost = c("NA", "NA", "NA", Curtailmentcost))

Emissions_Table <- Emissions_Table %>% 
  mutate(PropDemandChange = Xchange/Xinitial) %>% 
  mutate(PropCO2Change = CO2Change/CO2Initial) %>% 
  mutate(PropNOXChange = NOXChange/NOXInitial) %>% 
  mutate(PropCustCostChange = CustCostChange/CustCostInitial)

return(list(Emissions=Emissions, Emissions_Table=Emissions_Table))
}



```




#WORKPLACES 

```{r workplace_scenarios, message=FALSE, warning=FALSE}

#PW1S = discount + price comm + morning throttling
PW1S <- simulation(simulations = 1000, sim_seg = "Workplace",
                       sim_month = 11, 
                       sim_year = 2018,
                       sim_include_wknds = FALSE,
                       sim_charger_power = pwr,
                       sim_price_change = -0.05, 
                       sim_intervention_hours = c(12:15),
                       sim_throttle_amount = -0.5, 
                       sim_throttle_hours = c(7:11),
                       sim_air_pollution_comm = FALSE, #no comm
                       sim_price_comm = TRUE, #yes comm
                       sim_curt_year=2018)

write_csv(PW1S$sim_result_summary, "Results/Workplace_PW1S_Demand_Summary.csv")

#run emissions and write to csv
PW1S_output_table <- emissions_fcn(PW1S) 
write_csv(PW1S_output_table$Emissions_Table, "Results/Workplace_PW1S_Output_Summary.csv") #write emissions to csv
write_csv(PW1S_output_table$Emissions, "Results/Workplace_PW1S_Output_All_Hours.csv")



#PW2S = discount + price comm + morning throttling +2019 TOU
PW2S <- simulation(simulations = 1000, sim_seg = "Workplace",
                       sim_month = 11, 
                       sim_year = 2018,
                       sim_include_wknds = FALSE,
                       sim_charger_power = pwr,
                       sim_price_change = -0.05, 
                       sim_intervention_hours = c(12:15),
                       sim_throttle_amount = -0.5, 
                       sim_throttle_hours = c(7:11),
                       sim_air_pollution_comm = FALSE, #no comm
                       sim_price_comm = TRUE, #yes comm
                       sim_curt_year=2018,
                   sim_new_tou = 2019)

write_csv(PW2S$sim_result_summary, "Results/Workplace_PW2S_Demand_Summary.csv")

#run emissions and write to csv
PW2S_output_table <- emissions_fcn(PW2S) 
write_csv(PW2S_output_table$Emissions_Table, "Results/Workplace_PW2S_Output_Summary.csv") #write emissions to csv
write_csv(PW2S_output_table$Emissions, "Results/Workplace_PW2S_Output_All_Hours.csv")




#PW3S = discount + price comm
PW3S <- simulation(simulations = 1000, sim_seg = "Workplace",
                       sim_month = 11, 
                       sim_year = 2018,
                       sim_include_wknds = FALSE,
                       sim_charger_power = pwr,
                       sim_price_change = -0.05, 
                       sim_intervention_hours = c(12:15),
                       sim_throttle_amount = 0, #No throttling 
                       sim_air_pollution_comm = FALSE, 
                       sim_price_comm = TRUE,
                       sim_curt_year=2018) 
#View(PW3S$sim_result_summary)
write_csv(PW3S$sim_result_summary, "Results/Workplace_PW3S_Demand_Summary.csv")

#run emissions and write to csv
PW3S_output_table <- emissions_fcn(PW3S) 
write_csv(PW3S_output_table$Emissions_Table, "Results/Workplace_PW3S_Output_Summary.csv") #write emissions to csv
write_csv(PW3S_output_table$Emissions, "Results/Workplace_PW3S_Output_All_Hours.csv")







#PW4S = discount + throttling + no comm
PW4S <- simulation(simulations = 1000, sim_seg = "Workplace",
                       sim_month = 11, 
                       sim_year = 2018,
                       sim_include_wknds = FALSE,
                       sim_charger_power = pwr,
                       sim_price_change = -0.05, 
                       sim_intervention_hours = c(12:15),
                       sim_throttle_amount = -0.5, 
                       sim_throttle_hours = c(7:11),
                       sim_air_pollution_comm = FALSE, #no comm
                       sim_price_comm = FALSE, # no comm
                       sim_curt_year=2018) 
write_csv(PW4S$sim_result_summary, "Results/Workplace_PW4S_Demand_Summary.csv")

#run emissions and write to csv
PW4S_output_table <- emissions_fcn(PW4S) 
write_csv(PW4S_output_table$Emissions_Table, "Results/Workplace_PW4S_Output_Summary.csv") #write emissions to csv
write_csv(PW4S_output_table$Emissions, "Results/Workplace_PW4S_Output_All_Hours.csv")



#-------not used in report-------
#PW5S = rebate + throttling + no comm
PW5S <- simulation(simulations = 1000, sim_seg = "Workplace",
                       sim_month = 7, 
                       sim_year = 2018,
                       sim_include_wknds = FALSE,
                       sim_charger_power = pwr,
                       sim_price_change = 0.10, 
                       sim_intervention_hours = c(17:21),
                       sim_throttle_amount = -0.5, 
                       sim_throttle_hours = c(17:21),
                       sim_air_pollution_comm = FALSE, #yes comm
                       sim_price_comm = FALSE, 
                       sim_curt_year=2018) 
#View(PW5S$sim_result_summary)
write_csv(PW5S$sim_result_summary, "Results/Workplace_PW5S_Demand_Summary.csv")

PW5S_output_table <- emissions_fcn(PW5S) 
write_csv(PW5S_output_table$Emissions_Table, "Results/Workplace_PW5S_Output_Summary.csv") #write emissions to csv
write_csv(PW5S_output_table$Emissions, "Results/Workplace_PW5S_Output_All_Hours.csv")



#PW6S = discount + throttling + air poll comm
PW6S <- simulation(simulations = 1000, sim_seg = "Workplace",
                       sim_month = 11, 
                       sim_year = 2018,
                       sim_include_wknds = FALSE,
                       sim_charger_power = pwr,
                       sim_price_change = -0.05, 
                       sim_intervention_hours = c(12:15),
                       sim_throttle_amount = -0.5, 
                       sim_throttle_hours = c(7:11),
                       sim_air_pollution_comm = TRUE, #yes comm
                       sim_price_comm = FALSE, 
                       sim_curt_year=2018) 
#View(PW6S$sim_result_summary)
write_csv(PW6S$sim_result_summary, "Results/Workplace_PW6S_Demand_Summary.csv")

PW6S_output_table <- emissions_fcn(PW6S) 
write_csv(PW6S_output_table$Emissions_Table, "Results/Workplace_PW6S_Output_Summary.csv") #write emissions to csv
write_csv(PW6S_output_table$Emissions, "Results/Workplace_PW6S_Output_All_Hours.csv")


#PW7S = discount + throttling + all comm
PW7S <- simulation(simulations = 1000, sim_seg = "Workplace",
                       sim_month = 11, 
                       sim_year = 2018,
                       sim_include_wknds = FALSE,
                       sim_charger_power = pwr,
                       sim_price_change = -0.05, 
                       sim_intervention_hours = c(12:15),
                       sim_throttle_amount = -0.5, 
                       sim_throttle_hours = c(7:11),
                       sim_air_pollution_comm = TRUE, #yes comm
                       sim_price_comm = TRUE, #yes comm
                       sim_curt_year=2018) 
write_csv(PW7S$sim_result_summary, "Results/Workplace_PW7S_Demand_Summary.csv")

#run emissions and write to csv
PW7S_output_table <- emissions_fcn(PW7S) 
write_csv(PW7S_output_table$Emissions_Table, "Results/Workplace_PW7S_Output_Summary.csv") #write emissions to csv
write_csv(PW7S_output_table$Emissions, "Results/Workplace_PW7S_Output_All_Hours.csv")

#------------------------------------------

#FW1 = discount + throttling + air poll & price comm, TOU19 intervention, 2030 chargers
FW1 <- simulation(simulations = 1000, sim_seg = "Workplace",
                       sim_month = 11, 
                       sim_year = 2018,
                       sim_include_wknds = FALSE,
                       sim_charger_power = pwr,
                       sim_price_change = -0.05, 
                       sim_intervention_hours = c(12:15),
                       sim_throttle_amount = -0.5, 
                       sim_throttle_hours = c(7:11),
                       sim_air_pollution_comm = TRUE, #yes comm
                       sim_price_comm = TRUE, 
                       sim_curt_year=2030,
                       sim_new_tou = 2019,
                       sim_intervention_chargers = 31435, #of chargers, 
                       sim_int_equals_baseline = FALSE) 

#View(FW1$sim_result_summary)
write_csv(FW1$sim_result_summary, "Results/Workplace_FW1_Demand_Summary.csv")

FW1_output_table <- emissions_fcn(FW1) 
write_csv(FW1_output_table$Emissions_Table, "Results/Workplace_FW1_Output_Summary.csv") #write emissions to csv
write_csv(FW1_output_table$Emissions, "Results/Workplace_FW1_Output_All_Hours.csv")

```

```{r workplace_graphs, message=FALSE}

#PW1S
PW1S_demand_summary <- read_csv("Results/Workplace_PW1S_Demand_Summary.csv") 

graph_tablePW1S <- PW1S_demand_summary[c("Hr","X0_mean","Xf_mean")] # %>% 
#  gather(condition,value,c("X0_mean","Xf_mean")) 

hr_24<- graph_tablePW1S[24,]
hr_24[1,1] <- 0
graph_tablePW1S <- rbind(hr_24,graph_tablePW1S)


Demand_GraphPW1S <- ggplot(data = graph_tablePW1S, aes(x = Hr)) +
  geom_line(aes(x = Hr, y = Xf_mean, color = "Intervention Demand"), 
                size = 0.9, 
                alpha = 0.75) + #This is the Xf line
  geom_line(aes(x = Hr,
                y = X0_mean,
                color = "Baseline Demand"),
                size = 0.9, 
                alpha = 0.75) + #This is the X0 line
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +
      xlab("Hour of the Day") +
      ylab("Electricity Demand (kW)") +
  geom_rect(aes(xmin= 11,
                xmax=15,
                ymin=-Inf,
                ymax=Inf,
                fill = "Discount"),
                alpha=0.005) +
  geom_rect(aes(xmin= 6,
                xmax=11,
                ymin=-Inf,
                ymax=Inf,
                fill = "Throttle"),
                alpha=0.005) +
      scale_x_continuous(limits = c(0,24),breaks = c(0:24), expand = c(0,0)) +
      scale_fill_manual('Interventions', values = c("Discount" = 'green',"Throttle" = 'red1', "Rebate" = 'yellow1', "Throttle and Rebate" = "#C7B19C"),  guide = guide_legend(override.aes = list(alpha = 0.1))) +
      theme(legend.position = "bottom") +
      scale_color_manual('Demand', values = c("Baseline Demand" = "red3", "Intervention Demand" ="dodgerblue2"))
     
Demand_GraphPW1S
ggsave("Results Graphs/Workplace_PW1S_Demand_Summary.png", Demand_GraphPW1S, device = "png", width = 8, height = 4.5)


#PW2S 
PW2S_demand_summary <- read_csv("Results/Workplace_PW2S_Demand_Summary.csv") 

graph_tablePW2S <- PW2S_demand_summary[c("Hr","X0_mean","Xf_mean")] #%>% 
  #gather(condition,value,c("X0_mean","Xf_mean")) 
#%>% mutate(Theoretical_Max=PW2S_demand_summary$MT[1])

hr_24<- graph_tablePW2S[24,]
hr_24[1,1] <- 0
graph_tablePW2S <- rbind(hr_24,graph_tablePW2S)

Demand_GraphPW2S <- ggplot(data = graph_tablePW2S, aes(x = Hr)) +
   geom_line(aes(x = Hr, y = Xf_mean, color = "Intervention Demand"), 
                size = 0.9, 
                alpha = 0.75) + #This is the Xf line
  geom_line(aes(x = Hr,
                y = X0_mean,
                color = "Baseline Demand"),
                size = 0.9, 
                alpha = 0.75) + #This is the X0 line
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +
      xlab("Hour of the Day") +
      ylab("Electricity Demand (kW)") +
  geom_rect(aes(xmin= 11,
                xmax=15,
                ymin=-Inf,
                ymax=Inf,
                fill = "Discount"),
                alpha=0.005) +
  geom_rect(aes(xmin= 6,
                xmax=11,
                ymin=-Inf,
                ymax=Inf,
                fill = "Throttle"),
                alpha=0.005) +
      scale_x_continuous(limits = c(0,24),breaks = c(0:24), expand = c(0,0)) +
      scale_fill_manual('Interventions', values = c("Discount" = 'green',"Throttle" = 'red1', "Rebate" = 'yellow1', "Throttle and Rebate" = "#C7B19C"),  guide = guide_legend(override.aes = list(alpha = 0.1))) +
      theme(legend.position = "bottom") +
      scale_color_manual('Demand', values = c("Baseline Demand" = "red3", "Intervention Demand" ="dodgerblue2"))
      


Demand_GraphPW2S
ggsave("Results Graphs/Workplace_PW2S_Demand_Summary.png", Demand_GraphPW2S, device = "png", width = 8, height = 4.5)


#PW3S
PW3S_demand_summary <- read_csv("Results/Workplace_PW3S_Demand_Summary.csv") 

graph_tablePW3S <- PW3S_demand_summary[c("Hr","X0_mean","Xf_mean")] #%>% 
  #gather(condition,value,c("X0_mean","Xf_mean")) 
#%>% mutate(Theoretical_Max=PW3S_demand_summary$MT[1])

hr_24<- graph_tablePW3S[24,]
hr_24[1,1] <- 0
graph_tablePW3S <- rbind(hr_24,graph_tablePW3S)

Demand_GraphPW3S <- ggplot(data = graph_tablePW3S, aes(x = Hr)) +
  geom_line(aes(x = Hr, y = Xf_mean, color = "Intervention Demand"), 
                size = 0.9, 
                alpha = 0.75) + #This is the Xf line
  geom_line(aes(x = Hr,
                y = X0_mean,
                color = "Baseline Demand"),
                size = 0.9, 
                alpha = 0.75) + #This is the X0 line
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +
      xlab("Hour of the Day") +
      ylab("Electricity Demand (kW)") +
  geom_rect(aes(xmin= 11,
                xmax=15,
                ymin=-Inf,
                ymax=Inf,
                fill = "Discount"),
                alpha=0.005) +
      scale_x_continuous(limits = c(0,24),breaks = c(0:24), expand = c(0,0)) +
      scale_fill_manual('Interventions', values = c("Discount" = 'green',"Throttle" = 'red1', "Rebate" = 'yellow1', "Throttle and Rebate" = "#C7B19C"),  guide = guide_legend(override.aes = list(alpha = 0.1))) +
      theme(legend.position = "bottom") +
      scale_color_manual('Demand', values = c("Baseline Demand" = "red3", "Intervention Demand" ="dodgerblue2"))
      
  
Demand_GraphPW3S
ggsave("Results Graphs/Workplace_PW3S_Demand_Summary.png", Demand_GraphPW3S, device = "png", width = 8, height = 4.5)


#PW4
PW4S_demand_summary <- read_csv("Results/Workplace_PW4S_Demand_Summary.csv") 

graph_tablePW4S <- PW4S_demand_summary[c("Hr","X0_mean","Xf_mean")] #%>% 
  #gather(condition,value,c("X0_mean","Xf_mean")) 
#%>% mutate(Theoretical_Max=PW4S_demand_summary$MT[1])
hr_24<- graph_tablePW4S[24,]
hr_24[1,1] <- 0
graph_tablePW4S <- rbind(hr_24,graph_tablePW4S)

Demand_GraphPW4S <- ggplot(data = graph_tablePW4S, aes(x = Hr)) +
    geom_line(aes(x = Hr, y = Xf_mean, color = "Intervention Demand"), 
                  size = 0.9, 
                  alpha = 0.75) + #This is the Xf line
    geom_line(aes(x = Hr,
                  y = X0_mean,
                  color = "Baseline Demand"),
                  size = 0.9, 
                  alpha = 0.75) + #This is the X0 line
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +
      xlab("Hour of the Day") +
      ylab("Electricity Demand (kW)") +
    geom_rect(aes(xmin= 11,
                xmax=15,
                ymin=-Inf,
                ymax=Inf,
                fill = "Discount"),
                alpha=0.005) +
   geom_rect(aes(xmin= 6,
                xmax=11,
                ymin=-Inf,
                ymax=Inf,
                fill = "Throttle"),
                alpha=0.005) +
    scale_x_continuous(limits = c(0,24),breaks = c(0:24), expand = c(0,0)) +
    scale_fill_manual('Interventions', values = c("Discount" = 'green',"Throttle" = 'red1', "Rebate" = 'yellow1', "Throttle and Rebate" = "#C7B19C"),  guide = guide_legend(override.aes = list(alpha = 0.1))) +
    theme(legend.position = "bottom") +
    scale_color_manual('Demand', values = c("Baseline Demand" = "red3", "Intervention Demand" ="dodgerblue2"))

Demand_GraphPW4S
ggsave("Results Graphs/Workplace_PW4S_Demand_Summary.png", Demand_GraphPW4S, device = "png", width = 8, height = 4.5)


###PW5S 
PW5S_demand_summary <- read_csv("Results/Workplace_PW5S_Demand_Summary.csv") 

graph_tablePW5S <- PW5S_demand_summary[c("Hr","X0_mean","Xf_mean")] %>% 
  gather(condition,value,c("X0_mean","Xf_mean")) 
#%>% mutate(Theoretical_Max=PW5S_demand_summary$MT[1])

Demand_GraphPW5S <- ggplot(data = graph_tablePW5S, aes(x = Hr)) +
  geom_line(aes(y = value, color=condition)) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
  panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  labs(title="Workplaces (PW5S) Hourly Demand Forecast\n(discount, no comm, throttling)",
  subtitle="Baseline November 2018 (596 Chargers) \n Model Simulation",
  y="EV Charging Demand (kW)",
  x="Hour",
  color=NULL) +
  geom_rect(aes(xmin=6,xmax=11,ymin=-Inf,ymax=Inf,fill="Throttle"),alpha=0.0075) +
  geom_rect(aes(xmin=11,xmax=15,ymin=-Inf,ymax=Inf, fill = "Discount"),alpha=0.0075) +
  scale_x_continuous(breaks = 1:24, limits = c(1,24), expand = c(0, 0)) +
  scale_color_manual(labels=c("Baseline Demand","Intervention Demand"), values = c("purple", "blue")) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.subtitle = element_text(hjust = 0.5))+
  theme(legend.position="bottom") +
  scale_fill_manual('Interventions',values = c('green','yellow'),  guide = guide_legend(override.aes = list(alpha = 0.15)))
  

#Demand_GraphPW5S
ggsave("Results Graphs/Workplace_PW5S_Demand_Summary.png", Demand_GraphPW5S, device = "png", width = 8, height = 4.5)


#PW6S 
PW6S_demand_summary <- read_csv("Results/Workplace_PW6S_Demand_Summary.csv") 

graph_tablePW6S <- PW6S_demand_summary[c("Hr","X0_mean","Xf_mean")] %>% 
  gather(condition,value,c("X0_mean","Xf_mean")) 
#%>% mutate(Theoretical_Max=PW6S_demand_summary$MT[1])

Demand_GraphPW6S <- ggplot(data = graph_tablePW6S, aes(x = Hr)) +
  geom_line(aes(y = value, color=condition)) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
  panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  labs(title="Workplaces (PW6S) Hourly Demand Forecast\n (discount, air comm, throttling)",
  subtitle="Baseline November 2018 (596 Chargers) \n Model Simulation",
  y="EV Charging Demand (kW)",
  x="Hour",
  color=NULL) +
  geom_rect(aes(xmin=6,xmax=11,ymin=-Inf,ymax=Inf,fill="Throttle"),alpha=0.0075) +
  geom_rect(aes(xmin=11,xmax=15,ymin=-Inf,ymax=Inf, fill = "Discount"),alpha=0.0075) +
  scale_x_continuous(breaks = 1:24, limits = c(1,24), expand = c(0, 0)) +
  scale_color_manual(labels=c("Baseline Demand","Intervention Demand"), values = c("purple", "blue")) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.subtitle = element_text(hjust = 0.5))+
  theme(legend.position="bottom") +
  scale_fill_manual('Interventions',values = c('green','yellow'),  guide = guide_legend(override.aes = list(alpha = 0.15)))
  

#Demand_GraphPW6S
ggsave("Results Graphs/Workplace_PW6S_Demand_Summary.png", Demand_GraphPW6S, device = "png", width = 8, height = 4.5)


#FW1 Graph 
FW1_demand_summary <- read_csv("Results/Workplace_FW1_Demand_Summary.csv") 

graph_tableFW1<- FW1_demand_summary[c("Hr","X0_mean","Xf_mean")] #%>% 
  #gather(condition,value,c("X0_mean","Xf_mean")) 
#%>% mutate(Theoretical_Max=FW1_demand_summary$MT[1])

hr_24<- graph_tableFW1[24,]
hr_24[1,1] <- 0
graph_tableFW1 <- rbind(hr_24,graph_tableFW1)

Demand_GraphFW1 <- ggplot(data = graph_tableFW1, aes(x = Hr)) +
   geom_line(aes(x = Hr, y = Xf_mean, color = "Intervention Demand"), 
                size = 0.9, 
                alpha = 0.75) + #This is the Xf line
  geom_line(aes(x = Hr,
                y = X0_mean,
                color = "Baseline Demand"),
                size = 0.9, 
                alpha = 0.75) + #This is the X0 line
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +
      xlab("Hour of the Day") +
      ylab("Electricity Demand (kW)") +
  geom_rect(aes(xmin= 11,
                xmax=15,
                ymin=-Inf,
                ymax=Inf,
                fill = "Discount"),
                alpha=0.005) +
  geom_rect(aes(xmin= 6,
                  xmax=11,
                  ymin=-Inf,
                  ymax=Inf,
                  fill = "Throttle"),
                alpha=0.005) +
  scale_x_continuous(limits = c(0,24),breaks = c(0:24), expand = c(0,0)) +
      scale_fill_manual('Interventions', values = c("Discount" = 'green',"Throttle" = 'red1', "Rebate" = 'yellow1', "Throttle and Rebate" = "#C7B19C"),  guide = guide_legend(override.aes = list(alpha = 0.1))) +
      theme(legend.position = "bottom") +
      scale_color_manual('Demand', values = c("Baseline Demand" = "red3", "Intervention Demand" ="dodgerblue2"))

Demand_GraphFW1
ggsave("Results Graphs/Workplace_FW1_Demand_Summary.png", Demand_GraphFW1, device = "png", width = 8, height = 4.5)


```



#DESTINATION CENTERS

```{r destination_center_scenarios, message=FALSE, warning=FALSE}

#PDC1S:  discount -0.05 (default) 12-15+ all comms + morning throttling
PDC1S <- simulation(simulations = 1000,
                    sim_seg = "Destination Center",
                    sim_throttle_amount = -0.5,
                    sim_month = 11,
                    sim_year = 2018,
                    sim_price_comm = TRUE,
                    sim_air_pollution_comm = TRUE)
                    

write_csv(PDC1S$sim_result_summary, "Results/Destination_Centers_PDC1S_Demand_Summary.csv")
#run emissions and write to csv
PDC1S_output_table <- emissions_fcn(PDC1S) 
write_csv(PDC1S_output_table$Emissions_Table, "Results/Destination_Centers_PDC1S_Output_Summary.csv") #write emissions to csv
write_csv(PDC1S_output_table$Emissions, "Results/Destination_Centers_PDC1S_Output_All_Hours.csv")

#PDC2S: discount -0.05 (default) 12-15+ no comms + morning throttling
PDC2S <- simulation(simulations = 1000,
                    sim_seg = "Destination Center",
                    sim_throttle_amount = -0.5,
                    sim_month = 11,
                    sim_year = 2018,
                    sim_price_comm = FALSE,
                    sim_air_pollution_comm = FALSE)

write_csv(PDC2S$sim_result_summary, "Results/Destination_Centers_PDC2S_Demand_Summary.csv")

PDC2S_output_table <- emissions_fcn(PDC2S)
write_csv(PDC2S_output_table$Emissions_Table, "Results/Destination_Centers_PDC2S_Output_Summary.csv") #write emissions to csv
write_csv(PDC2S_output_table$Emissions, "Results/Destination_Centers_PDC2S_Output_All_Hours.csv")


#PDC3S: discount -0.05 (default) 12-15+ air poll comms + morning throttling
PDC3S <- simulation(simulations = 1000,
                    sim_seg = "Destination Center",
                    sim_throttle_amount = -0.5,
                    sim_month = 11,
                    sim_year = 2018,
                    sim_price_comm = FALSE,
                    sim_air_pollution_comm = TRUE)

write_csv(PDC3S$sim_result_summary, "Results/Destination_Centers_PDC3S_Demand_Summary.csv")
PDC3S_output_table <- emissions_fcn(PDC3S)
#View(PDC3S_output_table$Emissions_Table)
#View(PDC3S_output_table$Emissions)
write_csv(PDC3S_output_table$Emissions_Table, "Results/Destination_Centers_PDC3S_Output_Summary.csv") #write emissions to csv
write_csv(PDC3S_output_table$Emissions, "Results/Destination_Centers_PDC3S_Output_All_Hours.csv")

#PDC4S:  discount -0.05 (default) 12-15+ price comms only + morning throttling
PDC4S <- simulation(simulation = 1000,
                    sim_seg = "Destination Center",
                    sim_throttle_amount = -0.5,
                    sim_month = 11,
                    sim_year = 2018,
                    sim_price_comm = TRUE,
                    sim_air_pollution_comm = FALSE)

write_csv(PDC4S$sim_result_summary, "Results/Destination_Centers_PDC4S_Demand_Summary.csv")

#run emissions and write to csv
PDC4S_output_table <- emissions_fcn(PDC4S) 
write_csv(PDC4S_output_table$Emissions_Table, "Results/Destination_Centers_PDC4S_Output_Summary.csv") #write emissions to csv
write_csv(PDC4S_output_table$Emissions, "Results/Destination_Centers_PDC4S_Output_All_Hours.csv")


#PDC5S: $0.10 Rebate (17:00  21:00) + no comms + morning throttling
PDC5S <- simulation(simulations = 1000, 
                    sim_seg = "Destination Center",
                    sim_month = 7,
                    sim_year = 2018,
                    sim_throttle_amount = -0.5,
                    sim_throttle_hours = c(17:21),
                    sim_price_change = 0.10,
                    sim_intervention_hours = c(17:21),
                    sim_air_pollution_comm = FALSE,
                    sim_price_comm = FALSE)

write_csv(PDC5S$sim_result_summary, "Results/Destination_Centers_PDC5S_Demand_Summary.csv")
PDC5S_output_table <- emissions_fcn(PDC5S)
#View(PDC5S_output_table$Emissions_Table)
#View(PDC5S_output_table$Emissions)
write_csv(PDC5S_output_table$Emissions_Table, "Results/Destination_Centers_PDC5S_Output_Summary.csv") #write emissions to csv
write_csv(PDC5S_output_table$Emissions, "Results/Destination_Centers_PDC5S_Output_All_Hours.csv")
                    
                    

#FDC1: $0.05 Discount (12:00-15:00) + all comms + morning throttling +TOU19 + 2030 chargers
FDC1 <- simulation(simulations = 1000, 
                    sim_seg = "Destination Center",
                    sim_month = 11,
                    sim_year = 2018,
                    sim_throttle_amount = -0.5,
                    sim_throttle_hours = c(7:11),
                    sim_price_change = -0.05,
                    sim_intervention_hours = c(12:15),
                    sim_air_pollution_comm = TRUE,
                    sim_price_comm = TRUE,
                    sim_new_tou = 2019,
                    sim_intervention_chargers = 4378, #of chargers 
                    sim_int_equals_baseline = FALSE,
                    sim_curt_year=2030)

write_csv(FDC1$sim_result_summary, "Results/Destination_Centers_FDC1_Demand_Summary.csv")
FDC1_output_table <- emissions_fcn(FDC1)
#View(FDC1_output_table$Emissions_Table)
#View(FDC1_output_table$Emissions)
write_csv(FDC1_output_table$Emissions_Table, "Results/Destination_Centers_FDC1_Output_Summary.csv") #write emissions to csv
write_csv(FDC1_output_table$Emissions, "Results/Destination_Centers_FDC1_Output_All_Hours.csv")


```

```{r destination_center_graphs}
#PDC1S
PDC1S_demand_summary <- read_csv("Results/Destination_Centers_PDC1S_Demand_Summary.csv") 

graph_tablePDC1S <- PDC1S_demand_summary[c("Hr","X0_mean","Xf_mean")] #%>% 
  #gather(condition,value,c("X0_mean","Xf_mean")) 
#%>% mutate(Theoretical_Max=PM1_demand_summary$MT[1])

hr_24<- graph_tablePDC1S[24,]
hr_24[1,1] <- 0
graph_tablePDC1S <- rbind(hr_24,graph_tablePDC1S)

Demand_GraphPDC1S <- ggplot(data = graph_tablePDC1S, aes(x = Hr)) +
  geom_line(aes(x = Hr, y = Xf_mean, color = "Intervention Demand"), 
                size = 0.9, 
                alpha = 0.75) + #This is the Xf line
  geom_line(aes(x = Hr,
                y = X0_mean,
                color = "Baseline Demand"),
                size = 0.9, 
                alpha = 0.75) + #This is the X0 line
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +
      xlab("Hour of the Day") +
      ylab("Electricity Demand (kW)") +
  geom_rect(aes(xmin= 11,
                xmax=15,
                ymin=-Inf,
                ymax=Inf,
                fill = "Discount"),
                alpha=0.005) +
  geom_rect(aes(xmin= 6,
                xmax=11,
                ymin=-Inf,
                ymax=Inf,
                fill = "Throttle"),
                alpha=0.005) +
      scale_x_continuous(limits = c(0,24),breaks = c(0:24), expand = c(0,0)) +
      scale_fill_manual('Interventions', values = c("Discount" = 'green',"Throttle" = 'red1', "Rebate" = 'yellow1', "Throttle and Rebate" = "#C7B19C"),  guide = guide_legend(override.aes = list(alpha = 0.1))) +
      theme(legend.position = "bottom") +
      scale_color_manual('Demand', values = c("Baseline Demand" = "red3", "Intervention Demand" ="dodgerblue2"))
  

Demand_GraphPDC1S
ggsave("Results Graphs/Destination_Centers_PDC1S_Demand_Summary.png", Demand_GraphPDC1S, device = "png", width = 8, height = 4.5)


#PDC2S
PDC2S_demand_summary <- read_csv("Results/Destination_Centers_PDC2S_Demand_Summary.csv") 

graph_tablePDC2S <- PDC2S_demand_summary[c("Hr","X0_mean","Xf_mean")] #%>% 
  #gather(condition,value,c("X0_mean","Xf_mean")) 
#%>% mutate(Theoretical_Max=PM1_demand_summary$MT[1])

hr_24<- graph_tablePDC2S[24,]
hr_24[1,1] <- 0
graph_tablePDC2S <- rbind(hr_24,graph_tablePDC2S)

Demand_GraphPDC2S <- ggplot(data = graph_tablePDC2S, aes(x = Hr)) +
  geom_line(aes(x = Hr, y = Xf_mean, color = "Intervention Demand"), 
                size = 0.9, 
                alpha = 0.75) + #This is the Xf line
    geom_line(aes(x = Hr,
                    y = X0_mean,
                    color = "Baseline Demand"),
               size = 0.9, 
                alpha = 0.75) + #This is the X0 line
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +
      xlab("Hour of the Day") +
      ylab("Electricity Demand (kW)") +
    geom_rect(aes(xmin= 11,
                  xmax=15,
                  ymin=-Inf,
                  ymax=Inf,
                  fill = "Discount"),
                alpha=0.005) + #this is the discount rectangle REMOVE IF NO DISCOUNT
  geom_rect(aes(xmin= 6,
                  xmax=11,
                  ymin=-Inf,
                  ymax=Inf,
                  fill = "Throttle"),
                alpha=0.005) + #this is the throttle rectangle REMOVE IF NO THROTTLING
      scale_x_continuous(limits = c(0,24),breaks = c(0:24), expand = c(0,0)) +
      scale_fill_manual('Interventions', values = c("Discount" = 'green',"Throttle" = 'red1', "Rebate" = 'yellow1', "Throttle and Rebate" = "#C7B19C"),  guide = guide_legend(override.aes = list(alpha = 0.1))) +
      theme(legend.position = "bottom") +
      scale_color_manual('Demand', values = c("Baseline Demand" = "red3", "Intervention Demand" ="dodgerblue2"))

Demand_GraphPDC2S
ggsave("Results Graphs/Destination_Centers_PDC2S_Demand_Summary.png", Demand_GraphPDC2S, device = "png", width = 8, height = 4.5)


#PDC3S
PDC3S_demand_summary <- read_csv("Results/Destination_Centers_PDC3S_Demand_Summary.csv") 

graph_tablePDC3S <- PDC3S_demand_summary[c("Hr","X0_mean","Xf_mean")] %>% 
  gather(condition,value,c("X0_mean","Xf_mean")) 
#%>% mutate(Theoretical_Max=PM1_demand_summary$MT[1])

Demand_GraphPDC3S <- ggplot(data = graph_tablePDC3S, aes(x = Hr)) +
  geom_line(aes(y = value, color=condition)) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
  panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  labs(title="Destination Centers SC.3 (discount+air poll comms+throttling 6-11) Hourly Demand Forecast",
  subtitle="November 2018 (234 Chargers) Model Simulation",
  y="EV Charging Demand (kW)",
  x="Hour",
  color=NULL) +
  geom_rect(aes(xmin=6,xmax=11,ymin=-Inf,ymax=Inf,fill="Throttle"),alpha=0.0075) +
  geom_rect(aes(xmin=11,xmax=15,ymin=-Inf,ymax=Inf, fill = "Discount"),alpha=0.0075) +
  scale_x_continuous(breaks = 1:24, limits = c(1,24), expand = c(0, 0)) +
  scale_color_manual(labels=c("Baseline Demand","Intervention Demand"), values = c("purple", "blue")) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.subtitle = element_text(hjust = 0.5))+
  theme(legend.position="bottom") +
  scale_fill_manual('Interventions',values = c('green','yellow'),  guide = guide_legend(override.aes = list(alpha = 0.15)))
  

#Demand_GraphPDC3S
ggsave("Results Graphs/Destination_Centers_PDC3S_Demand_Summary.png", Demand_GraphPDC3S, device = "png", width = 8, height = 4.5)


#PDC4S
PDC4S_demand_summary <- read_csv("Results/Destination_Centers_PDC4S_Demand_Summary.csv") 

graph_tablePDC4S <- PDC4S_demand_summary[c("Hr","X0_mean","Xf_mean")] %>% 
  gather(condition,value,c("X0_mean","Xf_mean")) 
#%>% mutate(Theoretical_Max=PM1_demand_summary$MT[1])

Demand_GraphPDC4S <- ggplot(data = graph_tablePDC4S, aes(x = Hr)) +
  geom_line(aes(y = value, color=condition)) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
  panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  labs(title="Destination Centers SC.4 (discount+no comms+throttling 6-11) Hourly Demand Forecast",
  subtitle="November 2018 (234 Chargers) Model Simulation",
  y="EV Charging Demand (kW)",
  x="Hour",
  color=NULL) +
  geom_rect(aes(xmin=6,xmax=11,ymin=-Inf,ymax=Inf,fill="Throttle"),alpha=0.0075) +
  geom_rect(aes(xmin=11,xmax=15,ymin=-Inf,ymax=Inf, fill = "Discount"),alpha=0.0075) +
  scale_x_continuous(breaks = 1:24, limits = c(1,24), expand = c(0, 0)) +
  scale_color_manual(labels=c("Baseline Demand","Intervention Demand"), values = c("purple", "blue")) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.subtitle = element_text(hjust = 0.5))+
  theme(legend.position="bottom") +
  scale_fill_manual('Interventions',values = c('green','yellow'),  guide = guide_legend(override.aes = list(alpha = 0.15)))
  

#Demand_GraphPDC4S
ggsave("Results Graphs/Destination_Centers_PDC4S_Demand_Summary.png", Demand_GraphPDC4S, device = "png", width = 8, height = 4.5)


#PDC5S
PDC5S_demand_summary <- read_csv("Results/Destination_Centers_PDC5S_Demand_Summary.csv") 

graph_tablePDC5S <- PDC5S_demand_summary[c("Hr","X0_mean","Xf_mean")] %>% 
  gather(condition,value,c("X0_mean","Xf_mean")) 
#%>% mutate(Theoretical_Max=PM1_demand_summary$MT[1])

Demand_GraphPDC5S <- ggplot(data = graph_tablePDC5S, aes(x = Hr)) +
  geom_line(aes(y = value, color=condition)) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
  panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  labs(title="Destination Centers SC.5 (Rebate+no comms+throttling 17-21) Hourly Demand Forecast",
  subtitle="July 2018 (234 Chargers) Model Simulation",
  y="EV Charging Demand (kW)",
  x="Hour",
  color=NULL) +
  geom_rect(aes(xmin=17,xmax=21,ymin=-Inf,ymax=Inf,fill="Throttle"),alpha=0.0075) +
  geom_rect(aes(xmin=17,xmax=21,ymin=-Inf,ymax=Inf, fill = "Rebate"),alpha=0.0075) +
  scale_x_continuous(breaks = 1:24, limits = c(1,24), expand = c(0, 0)) +
  scale_color_manual(labels=c("Baseline Demand","Intervention Demand"), values = c("purple", "blue")) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.subtitle = element_text(hjust = 0.5))+
  theme(legend.position="bottom") +
  scale_fill_manual('Interventions',values = c('green','yellow'),  guide = guide_legend(override.aes = list(alpha = 0.15)))


#Demand_GraphPDC5S
ggsave("Results Graphs/Destination_Centers_PDC5S_Demand_Summary.png", Demand_GraphPDC5S, device = "png", width = 8, height = 4.5)


#FDC1
FDC1_demand_summary <- read_csv("Results/Destination_Centers_FDC1_Demand_Summary.csv") 

graph_tableFDC1 <- FDC1_demand_summary[c("Hr","X0_mean","Xf_mean")] #%>% 
  #gather(condition,value,c("X0_mean","Xf_mean")) 
#%>% mutate(Theoretical_Max=PM1_demand_summary$MT[1])

hr_24<- graph_tableFDC1[24,]
hr_24[1,1] <- 0
graph_tableFDC1 <- rbind(hr_24,graph_tableFDC1)

Demand_GraphFDC1 <- ggplot(data = graph_tableFDC1, aes(x = Hr)) +
   geom_line(aes(x = Hr, y = Xf_mean, color = "Intervention Demand"), 
                size = 0.9, 
                alpha = 0.75) + #This is the Xf line
    geom_line(aes(x = Hr,
                    y = X0_mean,
                    color = "Baseline Demand"),
               size = 0.9, 
                alpha = 0.75) + #This is the X0 line
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +
      xlab("Hour of the Day") +
      ylab("Electricity Demand (kW)") +
    geom_rect(aes(xmin= 11,
                  xmax=15,
                  ymin=-Inf,
                  ymax=Inf,
                  fill = "Discount"),
                alpha=0.005) + #this is the discount rectangle REMOVE IF NO DISCOUNT
  geom_rect(aes(xmin= 6,
                xmax=11,
                ymin=-Inf,
                ymax=Inf,
                fill = "Throttle"),
                alpha=0.005) +
      scale_x_continuous(limits = c(0,24),breaks = c(0:24), expand = c(0,0)) +
      scale_fill_manual('Interventions', values = c("Discount" = 'green',"Throttle" = 'red1', "Rebate" = 'yellow1', "Throttle and Rebate" = "#C7B19C"),  guide = guide_legend(override.aes = list(alpha = 0.1))) +
      theme(legend.position = "bottom") +
      scale_color_manual('Demand', values = c("Baseline Demand" = "red3", "Intervention Demand" ="dodgerblue2"))


Demand_GraphFDC1
ggsave("Results Graphs/Destination_Centers_FDC1_Demand_Summary.png", Demand_GraphFDC1, device = "png", width = 8, height = 4.5)

```



#FLEETS

```{r fleet_scenarios, message=FALSE, warning=FALSE}

# PF1: Present, Fleet, 1
# $0.10 Rebate (17:00  21:00); 100% Price Communication

PF1 <- simulation(simulations = 1000, 
                       sim_method = mthd,
                       sim_avg_elasticity = avg_elst,
                       sim_seg = "Fleet",
                       sim_month = 7, 
                       sim_year = 2018,
                       sim_include_wknds = FALSE,
                       sim_charger_power = pwr,
                       sim_elasticity_schedule = sch, 
                       sim_price_change = 0.10, 
                       sim_intervention_hours = c(17:21),
                       sim_intervention_chargers = int_ch, 
                       sim_int_equals_baseline = int_e_b, 
                       sim_throttle_amount = t_a, 
                       sim_throttle_hours = t_h,
                       sim_air_pollution_comm = a_p_co,
                       sim_price_comm = TRUE)

write_csv(PF1$sim_result_summary, "Results/Fleets_PF1_Demand_Summary.csv")

#run emissions and write to csv
PF1_output_table <- emissions_fcn(PF1) 
write_csv(PF1_output_table$Emissions_Table, "Results/Fleets_PF1_Output_Summary.csv") #write emissions to csv
write_csv(PF1_output_table$Emissions, "Results/Fleets_PF1_Output_All_Hours.csv")


# PF2: Present, Fleet, 2
# $0.10 Rebate (17:00  21:00); New 2019 TOU Rate; 100% Price Communication

PF2 <- simulation(simulations = 1000, 
                       sim_method = mthd,
                       sim_avg_elasticity = avg_elst,
                       sim_seg = "Fleet",
                       sim_month = 7, 
                       sim_year = 2018,
                       sim_include_wknds = FALSE,
                       sim_charger_power = pwr,
                       sim_elasticity_schedule = sch, 
                       sim_price_change = 0.10, 
                       sim_intervention_hours = c(17:21),
                       sim_intervention_chargers = int_ch, 
                       sim_int_equals_baseline = int_e_b, 
                       sim_throttle_amount = t_a, 
                       sim_throttle_hours = t_h,
                       sim_air_pollution_comm = a_p_co,
                       sim_price_comm = TRUE,
                       sim_curt_year=c_yr,
                       sim_new_tou = 2019)


write_csv(PF2$sim_result_summary, "Results/Fleets_PF2_Demand_Summary.csv")

#run emissions and write to csv
PF2_output_table <- emissions_fcn(PF2) 
write_csv(PF2_output_table$Emissions_Table, "Results/Fleets_PF2_Output_Summary.csv") #write emissions to csv
write_csv(PF2_output_table$Emissions, "Results/Fleets_PF2_Output_All_Hours.csv")


# PF3S: Present, Fleet, 3, Summer
# $0.05 Discount (12:00  15:00); 100% Price Communication

PF3S <- simulation(simulations = 1000, 
                       sim_method = mthd,
                       sim_avg_elasticity = avg_elst,
                       sim_seg = "Fleet",
                       sim_month = 11, 
                       sim_year = 2018,
                       sim_include_wknds = FALSE,
                       sim_charger_power = pwr,
                       sim_elasticity_schedule = sch, 
                       sim_price_change = -0.05, 
                       sim_intervention_hours = c(12:15),
                       sim_intervention_chargers = int_ch, 
                       sim_int_equals_baseline = int_e_b, 
                       sim_throttle_amount = t_a, 
                       sim_throttle_hours = t_h,
                       sim_air_pollution_comm = a_p_co,
                       sim_price_comm = TRUE,
                       sim_curt_year=c_yr)

write_csv(PF3S$sim_result_summary, "Results/Fleets_PF3S_Demand_Summary.csv")

#run emissions and write to csv
PF3S_output_table <- emissions_fcn(PF3S) 
write_csv(PF3S_output_table$Emissions_Table, "Results/Fleets_PF3S_Output_Summary.csv") #write emissions to csv
write_csv(PF3S_output_table$Emissions, "Results/Fleets_PF3S_Output_All_Hours.csv")


# PF4S: Present, Fleet, 4, Summer
# $0.05 Discount (12:00  15:00); 100% Price Communication; 50% Throttling from 7:11 and 17:21

PF4S <- simulation(simulations = 1000, 
                       sim_method = mthd,
                       sim_avg_elasticity = avg_elst,
                       sim_seg = "Fleet",
                       sim_month = 11, 
                       sim_year = 2018,
                       sim_include_wknds = FALSE,
                       sim_charger_power = pwr,
                       sim_elasticity_schedule = sch, 
                       sim_price_change = -0.05, 
                       sim_intervention_hours = c(12:15),
                       sim_intervention_chargers = int_ch, 
                       sim_int_equals_baseline = int_e_b, 
                       sim_throttle_amount = -0.5, 
                       sim_throttle_hours = c(7:11, 17:21),
                       sim_air_pollution_comm = a_p_co,
                       sim_price_comm = TRUE,
                       sim_curt_year=c_yr)

write_csv(PF4S$sim_result_summary, "Results/Fleets_PF4S_Demand_Summary.csv")

#run emissions and write to csv
PF4S_output_table <- emissions_fcn(PF4S) 
write_csv(PF4S_output_table$Emissions_Table, "Results/Fleets_PF4S_Output_Summary.csv") #write emissions to csv
write_csv(PF4S_output_table$Emissions, "Results/Fleets_PF4S_Output_All_Hours.csv")


# PF5S: Present, Fleet, 5, Summer
# $0.05 Discount (12:00  15:00); Rebate: $0.10 (17:00  21:00); 2019 New Summer TOU rate; 100% Price Communication


PF5S <- simulation(simulations = 1000, 
                       sim_method = mthd,
                       sim_avg_elasticity = avg_elst,
                       sim_seg = "Fleet",
                       sim_month = 11, 
                       sim_year = 2018,
                       sim_include_wknds = FALSE,
                       sim_charger_power = pwr,
                       sim_elasticity_schedule = sch, 
                       sim_price_change = -0.05,
                       sim_intervention_hours = c(12:15),
                       sim_intervention_chargers = int_ch,
                       sim_price_change_2 = 0.10,
                       sim_intervention_hours_2 = c(17:21),
                       sim_int_equals_baseline = int_e_b, 
                       sim_throttle_amount = t_a, 
                       sim_throttle_hours = t_h,
                       sim_air_pollution_comm = a_p_co,
                       sim_price_comm = TRUE,
                       sim_curt_year=c_yr,
                       sim_new_tou = 2019)

write_csv(PF5S$sim_result_summary, "Results/Fleets_PF5S_Demand_Summary.csv")

#run emissions and write to csv
PF5S_output_table <- emissions_fcn(PF5S) 
write_csv(PF5S_output_table$Emissions_Table, "Results/Fleets_PF5S_Output_Summary.csv") #write emissions to csv
write_csv(PF5S_output_table$Emissions, "Results/Fleets_PF5S_Output_All_Hours.csv")


# FF1: Future, Fleet, 1 (rebate)
# $0.10 Rebate (17:00  21:00); 4,378 Chargers; New 2019 TOU Rate;
FF1 <- simulation(simulations = 1000, 
                       sim_method = mthd,
                       sim_avg_elasticity = avg_elst,
                       sim_seg = "Fleet",
                       sim_month = 7, 
                       sim_year = yr,
                       sim_include_wknds = wknds,
                       sim_charger_power = pwr,
                       sim_elasticity_schedule = sch, 
                       sim_price_change = 0.1,
                       sim_intervention_hours = c(17:21),
                       sim_intervention_chargers = 4378,
                       sim_int_equals_baseline = FALSE, 
                       sim_throttle_amount = t_a, 
                       sim_throttle_hours = t_h,
                       sim_air_pollution_comm = a_p_co,
                       sim_price_comm = TRUE,
                       sim_curt_year=c_yr,
                       sim_new_tou = 2019)

write_csv(FF1$sim_result_summary, "Results/Fleets_FF1_Demand_Summary.csv")

#run emissions and write to csv
FF1_output_table <- emissions_fcn(FF1, emissions_year = 2030) 
write_csv(FF1_output_table$Emissions_Table, "Results/Fleets_FF1_Output_Summary.csv") #write emissions to csv
write_csv(FF1_output_table$Emissions, "Results/Fleets_FF1_Output_All_Hours.csv")


```


```{r fleet_graphs}

# PF1
PF1_demand_summary <- read_csv("Results/Fleets_PF1_Demand_Summary.csv") 

graph_tablePF1 <- PF1_demand_summary[c("Hr","X0_mean","Xf_mean")] #%>% 
  #gather(condition,value,c("X0_mean","Xf_mean")) 
#%>% mutate(Theoretical_Max=PW1S_demand_summary$MT[1])

hr_24<- graph_tablePF1[24,]
hr_24[1,1] <- 0
graph_tablePF1 <- rbind(hr_24,graph_tablePF1)

Demand_GraphPF1 <- ggplot(data = graph_tablePF1, aes(x = Hr)) +
  geom_line(aes(x = Hr, y = Xf_mean, color = "Intervention Demand"), 
                size = 0.9, 
                alpha = 0.75) + #This is the Xf line
  geom_line(aes(x = Hr,
                y = X0_mean,
                color = "Baseline Demand"),
                size = 0.9, 
                alpha = 0.75) + #This is the X0 line
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +
      xlab("Hour of the Day") +
      ylab("Electricity Demand (kW)") +
  geom_rect(aes(xmin= 16,
                xmax=21,
                ymin=-Inf,
                ymax=Inf,
                fill = "Rebate"),
                alpha=0.005) +
      scale_x_continuous(limits = c(0,24),breaks = c(0:24), expand = c(0,0)) +
      scale_fill_manual('Interventions', values = c("Discount" = 'green',"Throttle" = 'red1', "Rebate" = 'yellow1', "Throttle and Rebate" = "#C7B19C"),  guide = guide_legend(override.aes = list(alpha = 0.1))) +
      theme(legend.position = "bottom") +
      scale_color_manual('Demand', values = c("Baseline Demand" = "red3", "Intervention Demand" ="dodgerblue2"))
  
  
Demand_GraphPF1
ggsave("Results Graphs/Fleets_PF1_Demand_Summary.png", Demand_GraphPF1, device = "png", width = 8, height = 4.5)


# PF2
PF2_demand_summary <- read_csv("Results/Fleets_PF2_Demand_Summary.csv") 

graph_tablePF2 <- PF2_demand_summary[c("Hr","X0_mean","Xf_mean")] #%>% 
  #gather(condition,value,c("X0_mean","Xf_mean")) 
#%>% mutate(Theoretical_Max=PW1S_demand_summary$MT[1])

hr_24<- graph_tablePF2[24,]
hr_24[1,1] <- 0
graph_tablePF2 <- rbind(hr_24,graph_tablePF2)

Demand_GraphPF2 <- ggplot(data = graph_tablePF2, aes(x = Hr)) +
  geom_line(aes(x = Hr, y = Xf_mean, 
                color = "Intervention Demand"), 
                size = 0.9, 
                alpha = 0.75) + #This is the Xf line
  geom_line(aes(x = Hr,
                y = X0_mean,
                color = "Baseline Demand"),
                size = 0.9, 
                alpha = 0.75) + #This is the X0 line
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +
      xlab("Hour of the Day") +
      ylab("Electricity Demand (kW)") +
  geom_rect(aes(xmin= 16,
                xmax=21,
                ymin=-Inf,
                ymax=Inf,
                fill = "Rebate"),
                alpha=0.005) +
      scale_x_continuous(limits = c(0,24),breaks = c(0:24), expand = c(0,0)) +
      scale_fill_manual('Interventions', values = c("Discount" = 'green',"Throttle" = 'red1', "Rebate" = 'yellow1', "Throttle and Rebate" = "#C7B19C"),  guide = guide_legend(override.aes = list(alpha = 0.1))) +
      theme(legend.position = "bottom") +
      scale_color_manual('Demand', values = c("Baseline Demand" = "red3", "Intervention Demand" ="dodgerblue2"))
  
Demand_GraphPF2
ggsave("Results Graphs/Fleets_PF2_Demand_Summary.png", Demand_GraphPF2, device = "png", width = 8, height = 4.5)


# PF3S
PF3S_demand_summary <- read_csv("Results/Fleets_PF3S_Demand_Summary.csv") 

graph_tablePF3S <- PF3S_demand_summary[c("Hr","X0_mean","Xf_mean")] %>% 
  gather(condition,value,c("X0_mean","Xf_mean")) 
#%>% mutate(Theoretical_Max=PW1S_demand_summary$MT[1])

Demand_GraphPF3S <- ggplot(data = graph_tablePF3S, aes(x = Hr)) +
  geom_line(aes(y = value, color=condition)) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
  panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  labs(title="Fleets (PF3) (discount, price comm) Hourly Demand Forecast",
  subtitle="Baseline November 2018 (83 Chargers) \n Model Simulation",
  y="EV Charging Demand (kW)",
  x="Hour",
  color=NULL) +
 # geom_rect(aes(xmin=6,xmax=11,ymin=-Inf,ymax=Inf,fill="Throttle"),alpha=0.0075) +
  geom_rect(aes(xmin=11,xmax=15,ymin=-Inf,ymax=Inf, fill = "Discount"),alpha=0.0075) +
  scale_x_continuous(breaks = 1:24, limits = c(1,24), expand = c(0, 0)) +
  scale_color_manual(labels=c("Baseline Demand","Intervention Demand"), values = c("purple", "blue")) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.subtitle = element_text(hjust = 0.5))+
  theme(legend.position="bottom") +
  scale_fill_manual('Interventions',values = c('green','yellow'),  guide = guide_legend(override.aes = list(alpha = 0.15)))
  
#Demand_GraphPF3S
ggsave("Results Graphs/Fleets_PF3S_Demand_Summary.png", Demand_GraphPF3S, device = "png", width = 8, height = 4.5)


# PF4S
PF4S_demand_summary <- read_csv("Results/Fleets_PF4S_Demand_Summary.csv") 

graph_tablePF4S <- PF4S_demand_summary[c("Hr","X0_mean","Xf_mean")] %>% 
  gather(condition,value,c("X0_mean","Xf_mean")) 
#%>% mutate(Theoretical_Max=PW1S_demand_summary$MT[1])

Demand_GraphPF4S <- ggplot(data = graph_tablePF4S, aes(x = Hr)) +
  geom_line(aes(y = value, color=condition)) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
  panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  labs(title="Fleets (PF4S) (discount (11:00-15:00), price comm, throttling(06:00  11:00 and 18:00-21:00)) Hourly Demand Forecast",
  subtitle="Baseline November 2018 (83 Chargers) \n Model Simulation",
  y="EV Charging Demand (kW)",
  x="Hour",
  color=NULL) +
  geom_rect(aes(xmin=6,xmax=11,ymin=-Inf,ymax=Inf,fill="Throttle"),alpha=0.0075) +
  geom_rect(aes(xmin=11,xmax=15,ymin=-Inf,ymax=Inf, fill = "Discount"),alpha=0.0075) +
  geom_rect(aes(xmin=18,xmax=21,ymin=-Inf,ymax=Inf,fill="Throttle"),alpha=0.0075) +
  scale_x_continuous(breaks = 1:24, limits = c(1,24), expand = c(0, 0)) +
  scale_color_manual(labels=c("Baseline Demand","Intervention Demand"), values = c("purple", "blue")) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.subtitle = element_text(hjust = 0.5))+
  theme(legend.position="bottom") +
  scale_fill_manual('Interventions',values = c('green','yellow'),  guide = guide_legend(override.aes = list(alpha = 0.15)))

#Demand_GraphPF4S
ggsave("Results Graphs/Fleets_PF4S_Demand_Summary.png", Demand_GraphPF4S, device = "png", width = 8, height = 4.5)


# PF5S
PF5S_demand_summary <- read_csv("Results/Fleets_PF5S_Demand_Summary.csv") 

graph_tablePF5S <- PF5S_demand_summary[c("Hr","X0_mean","Xf_mean")] %>% 
  gather(condition,value,c("X0_mean","Xf_mean")) 
#%>% mutate(Theoretical_Max=PW1S_demand_summary$MT[1])

Demand_GraphPF5S <- ggplot(data = graph_tablePF5S, aes(x = Hr)) +
  geom_line(aes(y = value, color=condition)) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
  panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  labs(title="Fleets (PF5S) (discount (11:00-15:00), price comm, rebate (17:00-21:00), 2019 TOU Rate) Hourly Demand Forecast",
  subtitle="Baseline November 2018 (83 Chargers) \n Model Simulation",
  y="EV Charging Demand (kW)",
  x="Hour",
  color=NULL) +
  # geom_rect(aes(xmin=6,xmax=11,ymin=-Inf,ymax=Inf,fill="Throttle"),alpha=0.0075) +
  geom_rect(aes(xmin=11,xmax=15,ymin=-Inf,ymax=Inf, fill = "Discount"),alpha=0.0075) +
  geom_rect(aes(xmin=16,xmax=21,ymin=-Inf,ymax=Inf, fill = "Rebate"),alpha=0.0075) +
  scale_x_continuous(breaks = 1:24, limits = c(1,24), expand = c(0, 0)) +
  scale_color_manual(labels=c("Baseline Demand","Intervention Demand"), values = c("purple", "blue")) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.subtitle = element_text(hjust = 0.5))+
  theme(legend.position="bottom") +
  scale_fill_manual('Interventions',values = c('green','yellow'),  guide = guide_legend(override.aes = list(alpha = 0.15)))

#Demand_GraphPF5S
ggsave("Results Graphs/Fleets_PF5S_Demand_Summary.png", Demand_GraphPF5S, device = "png", width = 8, height = 4.5)


# FF1
FF1_demand_summary <- read_csv("Results/Fleets_FF1_Demand_Summary.csv") 

graph_tableFF1 <- FF1_demand_summary[c("Hr","X0_mean","Xf_mean")] #%>% 
  #gather(condition,value,c("X0_mean","Xf_mean")) 
#%>% mutate(Theoretical_Max=PW1S_demand_summary$MT[1])

hr_24<- graph_tableFF1[24,]
hr_24[1,1] <- 0
graph_tableFF1 <- rbind(hr_24,graph_tableFF1)

Demand_GraphFF1 <- ggplot(data = graph_tableFF1, aes(x = Hr)) +
  geom_line(aes(x = Hr, 
                y = Xf_mean, 
                color = "Intervention Demand"), 
                size = 0.9, 
                alpha = 0.75) + #This is the Xf line
  geom_line(aes(x = Hr,
                y = X0_mean,
                color = "Baseline Demand"),
                size = 0.9, 
                alpha = 0.75) + #This is the X0 line
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +
      xlab("Hour of the Day") +
      ylab("Electricity Demand (kW)") +
  geom_rect(aes(xmin= 16,
                xmax=21,
                ymin=-Inf,
                ymax=Inf,
                fill = "Rebate"),
                alpha=0.005) +
  scale_x_continuous(limits = c(0,24),breaks = c(0:24), expand = c(0,0)) +
      scale_fill_manual('Interventions', values = c("Discount" = 'green',"Throttle" = 'red1', "Rebate" = 'yellow1', "Throttle and Rebate" = "#C7B19C"),  guide = guide_legend(override.aes = list(alpha = 0.1))) +
      theme(legend.position = "bottom") +
      scale_color_manual('Demand', values = c("Baseline Demand" = "red3", "Intervention Demand" ="dodgerblue2"))


Demand_GraphFF1
ggsave("Results Graphs/Fleets_FF1_Demand_Summary.png", Demand_GraphFF1, device = "png", width = 8, height = 4.5)

```



#MUDS

```{r MUDs_scenarios, message=FALSE, warning=FALSE}

#PM1 = rebate + price communication
PM1 <- simulation(simulation = 1000, sim_seg = "Multi Unit Dwelling",
                       sim_month = 7,
                       sim_year = 2018,
                       sim_include_wknds = FALSE,
                       sim_price_change = 0.1, 
                       sim_intervention_hours = c(17:21),
                       sim_air_pollution_comm = FALSE,
                       sim_price_comm = TRUE,
                       sim_curt_year=2018) 
#View(PM1$sim_result_summary)

#CSV + OUTPUTS
#write simulation summary results to csv to use for graph!
write_csv(PM1$sim_result_summary, "Results/MUDs_PM1_Demand_Summary.csv")

#run emissions and write to csv
PM1_output_table <- emissions_fcn(PM1) 
#View(PM1_output_table$Emissions_Table)
#View(PM1_output_table$Emissions)
write_csv(PM1_output_table$Emissions_Table, "Results/MUDs_PM1_Output_Summary.csv") #write emissions to csv
write_csv(PM1_output_table$Emissions, "Results/MUDs_PM1_Output_All_Hours.csv")

#to run defaults
#PM1_output_table <- emissions_fcn(EVDemand = PM1, peak_hours = c(17:21), emissions_year = 2019)
#things to CSV: summary table from montecarlo (for graphing); sim_result_summary$summary; PM1_output_table (emissions$Emissions_Table); PM1_output_emissions_all (Emissions$Emissions); 

#PM2 = new tou + rebate + price communication
PM2 <- simulation (simulation = 1000, sim_seg = "Multi Unit Dwelling",
                       sim_month = 7,
                       sim_year = 2018,
                       sim_include_wknds = FALSE,
                       sim_price_change = 0.1, 
                       sim_intervention_hours = c(17:21),
                       sim_air_pollution_comm = FALSE,
                       sim_price_comm = TRUE,
                       sim_curt_year=2018,
                       sim_new_tou = 2019)
write_csv(PM2$sim_result_summary, "Results/MUDs_PM2_Demand_Summary.csv")
PM2_demand_summary <- read_csv("Results/MUDs_PM2_Demand_Summary.csv") #read it back in for the graph

PM2_output_table <- emissions_fcn(PM2) 
write_csv(PM2_output_table$Emissions_Table, "Results/MUDs_PM2_Output_Summary.csv") #write emissions to csv
write_csv(PM2_output_table$Emissions, "Results/MUDs_PM2_Output_All_Hours.csv")


#PM3 = throttling + price comms (can't run throttling with no comms b/c comms is contingent on a price change). so this is a little weird. 
PM3 <- simulation(simulation =1000, sim_seg = "Multi Unit Dwelling",
                       sim_month = 11,
                       sim_year = 2018,
                       sim_include_wknds = FALSE,
                       sim_price_change = 0,
                       sim_intervention_hours = c(17:21), #set so calculates values based on that period
                       sim_throttle_amount = -0.5, 
                       sim_throttle_hours = c(17:21),
                       sim_air_pollution_comm = FALSE,
                       sim_price_comm = TRUE,
                       sim_curt_year=2018)

#write simulation summary results to csv to use for graph!
write_csv(PM3$sim_result_summary, "Results/MUDs_PM2_Demand_Summary.csv")

#run emissions and write to csv
PM3_output_table <- emissions_fcn(PM3) 
write_csv(PM3_output_table$Emissions_Table, "Results/MUDs_PM3_Output_Summary.csv") #write emissions to csv
write_csv(PM3_output_table$Emissions, "Results/MUDs_PM3_Output_All_Hours.csv")

#PM4 = new tou + all communication
PM4 <- simulation (simulation = 1000, sim_seg = "Multi Unit Dwelling",
                       sim_month = 11,
                       sim_year = 2018,
                       sim_include_wknds = FALSE,
                       sim_price_change = 0,
                       sim_intervention_hours = c(1:24),
                       sim_air_pollution_comm = TRUE,
                       sim_price_comm = TRUE,
                       sim_curt_year=2018,
                       sim_new_tou = 2019)
#View(PM4$sim_result_summary)
#write simulation summary results to csv to use for graph!
write_csv(PM4$sim_result_summary, "Results/MUDs_PM4_Demand_Summary.csv")
PM4_demand_summary <- read_csv("Results/MUDs_PM2_Demand_Summary.csv") #read it back in for the graph

#run emissions and write to csv
PM4_output_table <- emissions_fcn(PM4) 
#View(PM4_output_table$Emissions_Table)
#View(PM4_output_table$Emissions)
write_csv(PM4_output_table$Emissions_Table, "Results/MUDs_PM4_Output_Summary.csv") #write emissions to csv
write_csv(PM4_output_table$Emissions, "Results/MUDs_PM4_Output_All_Hours.csv")



#PM 5 = new tou + air pollution communication
PM5 <- simulation (simulation = 1000, sim_seg = "Multi Unit Dwelling",
                       sim_month = 11,
                       sim_year = 2018,
                       sim_include_wknds = FALSE,
                       sim_price_change = 0,
                       sim_intervention_hours = c(1:24),
                       sim_air_pollution_comm = TRUE,
                       sim_price_comm = FALSE,
                       sim_curt_year=2018,
                       sim_new_tou = 2019)
#View(PM5$sim_result_summary)
#write simulation summary results to csv to use for graph!
write_csv(PM5$sim_result_summary, "Results/MUDs_PM5_Demand_Summary.csv")

#run emissions and write to csv
PM5_output_table <- emissions_fcn(PM5) 
#View(PM5_output_table$Emissions_Table)
#View(PM5_output_table$Emissions)
write_csv(PM5_output_table$Emissions_Table, "Results/MUDs_PM5_Output_Summary.csv") #write emissions to csv
write_csv(PM5_output_table$Emissions, "Results/MUDs_PM5_Output_All_Hours.csv")

#add scenario for air pollution + discount? 

#FM1 = 2030 + 2019 tou + rebate
FM1 <- simulation (simulation = 1000, sim_seg = "Multi Unit Dwelling",
                       sim_month = 7,
                       sim_year = 2018,
                       sim_include_wknds = FALSE,
                       sim_price_change = 0.1, 
                       sim_intervention_hours = c(17:21),
                       sim_intervention_chargers = 1846, 
                       sim_int_equals_baseline = FALSE, 
                       sim_air_pollution_comm = TRUE,
                       sim_price_comm = TRUE,
                       sim_curt_year=2030,
                       sim_new_tou = 2019)
#View(FM1$sim_result_summary)

#write simulation summary results to csv to use for graph!
write_csv(FM1$sim_result_summary, "Results/MUDs_FM1_Demand_Summary.csv")

#run emissions and write to csv
FM1_output_table <- emissions_fcn(EVDemand=FM1, emissions_year = 2030) 
#View(FM1_output_table$Emissions_Table)
#View(FM1_output_table$Emissions)
write_csv(FM1_output_table$Emissions_Table, "Results/MUDs_FM1_Output_Summary.csv") #write emissions to csv
write_csv(FM1_output_table$Emissions, "Results/MUDs_FM1_Output_All_Hours.csv")

```

```{r MUDs_graphs}

#PM1 = rebate + price communication + no throttling
PM1_demand_summary <- read_csv("Results/MUDs_PM1_Demand_Summary.csv") 

graph_tablePM1 <- PM1_demand_summary[c("Hr","X0_mean","Xf_mean")] #%>% 
  #gather(condition,value,c("X0_mean","Xf_mean")) 
#%>% mutate(Theoretical_Max=PM1_demand_summary$MT[1])

hr_24<- graph_tablePM1[24,]
hr_24[1,1] <- 0
graph_tablePM1 <- rbind(hr_24,graph_tablePM1)

Demand_GraphPM1 <- ggplot(data = graph_tablePM1, aes(x = Hr)) +
  geom_line(aes(x = Hr, 
                  y = Xf_mean, 
                  color = "Intervention Demand"), 
                  size = 0.9, 
                  alpha = 0.75) + #This is the Xf line
  geom_line(aes(x = Hr,
                  y = X0_mean,
                  color = "Baseline Demand"),
                  size = 0.9, 
                  alpha = 0.75) + #This is the X0 line
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +
      xlab("Hour of the Day") +
      ylab("Electricity Demand (kW)") +
  geom_rect(aes(xmin = 16,
                xmax = 21,
                ymin = -Inf,
                ymax = Inf,
                fill = "Rebate"),alpha = 0.005) +
      scale_x_continuous(limits = c(0,24),breaks = c(0:24), expand = c(0,0)) +
      scale_fill_manual('Interventions', values = c("Discount" = 'green',"Throttle" = 'red1', "Rebate" = 'yellow1', "Throttle and Rebate" = "#C7B19C"),  guide = guide_legend(override.aes = list(alpha = 0.1))) +
      theme(legend.position = "bottom") +
      scale_color_manual('Demand', values = c("Baseline Demand" = "red3", "Intervention Demand" ="dodgerblue2"))
  

Demand_GraphPM1
ggsave("Results Graphs/MUDs_PM1_Demand_Summary.png", Demand_GraphPM1, device = "png", width = 8, height = 4.5)


#PM2
PM2_demand_summary <- read_csv("Results/MUDs_PM2_Demand_Summary.csv")

graph_tablePM2 <- PM2_demand_summary[c("Hr","X0_mean","Xf_mean")] #%>% 
  #gather(condition,value,c("X0_mean","Xf_mean")) 
#%>% mutate(Theoretical_Max=PM1_demand_summary$MT[1])

hr_24<- graph_tablePM2[24,]
hr_24[1,1] <- 0
graph_tablePM2 <- rbind(hr_24,graph_tablePM2)

Demand_GraphPM2 <- ggplot(data = graph_tablePM2, aes(x = Hr)) +
  geom_line(aes(x = Hr, 
                  y = Xf_mean, 
                  color = "Intervention Demand"), 
                  size = 0.9, alpha = 0.75) + #This is the Xf line
  geom_line(aes(x = Hr,
                y = X0_mean,
                color = "Baseline Demand"),
                size = 0.9, alpha = 0.75) + #This is the X0 line
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +
      xlab("Hour of the Day") +
      ylab("Electricity Demand (kW)") +
  geom_rect(aes(xmin = 16,
                xmax = 21,
                ymin = -Inf,
                ymax = Inf,
                fill = "Rebate"),alpha = 0.005) +
   scale_x_continuous(limits = c(0,24),breaks = c(0:24), expand = c(0,0)) +
      scale_fill_manual('Interventions', values = c("Discount" = 'green',"Throttle" = 'red1', "Rebate" = 'yellow1', "Throttle and Rebate" = "#C7B19C"),  guide = guide_legend(override.aes = list(alpha = 0.1))) +
      theme(legend.position = "bottom") +
      scale_color_manual('Demand', values = c("Baseline Demand" = "red3", "Intervention Demand" ="dodgerblue2"))

Demand_GraphPM2
ggsave("Results Graphs/MUDs_PM2_Demand_Summary.png", Demand_GraphPM2, device = "png", width = 8, height = 4.5)


#PM3
PM3_demand_summary <- read_csv("Results/MUDs_PM3_Demand_Summary.csv") 

graph_tablePM3 <- PM3_demand_summary[c("Hr","X0_mean","Xf_mean")] %>% 
  gather(condition,value,c("X0_mean","Xf_mean")) 
#%>% mutate(Theoretical_Max=PM1_demand_summary$MT[1])

Demand_GraphPM3 <- ggplot(data = graph_tablePM3, aes(x = Hr)) +
  geom_line(aes(y = value, color=condition)) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
  panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  labs(title="MUDs (PM3) (new tou, rebate, price comm) Hourly Demand Forecast",
  subtitle="Baseline November 2018 (X Chargers) \n Model Simulation",
  y="EV Charging Demand (kW)",
  x="Hour",
  color=NULL) +
  #geom_rect(aes(xmin=16,xmax=21,ymin=-Inf,ymax=Inf,fill="Throttle"),alpha=0.0075) +
  geom_rect(aes(xmin=16,xmax=21,ymin=-Inf,ymax=Inf, fill = "Rebate"),alpha=0.0075) +
  scale_x_continuous(breaks = 1:24, limits = c(1,24), expand = c(0, 0)) +
  scale_color_manual(labels=c("Baseline Demand","Intervention Demand"), values = c("purple", "blue")) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.subtitle = element_text(hjust = 0.5))+
  theme(legend.position="bottom") +
  scale_fill_manual('Interventions',values = c('green','yellow'),  guide = guide_legend(override.aes = list(alpha = 0.15)))

#Demand_GraphPM3
ggsave("Results Graphs/MUDs_PM3_Demand_Summary.png", Demand_GraphPM3, device = "png", width = 8, height = 4.5)




#PM4
PM4_demand_summary <- read_csv("Results/MUDs_PM4_Demand_Summary.csv") 

graph_tablePM4 <- PM4_demand_summary[c("Hr","X0_mean","Xf_mean")] %>% 
  gather(condition,value,c("X0_mean","Xf_mean")) 
#%>% mutate(Theoretical_Max=PM1_demand_summary$MT[1])

Demand_GraphPM4 <- ggplot(data = graph_tablePM4, aes(x = Hr)) +
  geom_line(aes(y = value, color=condition)) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
  panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  labs(title="MUDs (PM4) (new tou, all comms) Hourly Demand Forecast",
  subtitle="Baseline November 2018 (X Chargers) \n Model Simulation",
  y="EV Charging Demand (kW)",
  x="Hour",
  color=NULL) +
  #geom_rect(aes(xmin=16,xmax=21,ymin=-Inf,ymax=Inf,fill="Throttle"),alpha=0.0075) +
  #geom_rect(aes(xmin=16,xmax=21,ymin=-Inf,ymax=Inf, fill = "Rebate"),alpha=0.0075) +
  scale_x_continuous(breaks = 1:24, limits = c(1,24), expand = c(0, 0)) +
  scale_color_manual(labels=c("Baseline Demand","Intervention Demand"), values = c("purple", "blue")) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.subtitle = element_text(hjust = 0.5))+
  theme(legend.position="bottom") # +
  #scale_fill_manual('Interventions',values = c('green','yellow'),  guide = guide_legend(override.aes = list(alpha = 0.15)))

#Demand_GraphPM4
ggsave("Results Graphs/MUDs_PM4_Demand_Summary.png", Demand_GraphPM4, device = "png", width = 8, height = 4.5)




#PM 5 
PM5_demand_summary <- read_csv("Results/MUDs_PM5_Demand_Summary.csv") 

graph_tablePM5 <- PM5_demand_summary[c("Hr","X0_mean","Xf_mean")] %>% 
  gather(condition,value,c("X0_mean","Xf_mean")) 
#%>% mutate(Theoretical_Max=PM1_demand_summary$MT[1])

Demand_GraphPM5 <- ggplot(data = graph_tablePM5, aes(x = Hr)) +
  geom_line(aes(y = value, color=condition)) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
  panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  labs(title="MUDs (PM5) (new tou, air poll comms) Hourly Demand Forecast",
  subtitle="Baseline November 2018 (X Chargers) \n Model Simulation",
  y="EV Charging Demand (kW)",
  x="Hour",
  color=NULL) +
  #geom_rect(aes(xmin=16,xmax=21,ymin=-Inf,ymax=Inf,fill="Throttle"),alpha=0.0075) +
  #geom_rect(aes(xmin=16,xmax=21,ymin=-Inf,ymax=Inf, fill = "Rebate"),alpha=0.0075) +
  scale_x_continuous(breaks = 1:24, limits = c(1,24), expand = c(0, 0)) +
  scale_color_manual(labels=c("Baseline Demand","Intervention Demand"), values = c("purple", "blue")) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.subtitle = element_text(hjust = 0.5))+
  theme(legend.position="bottom") # +
  #scale_fill_manual('Interventions',values = c('green','yellow'),  guide = guide_legend(override.aes = list(alpha = 0.15)))

#Demand_GraphPM5
ggsave("Results Graphs/MUDs_PM5_Demand_Summary.png", Demand_GraphPM5, device = "png", width = 8, height = 4.5)



#FM1 = 2030 + 2019 tou + rebate
FM1_demand_summary <- read_csv("Results/MUDs_FM1_Demand_Summary.csv") 

graph_tableFM1 <- FM1_demand_summary[c("Hr","X0_mean","Xf_mean")] #%>% 
  #gather(condition,value,c("X0_mean","Xf_mean")) 
#%>% mutate(Theoretical_Max=PM1_demand_summary$MT[1])

hr_24<- graph_tableFM1[24,]
hr_24[1,1] <- 0
graph_tableFM1 <- rbind(hr_24,graph_tableFM1)

Demand_GraphFM1 <- ggplot(data = graph_tableFM1, aes(x = Hr)) +
  geom_line(aes(x = Hr, 
                  y = Xf_mean, 
                  color = "Intervention Demand"), 
                  size = 0.9, 
                  alpha = 0.75) + #This is the Xf line
  geom_line(aes(x = Hr,
                y = X0_mean,
                color = "Baseline Demand"),
                size = 0.9, 
                alpha = 0.75) + #This is the X0 line
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +
      xlab("Hour of the Day") +
      ylab("Electricity Demand (kW)") +
  geom_rect(aes(xmin = 16,
                xmax = 21,
                ymin = -Inf,
                ymax = Inf,
                fill = "Rebate"),alpha = 0.005) +
  scale_x_continuous(limits = c(0,24),breaks = c(0:24), expand = c(0,0)) +
      scale_fill_manual('Interventions', values = c("Discount" = 'green',"Throttle" = 'red1', "Rebate" = 'yellow1', "Throttle and Rebate" = "#C7B19C"),  guide = guide_legend(override.aes = list(alpha = 0.1))) +
      theme(legend.position = "bottom") +
      scale_color_manual('Demand', values = c("Baseline Demand" = "red3", "Intervention Demand" ="dodgerblue2"))
  

Demand_GraphFM1
ggsave("Results Graphs/MUDs_FM1_Demand_Summary.png", Demand_GraphFM1, device = "png", width = 8, height = 4.5)


```



## Report Elasticity + Methods Graphs (for examples)
```{r example_graphs, message=FALSE, warning=FALSE}
#One run of each method for the same scenario (Default for all: Workplace, November, 2018, no weekends, 5 cent discount 12:15, baseline # chargers, no throttling, no air pollution communication, no price communication, 2018 tou) -- want a graphed output of baseline versus intervention for each 

#Method 1
Method1_test <- hourly_demand(method = 1, include_wknds = FALSE, price_comm = FALSE, elasticity_schedule = 7)
Method1_test_for_graph <- Method1_test$EV_Demand

hr_24<- Method1_test_for_graph[24,]
hr_24[1,1] <- 0
Method1_test_for_graph <- rbind(hr_24,Method1_test_for_graph)

Method1_example_graph <- ggplot(Method1_test_for_graph) +
  geom_line(aes(x = Hr, 
                y = Xf, 
                color = "Intervention Demand"), 
                size = 0.9, 
                alpha = 0.75) + #This is the Xf line
  geom_line(aes(x = Hr,
                y = X0,
                color = "Baseline Demand"),
                size = 0.9, 
                alpha = 0.75) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +
      xlab("Hour of the Day") +
      ylab("Electricity Demand (kW)") +
  geom_rect(aes(xmin = 11,
                xmax = 15,
                ymin = -Inf,
                ymax = Inf,
                fill = "Discount"),alpha = 0.005) +
  scale_x_continuous(limits = c(0,24),breaks = c(0:24), expand = c(0,0)) +
      scale_fill_manual('Interventions', values = c("Discount" = 'green',"Throttle" = 'red1', "Rebate" = 'yellow1', "Throttle and Rebate" = "#C7B19C"),  guide = guide_legend(override.aes = list(alpha = 0.1))) +
      theme(legend.position = "bottom") +
      scale_color_manual('Demand', values = c("Baseline Demand" = "red3", "Intervention Demand" ="dodgerblue2"))


#Method 2
Method2_test <- hourly_demand(method = 2, include_wknds = FALSE, price_comm = FALSE, elasticity_schedule = 7)
Method2_test_for_graph <- Method2_test$EV_Demand

hr_24<- Method2_test_for_graph[24,]
hr_24[1,1] <- 0
Method2_test_for_graph <- rbind(hr_24,Method2_test_for_graph)

Method2_example_graph <- ggplot(Method2_test_for_graph) +
  geom_line(aes(x = Hr, 
                y = Xf, 
                color = "Intervention Demand"), 
                size = 0.9, 
                alpha = 0.75) + #This is the Xf line
  geom_line(aes(x = Hr,
                y = X0,
                color = "Baseline Demand"),
                size = 0.9, 
                alpha = 0.75) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +
      xlab("Hour of the Day") +
      ylab("Electricity Demand (kW)") +
  geom_rect(aes(xmin = 11,
                xmax = 15,
                ymin = -Inf,
                ymax = Inf,
                fill = "Discount"),alpha = 0.005) +
  scale_x_continuous(limits = c(0,24),breaks = c(0:24), expand = c(0,0)) +
      scale_fill_manual('Interventions', values = c("Discount" = 'green',"Throttle" = 'red1', "Rebate" = 'yellow1', "Throttle and Rebate" = "#C7B19C"),  guide = guide_legend(override.aes = list(alpha = 0.1))) +
      theme(legend.position = "bottom") +
      scale_color_manual('Demand', values = c("Baseline Demand" = "red3", "Intervention Demand" ="dodgerblue2"))


#Method 3 (default run - average elasticity = -0.4)
Method3_test <- hourly_demand(method = 3, include_wknds = FALSE, price_comm = FALSE, elasticity_schedule = 7)
write_csv(Method3_test$EV_Demand, "Results/Method3_test.csv")
Method3_test_for_graph <- Method3_test$EV_Demand

hr_24<- Method3_test_for_graph[24,]
hr_24[1,1] <- 0
Method3_test_for_graph <- rbind(hr_24,Method3_test_for_graph)

Method3_example_graph <- ggplot(Method3_test_for_graph) +
      geom_line(aes(x = Hr, 
                y = Xf, 
                color = "Intervention Demand"), 
                size = 0.9, 
                alpha = 0.75) + #This is the Xf line
  geom_line(aes(x = Hr,
                y = X0,
                color = "Baseline Demand"),
                size = 0.9, 
                alpha = 0.75) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +
      xlab("Hour of the Day") +
      ylab("Electricity Demand (kW)") +
  geom_rect(aes(xmin = 11,
                xmax = 15,
                ymin = -Inf,
                ymax = Inf,
                fill = "Discount"),alpha = 0.005) +
  scale_x_continuous(limits = c(0,24),breaks = c(0:24), expand = c(0,0)) +
      scale_fill_manual('Interventions', values = c("Discount" = 'green',"Throttle" = 'red1', "Rebate" = 'yellow1', "Throttle and Rebate" = "#C7B19C"),  guide = guide_legend(override.aes = list(alpha = 0.1))) +
      theme(legend.position = "bottom") +
      scale_color_manual('Demand', values = c("Baseline Demand" = "red3", "Intervention Demand" ="dodgerblue2"))


#Method4
Method4_test <- hourly_demand(method = 4, include_wknds = FALSE, price_comm = FALSE, elasticity_schedule = 7) #selecting winter weekday ev medium as example elasticity set this is the old method 1
Method4_test_for_graph <- Method4_test$EV_Demand
Method4_example_graph <- ggplot(Method4_test_for_graph) +
      geom_line(aes(x = Hr, y = Xf,color = "Intervention Demand"), 
                size = 2.5, 
                alpha = 0.75) + #This is the Xf line
      
      geom_line(aes(x = Hr,
                    y = X0,
                    color = "Baseline Demand"), 
                size = 2.5, 
                alpha = 0.75) + #This is the X0 line
      ggtitle("Method 4") +
      xlab("Hour of the Day") +
      ylab("Electricity Demand (kilowatts)") +
      
      geom_rect(aes(xmin= 11,
                    xmax=15,
                    ymin=-Inf,
                    ymax=Inf,
                    fill = "Discount"),
                alpha=0.02) + #this is the discount rectangle REMOVE IF NO DISCOUNT
      scale_x_continuous(limits = c(1,24),breaks = c(1:24), expand = c(0,0)) +
      scale_y_continuous(expand = c(0,0)) +
      scale_fill_brewer("Interventions",palette = "Set2" , guide = guide_legend(override.aes = list(alpha = 0.5))) +
      scale_color_brewer("Demand", palette = "Dark2", direction = -1) +
      #scale_fill_manual('Interventions', values = c("Disount" = 'cadetblue3',"Rebate" = 'thistle3', "Throttle" = 'darksalmon'),  guide = guide_legend(override.aes = list(alpha = 0.5))) +
      theme(legend.position = "bottom") +
      theme_classic()
# spline_example <- Method1_test$matrix[12] #turn this into a line graph. 
#one 24 x 24 hour matrix from one set of SDGE elasticities with cross (I need to know which set) -- want this heat mapped
#heat_map_matrix<-Method4_test$matrix #turn this into a heat map
#One run of the simulation for the same scenario above -- want a graphed output (same as what the result simulation graph looks like for all of them)


Sim_test_report <- simulation(simulations = 1000, sim_include_wknds = FALSE, sim_price_comm = FALSE)
Sim_test_for_graph <- Sim_test_report$sim_result_summary

hr_24<- Sim_test_for_graph[24,]
hr_24[1,1] <- 0
Sim_test_for_graph <- rbind(hr_24,Sim_test_for_graph)


sim_example_graph <- ggplot(Sim_test_for_graph) +
      geom_line(aes(x = Hr, 
                y = Xf_mean, 
                color = "Intervention Demand"), 
                size = 0.9, 
                alpha = 0.75) + #This is the Xf line
  geom_line(aes(x = Hr,
                y = X0_mean,
                color = "Baseline Demand"),
                size = 0.9, 
                alpha = 0.75) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +
      xlab("Hour of the Day") +
      ylab("Electricity Demand (kW)") +
  geom_rect(aes(xmin = 11,
                xmax = 15,
                ymin = -Inf,
                ymax = Inf,
                fill = "Discount"),alpha = 0.005) +
  scale_x_continuous(limits = c(0,24),breaks = c(0:24), expand = c(0,0)) +
      scale_fill_manual('Interventions', values = c("Discount" = 'green',"Throttle" = 'red1', "Rebate" = 'yellow1', "Throttle and Rebate" = "#C7B19C"),  guide = guide_legend(override.aes = list(alpha = 0.1))) +
      theme(legend.position = "bottom") +
      scale_color_manual('Demand', values = c("Baseline Demand" = "red3", "Intervention Demand" ="dodgerblue2"))

### Run/view and save graphs here

Method1_example_graph
ggsave("Results Graphs/Method1_example_graph.png", Method1_example_graph, device = "png", width = 8, height = 4.5)

Method2_example_graph
ggsave("Results Graphs/Method2_example_graph.png", Method2_example_graph, device = "png", width = 8, height = 4.5)

Method3_example_graph
ggsave("Results Graphs/Method3_example_graph.png", Method3_example_graph, device = "png", width = 8, height = 4.5)

Method4_example_graph
ggsave("Results Graphs/Method4_example_graph.png", Method4_example_graph, device = "png", width = 8, height = 4.5)

sim_example_graph
ggsave("Results Graphs/sim_example_graph.png", sim_example_graph, device = "png", width = 8, height = 4.5)

```



~~~~~~~PILOT EVENTS~~~~~~~~~~~


#Scenario 13- Nov 14, 2018 EVENT + Baseline (scaled for 546 chargers) 

Event: Workplace, November 14, 2018, TOU EV-4, $0.05 Discount (11AM-3PM)

```{r Scenario 13}

#Scaled Baseline and Nov 14 event usage

#CHARGERS
Nov_14_18_WP_event <- Event_Chargers %>%
filter(Market_Segment=="Workplace") %>%
select(Nov_14_18_LS) %>%
unlist()


Nov_14_18_WP_scaled_baseline <- hourly_demand(
  intervention_hours = c(12:15),
                    month = 11,
                    year= 2018,
                    seg =  "Workplace",
                    intervention_chargers =
                    Nov_14_18_WP_event,
                    int_equals_baseline = FALSE,
                    include_wknds = FALSE)



Nov_14_18_WP_Event_Usage <- filter(event_data, Date == "2018-11-14" & segment == "Workplace") %>%
select(Demand) %>%
unlist() 

Nov_14_18_WP_scaled_baseline$EV_Demand <- Nov_14_18_WP_scaled_baseline$EV_Demand %>%
  mutate(Event_Usage = Nov_14_18_WP_Event_Usage)


graph_table13 <- Nov_14_18_WP_scaled_baseline$EV_Demand[c("Hr","X0","Event_Usage")] #%>%
  #gather(condition,value,c("X0","Event_Usage")) %>%
  #mutate(Theoretical_Max=Nov_14_18_WP_scaled_baseline$EV_Demand$MT[1])


Demand_Graph13 <- ggplot(data = graph_table13, aes(x = Hr)) +
  geom_line(aes(x = Hr, 
                  y = Event_Usage, 
                  color = "Event Demand"), 
                  size = 0.9, 
                  alpha = 0.75) + #This is the Xf line
  geom_line(aes(x = Hr,
                  y = X0,
                  color = "Scaled Baseline Demand"),
                  size = 0.9, 
                  alpha = 0.75) + #This is the X0 line
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +
      xlab("Hour of the Day") +
      ylab("Electricity Demand (kW)") +
  geom_rect(aes(xmin = 11,
                xmax = 15,
                ymin = -Inf,
                ymax = Inf,
                fill = "Discount"),alpha = 0.005) + 
  geom_rect(aes(xmin = 6,
                xmax = 11,
                ymin = -Inf,
                ymax = Inf,
                fill = "Throttle"),alpha = 0.005) +
  scale_x_continuous(limits = c(0,24),breaks = c(0:24), expand = c(0,0)) +
  scale_fill_manual('Interventions', values = c("Discount" = 'green',"Throttle" = 'red1', "Rebate" = 'yellow1', "Throttle and Rebate" = "#C7B19C"),  guide = guide_legend(override.aes = list(alpha = 0.1))) +
  theme(legend.position = "bottom") +
  scale_color_manual('Demand', values = c("Scaled Baseline Demand" = "red3", "Event Demand" ="dodgerblue2"))

#Potential_Graph13 <- Demand_Graph13 +
#geom_line(aes(y=Theoretical_Max))

Demand_Graph13
ggsave("Event Graphs/Nov_14_WP_Event_Usage.png", Demand_Graph13, device = "png", width = 8, height = 4.5)


#COST
Cost_Table13 <- Nov_14_18_WP_scaled_baseline$EV_Demand[c("Hr","X0","P0","Event_Usage","P1")] %>% 
  mutate(Cost0 = X0*P0) %>% 
  mutate(Cost1 = Event_Usage*P1) %>% 
  mutate(Cost_diff = Cost1-Cost0)
#View(Cost_Table13)



#Emissions Results
#View(Nov_14_18_WP_scaled_baseline$EV_Demand)
write_csv(Nov_14_18_WP_scaled_baseline$EV_Demand, "Event Results/Workplace_Nov_14_18_Demand_Summary.csv")
Nov_14_18_WP_output_table <- emissions_fcn_event(Nov_14_18_WP_scaled_baseline$EV_Demand, intervention_hours = c(12:15)) 
write_csv(Nov_14_18_WP_output_table$Emissions_Table, "Event Results/Workplace_Nov_14_18_Output_Summary.csv") #write emissions to csv
write_csv(Nov_14_18_WP_output_table$Emissions, "Event Results/Workplace_Nov_14_18_Output_All_Hours.csv")


```


#Scenario 14- Nov 28, 2018 Event + Baseline (scaled for 434 chargers) 

Event: Workplace, November 28, 2018, TOU EV-4, $0.05 Discount (11AM-3PM)

```{r Scenario 14}

#CHARGERS
nov_28_18_WP_event <- Event_Chargers %>%
filter(Market_Segment=="Workplace") %>%
select(Nov_28_18_LS) %>%
unlist()

Nov_28_18_WP_scaled_baseline <- hourly_demand(
                    month = 11,
                    year=2018,
                    seg = "Workplace",
                    intervention_chargers =
                    nov_28_18_WP_event,
                    int_equals_baseline = FALSE,
                    include_wknds = FALSE)



nov_28_18_WP_Event_Usage <- filter(event_data, Date == "2018-11-28" & segment == "Workplace") %>%
select(Demand) %>%
unlist() 


Nov_28_18_WP_scaled_baseline$EV_Demand <- Nov_28_18_WP_scaled_baseline$EV_Demand %>%
  mutate(Event_Usage = nov_28_18_WP_Event_Usage) 

graph_table14 <- Nov_28_18_WP_scaled_baseline$EV_Demand[c("Hr","X0","Event_Usage")] #%>%
  #gather(condition,value,c("X0","Event_Usage")) %>%
  #mutate(Theoretical_Max=Nov_28_18_WP_scaled_baseline$EV_Demand$MT[1])

hr_24<- graph_table14[24,]
hr_24[1,1] <- 0
graph_table14 <- rbind(hr_24,graph_table14)

Demand_Graph14 <- ggplot(data = graph_table14, aes(x = Hr)) +
  geom_line(aes(x = Hr, 
                  y = Event_Usage, 
                  color = "Event Demand"), 
                  size = 0.9, 
                  alpha = 0.75) + #This is the Xf line
  geom_line(aes(x = Hr,
                  y = X0,
                  color = "Scaled Baseline Demand"),
                  size = 0.9, 
                  alpha = 0.75) + #This is the X0 line
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +
      xlab("Hour of the Day") +
      ylab("Electricity Demand (kW)") +
  geom_rect(aes(xmin = 11,
                xmax = 15,
                ymin = -Inf,
                ymax = Inf,
                fill = "Discount"),alpha = 0.005) + 
  geom_rect(aes(xmin = 6,
                xmax = 11,
                ymin = -Inf,
                ymax = Inf,
                fill = "Throttle"),alpha = 0.005) +
  scale_x_continuous(limits = c(0,24),breaks = c(0:24), expand = c(0,0)) +
  scale_fill_manual('Interventions', values = c("Discount" = 'green',"Throttle" = 'red1', "Rebate" = 'yellow1', "Throttle and Rebate" = "#C7B19C"),  guide = guide_legend(override.aes = list(alpha = 0.1))) +
  theme(legend.position = "bottom") +
  scale_color_manual('Demand', values = c("Scaled Baseline Demand" = "red3", "Event Demand" ="dodgerblue2"))
  

#Potential_Graph14 <- Demand_Graph14 +
#geom_line(aes(y=Theoretical_Max))

Demand_Graph14
ggsave("Event Graphs/Nov_28_WP_Event_Usage.png", Demand_Graph14, device = "png", width = 8, height = 4.5)



#COST
Cost_Table14 <- Nov_28_18_WP_scaled_baseline$EV_Demand[c("Hr","X0","P0","Event_Usage","P1")] %>% 
  mutate(Cost0 = X0*P0) %>% 
  mutate(Cost1 = Event_Usage*P1) %>% 
  mutate(Cost_diff = Cost1-Cost0) 
#View(Cost_Table14)

#Emissions Results
#View(Nov_28_18_WP_scaled_baseline$EV_Demand)
write_csv(Nov_28_18_WP_scaled_baseline$EV_Demand, "Event Results/Workplace_Nov_28_18_Demand_Summary.csv")
Nov_28_18_WP_output_table <- emissions_fcn_event(Nov_28_18_WP_scaled_baseline$EV_Demand, intervention_hours = c(12:15)) 
write_csv(Nov_28_18_WP_output_table$Emissions_Table, "Event Results/Workplace_Nov_28_18_Output_Summary.csv") #write emissions to csv
write_csv(Nov_28_18_WP_output_table$Emissions, "Event Results/Workplace_Nov_28_18_Output_All_Hours.csv")

```


#Scenario 15- October 30, 2018 Event + Baseline (scaled for 377 chargers) 

Event: Workplace, October 30, 2018, TOU EV-4, $0.05 Discount (11AM-3PM)

```{r Scenario 15}

#Scaled Baseline and Nov 14 event usage

#CHARGERS
Oct_30_18_WP_event <- Event_Chargers %>%
filter(Market_Segment=="Workplace") %>%
select(Oct_30_18_LS) %>%
unlist()

Oct_30_18_WP_scaled_baseline <- hourly_demand(
                          intervention_hours = c(12:15), 
                          month = 10,
                          year = 2018,
                          seg =  "Workplace",
                          intervention_chargers =
                          Oct_30_18_WP_event,
                          int_equals_baseline = FALSE,
                          include_wknds = FALSE)

Oct_30_18_WP_Event_Usage <- filter(event_data, Date == "2018-10-30" & segment == "Workplace") %>%
select(Demand) %>%
unlist()


Oct_30_18_WP_scaled_baseline$EV_Demand <- Oct_30_18_WP_scaled_baseline$EV_Demand %>%
  mutate(Event_Usage = Oct_30_18_WP_Event_Usage) 

graph_table15 <- Oct_30_18_WP_scaled_baseline$EV_Demand[c("Hr","X0","Event_Usage")] #%>%
  #gather(condition,value,c("X0","Event_Usage")) %>%
  #mutate(Theoretical_Max=Oct_30_18_WP_scaled_baseline$EV_Demand$MT[1])

hr_24<- graph_table15[24,]
hr_24[1,1] <- 0
graph_table15 <- rbind(hr_24,graph_table15)

Demand_Graph15 <- ggplot(data = graph_table15, aes(x = Hr)) +
  geom_line(aes(x = Hr, 
                  y = Event_Usage, 
                  color = "Event Demand"), 
                  size = 0.9, 
                  alpha = 0.75) + #This is the Xf line
    geom_line(aes(x = Hr,
                  y = X0,
                  color = "Scaled Baseline Demand"),
                  size = 0.9, 
                  alpha = 0.75) + #This is the X0 line
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +
      xlab("Hour of the Day") +
      ylab("Electricity Demand (kW)") +
    geom_rect(aes(xmin = 11,
                  xmax = 15,
                  ymin = -Inf,
                  ymax = Inf,
                  fill = "Discount"),alpha = 0.005) + #this is the discount rectangle REMOVE IF NO DISCOUNT
    geom_rect(aes(xmin = 6,
                  xmax = 11,
                  ymin = -Inf,
                  ymax = Inf,
                  fill = "Throttle"),alpha = 0.005) +
   scale_x_continuous(limits = c(0,24),breaks = c(0:24), expand = c(0,0)) +
      scale_fill_manual('Interventions', values = c("Discount" = 'green',"Throttle" = 'red1', "Rebate" = 'yellow1', "Throttle and Rebate" = "#C7B19C"),  guide = guide_legend(override.aes = list(alpha = 0.1))) +
      theme(legend.position = "bottom") +
      scale_color_manual('Demand', values = c("Scaled Baseline Demand" = "red3", "Event Demand" ="dodgerblue2"))
  

#Potential_Graph15 <- Demand_Graph15 +
#geom_line(aes(y=Theoretical_Max))

Demand_Graph15
ggsave("Event Graphs/Oct_30_WP_Event_Usage.png", Demand_Graph15, device = "png", width = 8, height = 4.5)

#COST
Cost_Table15 <- Oct_30_18_WP_scaled_baseline$EV_Demand[c("Hr","X0","P0","Event_Usage","P1")] %>% 
  mutate(Cost0 = X0*P0) %>% 
  mutate(Cost1 = Event_Usage*P1) %>% 
  mutate(Cost_diff = Cost1-Cost0)
#View(Cost_Table15)



#Emissions Results
#View(Nov_28_18_WP_scaled_baseline$EV_Demand)
write_csv(Oct_30_18_WP_scaled_baseline$EV_Demand, "Event Results/Workplace_Oct_30_18_Demand_Summary.csv")
Oct_30_18_WP_output_table <- emissions_fcn_event(Oct_30_18_WP_scaled_baseline$EV_Demand, intervention_hours = c(12:15)) 
write_csv(Oct_30_18_WP_output_table$Emissions_Table, "Event Results/Workplace_Oct_30_18_Output_Summary.csv") #write emissions to csv
write_csv(Oct_30_18_WP_output_table$Emissions, "Event Results/Workplace_Oct_30_18_Output_All_Hours.csv")
```


#Scenario 16: October 16, 2018 Event + Baseline (scaled for 494 chargers) 

Event: Workplace, October 16, 2018, TOU EV-4, $0.05 Discount (11AM-3PM)

```{r Scenario 16}

#Scaled Baseline and Oct 16 event usage

#CHARGERS
Oct_16_18_WP_event <- Event_Chargers %>%
filter(Market_Segment=="Workplace") %>%
select(Oct_16_18_LS) %>%
unlist()

Oct_16_18_WP_scaled_baseline <- hourly_demand(
                    month = 10,
                    year = 2018,
                    seg =  "Workplace",
                    intervention_chargers =
                    Oct_16_18_WP_event,
                    int_equals_baseline = FALSE,
                    include_wknds = FALSE)


Oct_16_18_WP_Event_Usage <- filter(event_data, Date == "2018-10-16" & segment == "Workplace") %>%
select(Demand) %>%
unlist()

Oct_16_18_WP_scaled_baseline$EV_Demand <- Oct_16_18_WP_scaled_baseline$EV_Demand %>%
  mutate(Event_Usage = Oct_16_18_WP_Event_Usage)


graph_table16 <- Oct_16_18_WP_scaled_baseline$EV_Demand[c("Hr","X0","Event_Usage")] #%>%
  #gather(condition,value,c("X0","Event_Usage")) %>%
  #mutate(Theoretical_Max=Oct_16_18_WP_scaled_baseline$EV_Demand$MT[1])

hr_24<- graph_table16[24,]
hr_24[1,1] <- 0
graph_table16 <- rbind(hr_24,graph_table16)

Demand_Graph16 <- ggplot(data = graph_table16, aes(x = Hr)) +
  geom_line(aes(x = Hr, 
                  y = Event_Usage, 
                  color = "Event Demand"), 
                  size = 0.9, 
                  alpha = 0.75) + #This is the Xf line
  geom_line(aes(x = Hr,
                  y = X0,
                  color = "Scaled Baseline Demand"),
                  size = 0.9, 
                  alpha = 0.75) + #This is the X0 line
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +
      xlab("Hour of the Day") +
      ylab("Electricity Demand (kW)") +
  geom_rect(aes(xmin = 11,
                  xmax = 15,
                  ymin = -Inf,
                  ymax = Inf,
                  fill = "Discount"),alpha = 0.005) + #this is the discount rectangle REMOVE IF NO DISCOUNT
  geom_rect(aes(xmin = 6,
                  xmax = 11,
                  ymin = -Inf,
                  ymax = Inf,
                  fill = "Throttle"),alpha = 0.005) +
    scale_x_continuous(limits = c(0,24),breaks = c(0:24), expand = c(0,0)) +
      scale_fill_manual('Interventions', values = c("Discount" = 'green',"Throttle" = 'red1', "Rebate" = 'yellow1', "Throttle and Rebate" = "#C7B19C"),  guide = guide_legend(override.aes = list(alpha = 0.1))) +
      theme(legend.position = "bottom") +
      scale_color_manual('Demand', values = c("Scaled Baseline Demand" = "red3", "Event Demand" ="dodgerblue2"))
  
  

#Potential_Graph16 <- Demand_Graph16 +
#geom_line(aes(y=Theoretical_Max))

Demand_Graph16
ggsave("Event Graphs/Oct_16_WP_Event_Usage.png", Demand_Graph16, device = "png", width = 8, height = 4.5)


#COST
Cost_Table16 <- Oct_16_18_WP_scaled_baseline$EV_Demand[c("Hr","X0","P0","Event_Usage","P1")] %>% 
  mutate(Cost0 = X0*P0) %>% 
  mutate(Cost1 = Event_Usage*P1) %>% 
  mutate(Cost_diff = Cost1-Cost0)
#View(Cost_Table16)


#Emissions Results
#View(Nov_28_18_WP_scaled_baseline$EV_Demand)
write_csv(Oct_16_18_WP_scaled_baseline$EV_Demand, "Event Results/Workplace_Oct_16_18_Demand_Summary.csv")
Oct_16_18_WP_output_table <- emissions_fcn_event(Oct_16_18_WP_scaled_baseline$EV_Demand, intervention_hours = c(12:15)) 
write_csv(Oct_16_18_WP_output_table$Emissions_Table, "Event Results/Workplace_Oct_16_18_Output_Summary.csv") #write emissions to csv
write_csv(Oct_16_18_WP_output_table$Emissions, "Event Results/Workplace_Oct_16_18_Output_All_Hours.csv")
```



#Scenario 17: September 27, 2018 LR Event + Baseline (scaled for 414 chargers) 

Event: Workplace, September 27, 2018, TOU EV-4, $0.10 Rebate (4PM-9PM)

```{r Scenario 17}

#Scaled Baseline and Oct 16 event usage

#CHARGERS
Sep_27_18_event <- Event_Chargers %>%
filter(Market_Segment=="Workplace") %>%
select(Sep_27_18_LR) %>%
unlist()

Sep_27_18_WP_scaled_baseline <- hourly_demand(
                    month = 9,
                    year = 2018,
                    seg =  "Workplace",
                    intervention_chargers =
                    Sep_27_18_event,
                    int_equals_baseline = FALSE,
                    include_wknds = FALSE, intervention_hours = c(17:21))


Sep_27_18_Event_Usage <- filter(event_data, Date == "2018-9-27" & segment == "Workplace") %>%
select(Demand) %>%
unlist()

Sep_27_18_WP_scaled_baseline$EV_Demand <- Sep_27_18_WP_scaled_baseline$EV_Demand %>%
  mutate(Event_Usage = Sep_27_18_Event_Usage)

graph_table17 <- Sep_27_18_WP_scaled_baseline$EV_Demand[c("Hr","X0","Event_Usage")] #%>%
  #gather(condition,value,c("X0","Event_Usage")) %>%
  #mutate(Theoretical_Max=Sep_27_18_WP_scaled_baseline$EV_Demand$MT[1])

hr_24<- graph_table17[24,]
hr_24[1,1] <- 0
graph_table17 <- rbind(hr_24,graph_table17)

Demand_Graph17 <- ggplot(data = graph_table17, aes(x = Hr)) +
  geom_line(aes(x = Hr, 
                  y = Event_Usage, 
                  color = "Event Demand"), 
                  size = 0.9, 
                  alpha = 0.75) + #This is the Xf line
  geom_line(aes(x = Hr,
                  y = X0,
                  color = "Scaled Baseline Demand"),
                  size = 0.9, 
                  alpha = 0.75) + #This is the X0 line
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +
      xlab("Hour of the Day") +
      ylab("Electricity Demand (kW)") +
  geom_rect(aes(xmin = 16,
                  xmax = 21,
                  ymin = -Inf,
                  ymax = Inf,
                  fill = "Throttle and Rebate"),alpha = 0.01) +
  scale_x_continuous(limits = c(0,24),breaks = c(0:24), expand = c(0,0)) +
      scale_fill_manual('Interventions', values = c("Discount" = 'green',"Throttle" = 'red1', "Rebate" = 'yellow1', "Throttle and Rebate" = "#C7B19C"),  guide = guide_legend(override.aes = list(alpha = 0.1))) +
      theme(legend.position = "bottom") +
      scale_color_manual('Demand', values = c("Scaled Baseline Demand" = "red3", "Event Demand" ="dodgerblue2"))
  

#Potential_Graph17 <- Demand_Graph17 +
#geom_line(aes(y=Theoretical_Max))

Demand_Graph17
ggsave("Event Graphs/Sep_27_WP_Event_Usage.png", Demand_Graph17, device = "png", width = 8, height = 4.5)


#Cost
Cost_Table17 <- Sep_27_18_WP_scaled_baseline$EV_Demand[c("Hr","X0","P0","Event_Usage","P1")] %>% 
  mutate(Cost0 = X0*P0) %>% 
  mutate(Cost1 = Event_Usage*P1) %>% 
  mutate(Cost_diff = Cost1-Cost0)
#View(Cost_Table17)


#Emissions Results
#View(Sep_27_18_WP_scaled_baseline$EV_Demand)
write_csv(Sep_27_18_WP_scaled_baseline$EV_Demand, "Event Results/Workplace_Sep_27_18_Demand_Summary.csv")
Sep_27_18_WP_output_table <- emissions_fcn_event(Sep_27_18_WP_scaled_baseline$EV_Demand, intervention_hours = c(17:21)) 
write_csv(Sep_27_18_WP_output_table$Emissions_Table, "Event Results/Workplace_Sep_27_18_Output_Summary.csv") #write emissions to csv
write_csv(Sep_27_18_WP_output_table$Emissions, "Event Results/Workplace_Sep_27_18_Output_All_Hours.csv")

```


#Scenario 18: August 30, 2018 LR Event + Baseline (scaled for 442 chargers) 

Event: Workplace, August 30, 2018, TOU EV-4, $0.10 Rebate (4PM-9PM), 50% Throttling (4-9PM)

```{r Scenario 18}

#Scaled Baseline and Aug 30 event usage

#CHARGERS
Aug_30_18_event <- Event_Chargers %>%
filter(Market_Segment=="Workplace") %>%
select(Aug_30_18_LR) %>%
unlist()

Aug_30_18_WP_scaled_baseline <- hourly_demand(
                    month = 8,
                    year = 2018,
                    seg =  "Workplace",
                    intervention_chargers =
                    Aug_30_18_event,
                    int_equals_baseline = FALSE,
                  include_wknds = FALSE)


Aug_30_18_Event_Usage <- filter(event_data, Date == "2018-8-30" & segment == "Workplace") %>%
select(Demand) %>%
unlist()

Aug_30_18_WP_scaled_baseline$EV_Demand <- Aug_30_18_WP_scaled_baseline$EV_Demand %>%
  mutate(Event_Usage = Aug_30_18_Event_Usage)


graph_table18 <- Aug_30_18_WP_scaled_baseline$EV_Demand[c("Hr","X0","Event_Usage")] #%>%
  #gather(condition,value,c("X0","Event_Usage")) %>%
  #mutate(Theoretical_Max=Aug_30_18_WP_scaled_baseline$EV_Demand$MT[1])

hr_24<- graph_table18[24,]
hr_24[1,1] <- 0
graph_table18 <- rbind(hr_24,graph_table18)

Demand_Graph18 <- ggplot(data = graph_table18, aes(x = Hr)) +
  
  geom_line(aes(x = Hr, 
                  y = Event_Usage, 
                  color = "Event Demand"), 
                  size = 0.9, 
                  alpha = 0.75) + #This is the Xf line
  geom_line(aes(x = Hr,
                  y = X0,
                  color = "Scaled Baseline Demand"),
                  size = 0.9, 
                  alpha = 0.75) + #This is the X0 line
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +
      xlab("Hour of the Day") +
      ylab("Electricity Demand (kW)") +
  geom_rect(aes(xmin = 16,
                xmax = 21,
                ymin = -Inf,
                ymax = Inf,
                fill = "Throttle and Rebate"),alpha = 0.01) +
      scale_x_continuous(limits = c(0,24),breaks = c(0:24), expand = c(0,0)) +
      scale_fill_manual('Interventions', values = c("Discount" = 'green',"Throttle" = 'red1', "Rebate" = 'yellow1', "Throttle and Rebate" = "#C7B19C"),  guide = guide_legend(override.aes = list(alpha = 0.1))) +
      theme(legend.position = "bottom") +
      scale_color_manual('Demand', values = c("Scaled Baseline Demand" = "red3", "Event Demand" ="dodgerblue2"))
  
  

#Potential_Graph18 <- Demand_Graph18 +
#geom_line(aes(y=Theoretical_Max))

Demand_Graph18
ggsave("Event Graphs/Aug_30_WP_Event_Usage.png", Demand_Graph18, device = "png", width = 8, height = 4.5)


#Cost
Cost_Table18 <- Aug_30_18_WP_scaled_baseline$EV_Demand[c("Hr","X0","P0","Event_Usage","P1")] %>% 
  mutate(Cost0 = X0*P0) %>% 
  mutate(Cost1 = Event_Usage*P1) %>% 
  mutate(Cost_diff = Cost1-Cost0)
#View(Cost_Table18)

#Sum of Cost
Sum_Cost18 <-sum(Cost_Table18$Cost_diff)
#View(Sum_Cost18)



#Emissions Results
#View(Sep_27_18_WP_scaled_baseline$EV_Demand)
write_csv(Aug_30_18_WP_scaled_baseline$EV_Demand, "Event Results/Workplace_Aug_30_18_Demand_Summary.csv")
Aug_30_18_WP_output_table <- emissions_fcn_event(Aug_30_18_WP_scaled_baseline$EV_Demand, intervention_hours = c(17:21)) 
write_csv(Aug_30_18_WP_output_table$Emissions_Table, "Event Results/Workplace_Aug_30_18_Output_Summary.csv") #write emissions to csv
write_csv(Aug_30_18_WP_output_table$Emissions, "Event Results/Workplace_Aug_30_18_Output_All_Hours.csv")
```



#Scenario 19: July 31, 2018 LR Event + Baseline (scaled for 396 chargers) 

Event: Workplace, July 31, 2018, TOU EV-4, $0.10 Rebate (4PM-9PM)

```{r Scenario 19}

#Scaled Baseline and Jul 31 event usage

#CHARGERS
Jul_31_18_event <- Event_Chargers %>%
filter(Market_Segment=="Workplace") %>%
select(Jul_31_18_LR) %>%
unlist()

Jul_31_18_WP_scaled_baseline <- hourly_demand(
                    month = 7,
                    year = 2018,
                    seg =  "Workplace",
                    intervention_chargers =
                    Jul_31_18_event,
                    int_equals_baseline = FALSE,
                   include_wknds = FALSE)


Jul_31_18_Event_Usage <- filter(event_data, Date == "2018-7-31" & segment == "Workplace") %>%
select(Demand) %>%
unlist()


Jul_31_18_WP_scaled_baseline$EV_Demand <- Jul_31_18_WP_scaled_baseline$EV_Demand %>%
  mutate(Event_Usage = Jul_31_18_Event_Usage)


graph_table19 <- Jul_31_18_WP_scaled_baseline$EV_Demand[c("Hr","X0","Event_Usage")] #%>%
  #gather(condition,value,c("X0","Event_Usage")) %>%
  #mutate(Theoretical_Max=Jul_31_18_WP_scaled_baseline$EV_Demand$MT[1])

hr_24<- graph_table19[24,]
hr_24[1,1] <- 0
graph_table19 <- rbind(hr_24,graph_table19)

Demand_Graph19 <- ggplot(data = graph_table19, aes(x = Hr)) +
  geom_line(aes(x = Hr, 
                  y = Event_Usage, 
                  color = "Event Demand"), 
                  size = 0.9, 
                  alpha = 0.75) + #This is the Xf line
  geom_line(aes(x = Hr,
                  y = X0,
                  color = "Scaled Baseline Demand"),
                  size = 0.9, 
                  alpha = 0.75) + #This is the X0 line
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +
      xlab("Hour of the Day") +
      ylab("Electricity Demand (kW)") +
  geom_rect(aes(xmin = 16,
                xmax = 21,
                ymin = -Inf,
                ymax = Inf,
                fill = "Throttle and Rebate"),alpha = 0.01) +
      scale_x_continuous(limits = c(0,24),breaks = c(0:24), expand = c(0,0)) +
      scale_fill_manual('Interventions', values = c("Discount" = 'green',"Throttle" = 'red1', "Rebate" = 'yellow1', "Throttle and Rebate" = "#C7B19C"),  guide = guide_legend(override.aes = list(alpha = 0.1))) +
      theme(legend.position = "bottom") +
      scale_color_manual('Demand', values = c("Scaled Baseline Demand" = "red3", "Event Demand" ="dodgerblue2"))

# Potential_Graph19 <- Demand_Graph19 +
# geom_line(aes(y=Theoretical_Max))

Demand_Graph19
ggsave("Event Graphs/Jul_31_WP_Event_Usage.png", Demand_Graph19, device = "png", width = 8, height = 4.5)

#Cost
Cost_Table19 <- Jul_31_18_WP_scaled_baseline$EV_Demand[c("Hr","X0","P0","Event_Usage","P1")] %>% 
  mutate(Cost0 = X0*P0) %>% 
  mutate(Cost1 = Event_Usage*P1) %>% 
  mutate(Cost_diff = Cost1-Cost0)
#View(Cost_Table19)

#Sum of Cost
Sum_Cost19 <-sum(Cost_Table19$Cost_diff)
#View(Sum_Cost19)




#Emissions Results
#View(Sep_27_18_WP_scaled_baseline$EV_Demand)
write_csv(Jul_31_18_WP_scaled_baseline$EV_Demand, "Event Results/Workplace_Jul_31_18_Demand_Summary.csv")
Jul_31_18_WP_output_table <- emissions_fcn_event(Jul_31_18_WP_scaled_baseline$EV_Demand, intervention_hours = c(17:21)) 
write_csv(Jul_31_18_WP_output_table$Emissions_Table, "Event Results/Workplace_Jul_31_18_Output_Summary.csv") #write emissions to csv
write_csv(Jul_31_18_WP_output_table$Emissions, "Event Results/Workplace_Jul_31_18_Output_All_Hours.csv")
```

#Scenario 43: July 11, 2018 LR Event + Baseline (scaled for 464 chargers) 

Event: Workplace, July 11, 2018, TOU EV-4, $0.10 Rebate (4PM-9PM)

```{r Scenario 43}

#Scaled Baseline and Jul 11 event usage

#CHARGERS
Jul_11_18_event <- Event_Chargers %>%
filter(Market_Segment=="Workplace") %>%
select(Jul_11_18_LR) %>%
unlist()

Jul_11_18_WP_scaled_baseline <- hourly_demand(
                    month = 7,
                    year = 2018,
                    seg =  "Workplace",
                    intervention_chargers =
                    Jul_11_18_event,
                    int_equals_baseline = FALSE,
                   include_wknds = FALSE)


Jul_11_18_Event_Usage <- filter(event_data, Date == "2018-7-11" & segment == "Workplace") %>%
select(Demand) %>%
unlist()


Jul_11_18_WP_scaled_baseline$EV_Demand <- Jul_11_18_WP_scaled_baseline$EV_Demand %>%
  mutate(Event_Usage = Jul_11_18_Event_Usage)


graph_table43 <- Jul_11_18_WP_scaled_baseline$EV_Demand[c("Hr","X0","Event_Usage")] #%>%
  #gather(condition,value,c("X0","Event_Usage")) %>%
  #mutate(Theoretical_Max=Jul_11_18_WP_scaled_baseline$EV_Demand$MT[1])

hr_24<- graph_table43[24,]
hr_24[1,1] <- 0
graph_table43 <- rbind(hr_24,graph_table43)

Demand_Graph43 <- ggplot(data = graph_table43, aes(x = Hr)) +
  geom_line(aes(x = Hr, 
                  y = Event_Usage, 
                  color = "Event Demand"), 
                  size = 0.9, 
                  alpha = 0.75) + #This is the Xf line
  geom_line(aes(x = Hr,
                  y = X0,
                  color = "Scaled Baseline Demand"),
                  size = 0.9, 
                  alpha = 0.75) + #This is the X0 line
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +
      xlab("Hour of the Day") +
      ylab("Electricity Demand (kW)") +
  geom_rect(aes(xmin = 16,
                xmax = 21,
                ymin = -Inf,
                ymax = Inf,
                fill = "Throttle and Rebate"),alpha = 0.01) +
      scale_x_continuous(limits = c(0,24),breaks = c(0:24), expand = c(0,0)) +
      scale_fill_manual('Interventions', values = c("Discount" = 'green',"Throttle" = 'red1', "Rebate" = 'yellow1', "Throttle and Rebate" = "#C7B19C"),  guide = guide_legend(override.aes = list(alpha = 0.1))) +
      theme(legend.position = "bottom") +
      scale_color_manual('Demand', values = c("Scaled Baseline Demand" = "red3", "Event Demand" ="dodgerblue2"))
 
# Potential_Graph43 <- Demand_Graph43 +
# geom_line(aes(y=Theoretical_Max))

Demand_Graph43
ggsave("Event Graphs/Jul_11_WP_Event_Usage.png", Demand_Graph43, device = "png", width = 8, height = 4.5)


#Cost
Cost_Table43 <- Jul_11_18_WP_scaled_baseline$EV_Demand[c("Hr","X0","P0","Event_Usage","P1")] %>% 
  mutate(Cost0 = X0*P0) %>% 
  mutate(Cost1 = Event_Usage*P1) %>% 
  mutate(Cost_diff = Cost1-Cost0)
#View(Cost_Table19)

#Sum of Cost
Sum_Cost43 <-sum(Cost_Table43$Cost_diff)
#View(Sum_Cost19)



#Emissions Results
#View(Sep_27_18_WP_scaled_baseline$EV_Demand)
write_csv(Jul_11_18_WP_scaled_baseline$EV_Demand, "Event Results/Workplace_Jul_11_18_Demand_Summary.csv")
Jul_11_18_WP_output_table <- emissions_fcn_event(Jul_11_18_WP_scaled_baseline$EV_Demand, intervention_hours = c(17:21)) 
write_csv(Jul_11_18_WP_output_table$Emissions_Table, "Event Results/Workplace_Jul_11_18_Output_Summary.csv") #write emissions to csv
write_csv(Jul_11_18_WP_output_table$Emissions, "Event Results/Workplace_Jul_11_18_Output_All_Hours.csv")
```


DESTINATION CENTER
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

#Scenario 20 - Nov 28, 2018 DC Event + Baseline (scaled for 146 chargers) 

Event: Destination Center, November 28, 2018, TOU EV-4, $0.05 Discount (11AM-3PM)

```{r Scenario 20}

#CHARGERS
nov_28_18_DC_event <- Event_Chargers %>%
filter(Market_Segment=="DC") %>%
select(Nov_28_18_LS) %>%
unlist()

Nov_28_18_DC_scaled_baseline <- hourly_demand(
                    month = 11,
                    year = 2018,
                    seg =  "Destination Center",
                    intervention_chargers =
                    nov_28_18_DC_event,
                    int_equals_baseline = FALSE,
                    include_wknds = FALSE)


Nov_28_18_DC_Event_Usage <- filter(event_data, Date == "2018-11-28" & segment == "Destination Center") %>%
select(Demand) %>%
unlist()

Nov_28_18_DC_scaled_baseline$EV_Demand <- Nov_28_18_DC_scaled_baseline$EV_Demand %>%
  mutate(Event_Usage = Nov_28_18_DC_Event_Usage)


graph_table20 <- Nov_28_18_DC_scaled_baseline$EV_Demand[c("Hr","X0","Event_Usage")] #%>%
  #gather(condition,value,c("X0","Event_Usage")) %>%
  #mutate(Theoretical_Max=Nov_28_18_DC_scaled_baseline$EV_Demand$MT[1])

hr_24<- graph_table20[24,]
hr_24[1,1] <- 0
graph_table20 <- rbind(hr_24,graph_table20)

Demand_Graph20 <- ggplot(data = graph_table20, aes(x = Hr)) +
  geom_line(aes(x = Hr, 
                  y = Event_Usage, 
                  color = "Event Demand"), 
                  size = 0.9, 
                  alpha = 0.75) + #This is the Xf line
    geom_line(aes(x = Hr,
                  y = X0,
                  color = "Scaled Baseline Demand"),
                  size = 0.9, 
                  alpha = 0.75) + #This is the X0 line
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +
      xlab("Hour of the Day") +
      ylab("Electricity Demand (kW)") +
  geom_rect(aes(xmin = 6,
                  xmax = 11,
                  ymin = -Inf,
                  ymax = Inf,
                  fill = "Throttle"),alpha = 0.005) +
  geom_rect(aes(xmin = 11,
                  xmax = 15,
                  ymin = -Inf,
                  ymax = Inf,
                  fill = "Discount"),alpha = 0.005) +
  scale_x_continuous(limits = c(0,24),breaks = c(0:24), expand = c(0,0)) +
      scale_fill_manual('Interventions', values = c("Discount" = 'green',"Throttle" = 'red1', "Rebate" = 'yellow1', "Throttle and Rebate" = "#C7B19C"),  guide = guide_legend(override.aes = list(alpha = 0.1))) +
      theme(legend.position = "bottom") +
      scale_color_manual('Demand', values = c("Scaled Baseline Demand" = "red3", "Event Demand" ="dodgerblue2"))


#Potential_Graph20 <- Demand_Graph20 +
#geom_line(aes(y=Theoretical_Max))

Demand_Graph20
ggsave("Event Graphs/Nov_28_DC_Event_Usage.png", Demand_Graph20, device = "png", width = 8, height = 4.5)


#Cost
Cost_Table20 <- Nov_28_18_DC_scaled_baseline$EV_Demand[c("Hr","X0","P0","Event_Usage","P1")] %>% 
  mutate(Cost0 = X0*P0) %>% 
  mutate(Cost1 = Event_Usage*P1) %>% 
  mutate(Cost_diff = Cost1-Cost0)
#View(Cost_Table20)


#Emissions Results
#View(Sep_27_18_WP_scaled_baseline$EV_Demand)
write_csv(Nov_28_18_DC_scaled_baseline$EV_Demand, "Event Results/DC_Nov_28_18_Demand_Summary.csv")
Nov_28_18_DC_output_table <- emissions_fcn_event(Nov_28_18_DC_scaled_baseline$EV_Demand, intervention_hours = c(12:15)) 
write_csv(Nov_28_18_DC_output_table$Emissions_Table, "Event Results/DC_Nov_28_18_Output_Summary.csv") #write emissions to csv
write_csv(Nov_28_18_DC_output_table$Emissions, "Event Results/DC_Nov_28_18_Output_All_Hours.csv")

```

#Scenario 21- Nov 14, 2018 DC EVENT + Baseline (scaled for 117 chargers) 

Event: Destination Center, November 14, 2018, TOU EV-4, $0.05 Discount (11AM-3PM)

```{r Scenario 21}

#Scaled Baseline and Nov 14 event usage

#CHARGERS
nov_14_18_DC_event <- Event_Chargers %>%
filter(Market_Segment=="DC") %>%
select(Nov_14_18_LS) %>%
unlist()


Nov_14_18_DC_scaled_baseline <- hourly_demand(
                    month = 11,
                    year= 2018,
                    seg =  "Destination Center",
                    intervention_chargers =
                    nov_14_18_DC_event,
                    int_equals_baseline = FALSE,
                    include_wknds = FALSE)



nov_14_18_DC_Event_Usage <- filter(event_data, Date == "2018-11-14" & segment == "Destination Center") %>%
select(Demand) %>%
unlist() 

Nov_14_18_DC_scaled_baseline$EV_Demand <- Nov_14_18_DC_scaled_baseline$EV_Demand %>%
  mutate(Event_Usage = nov_14_18_DC_Event_Usage)


graph_table21 <- Nov_14_18_DC_scaled_baseline$EV_Demand[c("Hr","X0","Event_Usage")] #%>%
  #gather(condition,value,c("X0","Event_Usage")) %>%
  #mutate(Theoretical_Max=Nov_14_18_DC_scaled_baseline$EV_Demand$MT[1])

hr_24<- graph_table21[24,]
hr_24[1,1] <- 0
graph_table21 <- rbind(hr_24,graph_table21)

Demand_Graph21 <- ggplot(data = graph_table21, aes(x = Hr)) +
  geom_line(aes(x = Hr, 
                  y = Event_Usage, 
                  color = "Event Demand"), 
                  size = 0.9, 
                  alpha = 0.75) + #This is the Xf line
    geom_line(aes(x = Hr,
                  y = X0,
                  color = "Scaled Baseline Demand"),
                  size = 0.9, 
                  alpha = 0.75) + #This is the X0 line
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +
      xlab("Hour of the Day") +
      ylab("Electricity Demand (kW)") +
  geom_rect(aes(xmin = 11,
                  xmax = 15,
                  ymin = -Inf,
                  ymax = Inf,
                  fill = "Discount"),alpha = 0.005) +
  geom_rect(aes(xmin = 6,
                  xmax = 11,
                  ymin = -Inf,
                  ymax = Inf,
                  fill = "Throttle"),alpha = 0.005) +
  scale_x_continuous(limits = c(0,24),breaks = c(0:24), expand = c(0,0)) +
      scale_fill_manual('Interventions', values = c("Discount" = 'green',"Throttle" = 'red1', "Rebate" = 'yellow1', "Throttle and Rebate" = "#C7B19C"),  guide = guide_legend(override.aes = list(alpha = 0.1))) +
      theme(legend.position = "bottom") +
      scale_color_manual('Demand', values = c("Scaled Baseline Demand" = "red3", "Event Demand" ="dodgerblue2"))
  
  
#Potential_Graph21 <- Demand_Graph21 +
#geom_line(aes(y=Theoretical_Max))

Demand_Graph21
ggsave("Event Graphs/Nov_14_DC_Event_Usage.png", Demand_Graph21, device = "png", width = 8, height = 4.5)

#COST
Cost_Table21 <- Nov_14_18_DC_scaled_baseline$EV_Demand[c("Hr","X0","P0","Event_Usage","P1")] %>% 
  mutate(Cost0 = X0*P0) %>% 
  mutate(Cost1 = Event_Usage*P1) %>% 
  mutate(Cost_diff = Cost1-Cost0)
#View(Cost_Table13)


#Emissions Results
#View(Nov_14_18_DC_scaled_baseline$EV_Demand)
write_csv(Nov_14_18_DC_scaled_baseline$EV_Demand, "Event Results/DC_Nov_14_18_Demand_Summary.csv")
Nov_14_18_DC_output_table <- emissions_fcn_event(Nov_14_18_DC_scaled_baseline$EV_Demand, intervention_hours = c(12:15)) 
write_csv(Nov_14_18_DC_output_table$Emissions_Table, "Event Results/DC_Nov_14_18_Output_Summary.csv") #write emissions to csv
write_csv(Nov_14_18_DC_output_table$Emissions, "Event Results/DC_Nov_14_18_Output_All_Hours.csv")
```

#Scenario 22 - Oct 30, 2018 DC EVENT + Baseline (scaled for 150 chargers) 

Event: Destination Center, October 30, 2018, TOU EV-4, $0.05 Discount (11AM-3PM), 50% Throttling (6-11AM)

```{r Scenario 22}

#Scaled Baseline and Nov 14 event usage

#CHARGERS
Oct_30_18_DC_event <- Event_Chargers %>%
filter(Market_Segment=="DC") %>%
select(Oct_30_18_LS) %>%
unlist()


Oct_30_18_DC_scaled_baseline <- hourly_demand(
                    month = 10,
                    year= 2018,
                    seg =  "Destination Center",
                    intervention_chargers =
                    Oct_30_18_DC_event,
                    int_equals_baseline = FALSE,
                    include_wknds = FALSE)



Oct_30_18_DC_Event_Usage <- filter(event_data, Date == "2018-10-30" & segment == "Destination Center") %>%
select(Demand) %>%
unlist() 

Oct_30_18_DC_scaled_baseline$EV_Demand <- Oct_30_18_DC_scaled_baseline$EV_Demand %>%
  mutate(Event_Usage = Oct_30_18_DC_Event_Usage)


graph_table22 <- Oct_30_18_DC_scaled_baseline$EV_Demand[c("Hr","X0","Event_Usage")] #%>%
  #gather(condition,value,c("X0","Event_Usage")) %>%
  #mutate(Theoretical_Max=Oct_30_18_DC_scaled_baseline$EV_Demand$MT[1])

hr_24<- graph_table22[24,]
hr_24[1,1] <- 0
graph_table22 <- rbind(hr_24,graph_table22)

Demand_Graph22 <- ggplot(data = graph_table22, aes(x = Hr)) +
  geom_line(aes(x = Hr, 
                y = Event_Usage, 
                color = "Event Demand"), 
                size = 0.9, 
                alpha = 0.75) + #This is the Xf line
  geom_line(aes(x = Hr,
                y = X0,
                color = "Scaled Baseline Demand"),
                size = 0.9, 
                alpha = 0.75) + #This is the X0 line
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +
      xlab("Hour of the Day") +
      ylab("Electricity Demand (kW)") +
  geom_rect(aes(xmin = 11,
                xmax = 15,
                ymin = -Inf,
                ymax = Inf,
                fill = "Discount"),alpha = 0.005) +
  geom_rect(aes(xmin = 6,
                xmax = 11,
                ymin = -Inf,
                ymax = Inf,
                fill = "Throttle"),alpha = 0.005) +
  scale_x_continuous(limits = c(0,24),breaks = c(0:24), expand = c(0,0)) +
      scale_fill_manual('Interventions', values = c("Discount" = 'green',"Throttle" = 'red1', "Rebate" = 'yellow1', "Throttle and Rebate" = "#C7B19C"),  guide = guide_legend(override.aes = list(alpha = 0.1))) +
      theme(legend.position = "bottom") +
      scale_color_manual('Demand', values = c("Scaled Baseline Demand" = "red3", "Event Demand" ="dodgerblue2"))

#Potential_Graph22 <- Demand_Graph22 +
#geom_line(aes(y=Theoretical_Max))

Demand_Graph22
ggsave("Event Graphs/Oct_30_18_DC_Event_Usage.png", Demand_Graph22, device = "png", width = 8, height = 4.5)

#COST
Cost_Table22 <- Oct_30_18_DC_scaled_baseline$EV_Demand[c("Hr","X0","P0","Event_Usage","P1")] %>% 
  mutate(Cost0 = X0*P0) %>% 
  mutate(Cost1 = Event_Usage*P1) %>% 
  mutate(Cost_diff = Cost1-Cost0)
#View(Cost_Table22)


#Emissions Results
#View(Nov_14_18_DC_scaled_baseline$EV_Demand)
write_csv(Oct_30_18_DC_scaled_baseline$EV_Demand, "Event Results/DC_Oct_30_18_Demand_Summary.csv")
Oct_30_18_DC_output_table <- emissions_fcn_event(Oct_30_18_DC_scaled_baseline$EV_Demand, intervention_hours = c(12:15)) 
write_csv(Oct_30_18_DC_output_table$Emissions_Table, "Event Results/DC_Oct_30_18_Output_Summary.csv") #write emissions to csv
write_csv(Oct_30_18_DC_output_table$Emissions, "Event Results/DC_Oct_30_18_Output_All_Hours.csv")
```

#Scenario 23 - Oct 16, 2018 DC EVENT + Baseline (scaled for 110 chargers) 

Event: Destination Center, October 16, 2018, TOU EV-4, $0.05 Discount (11AM-3PM), 50% Throttling (6-11AM)

```{r Scenario 23}

#Scaled Baseline and October 16 event usage

#CHARGERS
Oct_16_18_DC_event <- Event_Chargers %>%
filter(Market_Segment=="DC") %>%
select(Oct_16_18_LS) %>%
unlist()


Oct_16_18_DC_scaled_baseline <- hourly_demand(
                    month = 10,
                    year= 2018,
                    seg =  "Destination Center",
                    intervention_chargers =
                    Oct_16_18_DC_event,
                    int_equals_baseline = FALSE,
                    include_wknds = FALSE)



Oct_16_18_DC_Event_Usage <- filter(event_data, Date == "2018-10-16" & segment == "Destination Center") %>%
select(Demand) %>%
unlist() 

Oct_16_18_DC_scaled_baseline$EV_Demand <- Oct_16_18_DC_scaled_baseline$EV_Demand %>%
  mutate(Event_Usage = Oct_16_18_DC_Event_Usage)




graph_table23 <- Oct_16_18_DC_scaled_baseline$EV_Demand[c("Hr","X0","Event_Usage")] #%>%
  #gather(condition,value,c("X0","Event_Usage")) %>%
  #mutate(Theoretical_Max=Oct_16_18_DC_scaled_baseline$EV_Demand$MT[1])

hr_24<- graph_table23[24,]
hr_24[1,1] <- 0
graph_table23 <- rbind(hr_24,graph_table23)

Demand_Graph23 <- ggplot(data = graph_table23, aes(x = Hr)) +
  geom_line(aes(x = Hr, 
                y = Event_Usage, 
                color = "Event Demand"), 
                size = 0.9, 
                alpha = 0.75) + #This is the Xf line
  geom_line(aes(x = Hr,
                y = X0,
                color = "Scaled Baseline Demand"),
                size = 0.9, 
                alpha = 0.75) + #This is the X0 line
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +
      xlab("Hour of the Day") +
      ylab("Electricity Demand (kW)") +
  geom_rect(aes(xmin = 11,
                xmax = 15,
                ymin = -Inf,
                ymax = Inf,
                fill = "Discount"),alpha = 0.005) +
  geom_rect(aes(xmin = 6,
                xmax = 11,
                ymin = -Inf,
                ymax = Inf,
                fill = "Throttle"),alpha = 0.005) +
      scale_x_continuous(limits = c(0,24),breaks = c(0:24), expand = c(0,0)) +
      scale_fill_manual('Interventions', values = c("Discount" = 'green',"Throttle" = 'red1', "Rebate" = 'yellow1', "Throttle and Rebate" = "#C7B19C"),  guide = guide_legend(override.aes = list(alpha = 0.1))) +
      theme(legend.position = "bottom") +
      scale_color_manual('Demand', values = c("Scaled Baseline Demand" = "red3", "Event Demand" ="dodgerblue2"))

#Potential_Graph23 <- Demand_Graph23 +
#geom_line(aes(y=Theoretical_Max))

Demand_Graph23
ggsave("Event Graphs/Oct_16_18_DC_Event_Usage.png", Demand_Graph23, device = "png", width = 8, height = 4.5)

#COST
Cost_Table23 <- Oct_16_18_DC_scaled_baseline$EV_Demand[c("Hr","X0","P0","Event_Usage","P1")] %>% 
  mutate(Cost0 = X0*P0) %>% 
  mutate(Cost1 = Event_Usage*P1) %>% 
  mutate(Cost_diff = Cost1-Cost0)
#View(Cost_Table22)

#Emissions Results
#View(Oct_16_18_DC_scaled_baseline$EV_Demand)
write_csv(Oct_16_18_DC_scaled_baseline$EV_Demand, "Event Results/DC_Oct_16_18_Demand_Summary.csv")
Oct_16_18_DC_output_table <- emissions_fcn_event(Oct_16_18_DC_scaled_baseline$EV_Demand, intervention_hours = c(12:15)) 
write_csv(Oct_16_18_DC_output_table$Emissions_Table, "Event Results/DC_Oct_16_18_Output_Summary.csv") #write emissions to csv
write_csv(Oct_16_18_DC_output_table$Emissions, "Event Results/DC_Oct_16_18_Output_All_Hours.csv")
```

#Scenario 24- Sep 27, 2018 DC EVENT + Baseline (scaled for 176 chargers) 

Event: Destination Center, September 27, 2018, TOU EV-4, $0.10 Rebate (4-9PM), 50% Throttling (4-9PM)

```{r Scenario 24}

#Scaled Baseline and September 27 event usage

#CHARGERS
Sep_27_18_DC_event <- Event_Chargers %>%
filter(Market_Segment=="DC") %>%
select(Sep_27_18_LR) %>%
unlist()


Sep_27_18_DC_scaled_baseline <- hourly_demand(
                    month = 9,
                    year= 2018,
                    seg =  "Destination Center",
                    intervention_chargers =
                   Sep_27_18_DC_event,
                    int_equals_baseline = FALSE,
                   include_wknds = FALSE)



Sep_27_18_DC_Event_Usage <- filter(event_data, Date == "2018-9-27" & segment == "Destination Center") %>%
select(Demand) %>%
unlist() 

Sep_27_18_DC_scaled_baseline$EV_Demand <- Sep_27_18_DC_scaled_baseline$EV_Demand %>%
  mutate(Event_Usage = Sep_27_18_DC_Event_Usage)

graph_table24 <- Sep_27_18_DC_scaled_baseline$EV_Demand[c("Hr","X0","Event_Usage")] #%>%
  #gather(condition,value,c("X0","Event_Usage")) %>%
  #mutate(Theoretical_Max=Sep_27_18_DC_scaled_baseline$EV_Demand$MT[1])

hr_24<- graph_table24[24,]
hr_24[1,1] <- 0
graph_table24 <- rbind(hr_24,graph_table24)

Demand_Graph24 <- ggplot(data = graph_table24, aes(x = Hr)) +
  geom_line(aes(x = Hr, 
                y = Event_Usage, 
                color = "Event Demand"), 
                size = 0.9, 
                alpha = 0.75) + #This is the Xf line
  geom_line(aes(x = Hr,
                y = X0,
                color = "Scaled Baseline Demand"),
                size = 0.9, 
                alpha = 0.75) + #This is the X0 line
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +
      xlab("Hour of the Day") +
      ylab("Electricity Demand (kW)") +
  geom_rect(aes(xmin = 16,
                  xmax = 21,
                  ymin = -Inf,
                  ymax = Inf,
                  fill = "Throttle and Rebate"),alpha = 0.01) + #this is the throttle + rebate rectangle REMOVE IF NO THROTTLING + REBATE
      scale_x_continuous(limits = c(0,24),breaks = c(0:24), expand = c(0,0)) +
      scale_fill_manual('Interventions', values = c("Discount" = 'green',"Throttle" = 'red1', "Rebate" = 'yellow1', "Throttle and Rebate" = "#C7B19C"),  guide = guide_legend(override.aes = list(alpha = 0.1))) +
      theme(legend.position = "bottom") +
      scale_color_manual('Demand', values = c("Scaled Baseline Demand" = "red3", "Event Demand" ="dodgerblue2"))

#Potential_Graph24 <- Demand_Graph24 +
#geom_line(aes(y=Theoretical_Max))

Demand_Graph24
ggsave("Event Graphs/Sep_27_18_DC_Event_Usage.png", Demand_Graph24, device = "png", width = 8, height = 4.5)

#COST
Cost_Table24 <- Sep_27_18_DC_scaled_baseline$EV_Demand[c("Hr","X0","P0","Event_Usage","P1")] %>% 
  mutate(Cost0 = X0*P0) %>% 
  mutate(Cost1 = Event_Usage*P1) %>% 
  mutate(Cost_diff = Cost1-Cost0)
#View(Cost_Table24)


#Emissions Results
#View(Sep_27_18_DC_scaled_baseline$EV_Demand)
write_csv(Sep_27_18_DC_scaled_baseline$EV_Demand, "Event Results/DC_Sep_27_18_Demand_Summary.csv")
Sep_27_18_DC_output_table <- emissions_fcn_event(Sep_27_18_DC_scaled_baseline$EV_Demand, intervention_hours = c(17:21)) 
write_csv(Sep_27_18_DC_output_table$Emissions_Table, "Event Results/DC_Sep_27_18_Output_Summary.csv") #write emissions to csv
write_csv(Sep_27_18_DC_output_table$Emissions, "Event Results/DC_Sep_27_18_Output_All_Hours.csv")
```

#Scenario 25- Aug 30, 2018 DC EVENT + Baseline (scaled for 133 chargers) 

Event: Destination Center, August 30, 2018, TOU EV-4, $0.10 Rebate (4-9PM), 50% Throttling (4-9PM)

```{r Scenario 25}

#Scaled Baseline and AUGUST 30 event usage

#CHARGERS
Aug_30_18_DC_event <- Event_Chargers %>%
filter(Market_Segment=="DC") %>%
select(Aug_30_18_LR) %>%
unlist()


Aug_30_18_DC_scaled_baseline <- hourly_demand(
                    month = 8,
                    year= 2018,
                    seg =  "Destination Center",
                    intervention_chargers =
                   Aug_30_18_DC_event,
                    int_equals_baseline = FALSE,
                   include_wknds = FALSE)



Aug_30_18_DC_Event_Usage <- filter(event_data, Date == "2018-8-30" & segment == "Destination Center") %>%
select(Demand) %>%
unlist() 

Aug_30_18_DC_scaled_baseline$EV_Demand <- Aug_30_18_DC_scaled_baseline$EV_Demand %>%
  mutate(Event_Usage = Aug_30_18_DC_Event_Usage)


graph_table25 <- Aug_30_18_DC_scaled_baseline$EV_Demand[c("Hr","X0","Event_Usage")] #%>%
  #gather(condition,value,c("X0","Event_Usage")) %>%
  #mutate(Theoretical_Max=Aug_30_18_DC_scaled_baseline$EV_Demand$MT[1])

hr_24<- graph_table25[24,]
hr_24[1,1] <- 0
graph_table25 <- rbind(hr_24,graph_table25)


Demand_Graph25 <- ggplot(data = graph_table25, aes(x = Hr)) +
  geom_line(aes(x = Hr, 
                  y = Event_Usage, 
                  color = "Event Demand"), 
                  size = 0.9, alpha = 0.75) + #This is the Xf line
  geom_line(aes(x = Hr,
                  y = X0,
                  color = "Scaled Baseline Demand"),
                  size = 0.9, alpha = 0.75) + #This is the X0 line
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +
      xlab("Hour of the Day") +
      ylab("Electricity Demand (kW)") +
  geom_rect(aes(xmin = 16,
                  xmax = 21,
                  ymin = -Inf,
                  ymax = Inf,
                  fill = "Throttle and Rebate"),alpha = 0.01) +
      scale_x_continuous(limits = c(0,24),breaks = c(0:24), expand = c(0,0)) +
      scale_fill_manual('Interventions', values = c("Discount" = 'green',"Throttle" = 'red1', "Rebate" = 'yellow1', "Throttle and Rebate" = "#C7B19C"),  guide = guide_legend(override.aes = list(alpha = 0.1))) +
      theme(legend.position = "bottom") +
      scale_color_manual('Demand', values = c("Scaled Baseline Demand" = "red3", "Event Demand" ="dodgerblue2"))

#Potential_Graph25 <- Demand_Graph25 +
#geom_line(aes(y=Theoretical_Max))

Demand_Graph25
ggsave("Event Graphs/Aug_30_18_DC_Event_Usage.png", Demand_Graph25, device = "png", width = 8, height = 4.5)


#COST
Cost_Table25 <- Aug_30_18_DC_scaled_baseline$EV_Demand[c("Hr","X0","P0","Event_Usage","P1")] %>% 
  mutate(Cost0 = X0*P0) %>% 
  mutate(Cost1 = Event_Usage*P1) %>% 
  mutate(Cost_diff = Cost1-Cost0)
#View(Cost_Table25)


#Emissions Results
#View(Aug_30_18_DC_scaled_baseline$EV_Demand)
write_csv(Aug_30_18_DC_scaled_baseline$EV_Demand, "Event Results/DC_Aug_30_18_Demand_Summary.csv")
Aug_30_18_DC_output_table <- emissions_fcn_event(Aug_30_18_DC_scaled_baseline$EV_Demand, intervention_hours = c(17:21)) 
write_csv(Aug_30_18_DC_output_table$Emissions_Table, "Event Results/DC_Aug_30_18_Output_Summary.csv") #write emissions to csv
write_csv(Aug_30_18_DC_output_table$Emissions, "Event Results/DC_Aug_30_18_Output_All_Hours.csv")
```


#Scenario 26- July 31, 2018 DC EVENT + Baseline (scaled for 172 chargers) 

Event: Destination Center, July 31, 2018, TOU EV-4, $0.10 Rebate (4-9PM), 50% Throttling (4-9 PM)

```{r Scenario 26}

#Scaled Baseline and July 31 event usage

#CHARGERS
Jul_31_18_DC_event <- Event_Chargers %>%
filter(Market_Segment=="DC") %>%
select(Jul_31_18_LR) %>%
unlist()


Jul_31_18_DC_scaled_baseline <- hourly_demand(
                    month = 7,
                    year= 2018,
                    seg =  "Destination Center",
                    intervention_chargers =
                   Jul_31_18_DC_event,
                    int_equals_baseline = FALSE,
                   include_wknds = FALSE)



Jul_31_18_DC_Event_Usage <- filter(event_data, Date == "2018-7-31" & segment == "Destination Center") %>%
select(Demand) %>%
unlist() 

Jul_31_18_DC_scaled_baseline$EV_Demand <- Jul_31_18_DC_scaled_baseline$EV_Demand %>%
  mutate(Event_Usage = Jul_31_18_DC_Event_Usage)


graph_table26 <- Jul_31_18_DC_scaled_baseline$EV_Demand[c("Hr","X0","Event_Usage")] #%>%
  #gather(condition,value,c("X0","Event_Usage")) %>%
  #mutate(Theoretical_Max=Jul_31_18_DC_scaled_baseline$EV_Demand$MT[1])

hr_24<- graph_table26[24,]
hr_24[1,1] <- 0
graph_table26 <- rbind(hr_24,graph_table26)

Demand_Graph26 <- ggplot(data = graph_table26, aes(x = Hr)) +
  geom_line(aes(x = Hr, 
                  y = Event_Usage, 
                  color = "Event Demand"), 
                  size = 0.9, 
                  alpha = 0.75) + #This is the Xf line
    geom_line(aes(x = Hr,
                  y = X0,
                  color = "Scaled Baseline Demand"),
                  size = 0.9, 
                  alpha = 0.75) + #This is the X0 line
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +
      xlab("Hour of the Day") +
      ylab("Electricity Demand (kW)") +
  geom_rect(aes(xmin = 16,
                  xmax = 21,
                  ymin = -Inf,
                  ymax = Inf,
                  fill = "Throttle and Rebate"),alpha = 0.01) + #this is the throttle + rebate rectangle REMOVE IF NO THROTTLING + REBATE
      scale_x_continuous(limits = c(0,24),breaks = c(0:24), expand = c(0,0)) +
      scale_fill_manual('Interventions', values = c("Discount" = 'green',"Throttle" = 'red1', "Rebate" = 'yellow1', "Throttle and Rebate" = "#C7B19C"),  guide = guide_legend(override.aes = list(alpha = 0.1))) +
      theme(legend.position = "bottom") +
      scale_color_manual('Demand', values = c("Scaled Baseline Demand" = "red3", "Event Demand" ="dodgerblue2"))

#Potential_Graph26 <- Demand_Graph26 +
#geom_line(aes(y=Theoretical_Max))

Demand_Graph26
ggsave("Event Graphs/Jul_31_18_DC_Event_Usage.png", Demand_Graph26, device = "png", width = 8, height = 4.5)

#COST
Cost_Table26 <- Jul_31_18_DC_scaled_baseline$EV_Demand[c("Hr","X0","P0","Event_Usage","P1")] %>% 
  mutate(Cost0 = X0*P0) %>% 
  mutate(Cost1 = Event_Usage*P1) %>% 
  mutate(Cost_diff = Cost1-Cost0)
#View(Cost_Table26)

#Emissions Results
#View(Jul_31_18_DC_scaled_baseline$EV_Demand)
write_csv(Jul_31_18_DC_scaled_baseline$EV_Demand, "Event Results/DC_Jul_31_18_Demand_Summary.csv")
Jul_31_18_DC_output_table <- emissions_fcn_event(Jul_31_18_DC_scaled_baseline$EV_Demand, intervention_hours = c(17:21)) 
write_csv(Jul_31_18_DC_output_table$Emissions_Table, "Event Results/DC_Jul_31_18_Output_Summary.csv") #write emissions to csv
write_csv(Jul_31_18_DC_output_table$Emissions, "Event Results/DC_Jul_31_18_Output_All_Hours.csv")
```



#Scenario 27 - July 11, 2018 DC EVENT + Baseline (scaled for 146 chargers) 

Event: Destination Center, July 11, 2018, TOU EV-4, $0.10 Rebate (4-9PM)

```{r Scenario 28}

#Scaled Baseline and July 11 event usage

#CHARGERS
Jul_11_18_DC_event <- Event_Chargers %>%
filter(Market_Segment=="DC") %>%
select(Jul_11_18_LR) %>%
unlist()


Jul_11_18_DC_scaled_baseline <- hourly_demand(
                    month = 7,
                    year= 2018,
                    seg =  "Destination Center",
                    intervention_chargers =
                    Jul_11_18_DC_event,
                    int_equals_baseline = FALSE,
                    include_wknds = FALSE)



Jul_11_18_DC_Event_Usage <- filter(event_data, Date == "2018-7-11" & segment == "Destination Center") %>%
select(Demand) %>%
unlist() 

Jul_11_18_DC_scaled_baseline$EV_Demand <- Jul_11_18_DC_scaled_baseline$EV_Demand %>%
  mutate(Event_Usage = Jul_11_18_DC_Event_Usage)


graph_table27 <- Jul_11_18_DC_scaled_baseline$EV_Demand[c("Hr","X0","Event_Usage")] #%>%
  #gather(condition,value,c("X0","Event_Usage")) %>%
  #mutate(Theoretical_Max=Jul_11_18_DC_scaled_baseline$EV_Demand$MT[1])

hr_24<- graph_table27[24,]
hr_24[1,1] <- 0
graph_table27 <- rbind(hr_24,graph_table27)

Demand_Graph27 <- ggplot(data = graph_table27, aes(x = Hr)) +
  geom_line(aes(x = Hr, 
                  y = Event_Usage, 
                  color = "Event Demand"), 
                  size = 0.9, 
                  alpha = 0.75) + #This is the Xf line
  geom_line(aes(x = Hr,
                  y = X0,
                  color = "Scaled Baseline Demand"),
                  size = 0.9, 
                  alpha = 0.75) + #This is the X0 line
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +
      xlab("Hour of the Day") +
      ylab("Electricity Demand (kW)") +
  geom_rect(aes(xmin = 16,
                  xmax = 21,
                  ymin = -Inf,
                  ymax = Inf,
                  fill = "Throttle and Rebate"),alpha = 0.01) +
      scale_x_continuous(limits = c(0,24),breaks = c(0:24), expand = c(0,0)) +
      scale_fill_manual('Interventions', values = c("Discount" = 'green',"Throttle" = 'red1', "Rebate" = 'yellow1', "Throttle and Rebate" = "#C7B19C"),  guide = guide_legend(override.aes = list(alpha = 0.1))) +
      theme(legend.position = "bottom") +
      scale_color_manual('Demand', values = c("Scaled Baseline Demand" = "red3", "Event Demand" ="dodgerblue2"))

#Potential_Graph27 <- Demand_Graph27 +
#geom_line(aes(y=Theoretical_Max))

Demand_Graph27
ggsave("Event Graphs/Jul_11_18_DC_Event_Usage.png", Demand_Graph27, device = "png", width = 8, height = 4.5) 

#COST
Cost_Table27 <- Jul_11_18_DC_scaled_baseline$EV_Demand[c("Hr","X0","P0","Event_Usage","P1")] %>% 
  mutate(Cost0 = X0*P0) %>% 
  mutate(Cost1 = Event_Usage*P1) %>% 
  mutate(Cost_diff = Cost1-Cost0)
#View(Cost_Table27)


#Emissions Results
#View(Jul_11_18_DC_scaled_baseline$EV_Demand)
write_csv(Jul_11_18_DC_scaled_baseline$EV_Demand, "Event Results/DC_Jul_11_18_Demand_Summary.csv")
Jul_11_18_DC_output_table <- emissions_fcn_event(Jul_11_18_DC_scaled_baseline$EV_Demand, intervention_hours = c(17:21)) 
write_csv(Jul_11_18_DC_output_table$Emissions_Table, "Event Results/DC_Jul_11_18_Output_Summary.csv") #write emissions to csv
write_csv(Jul_11_18_DC_output_table$Emissions, "Event Results/DC_Jul_11_18_Output_All_Hours.csv")

```


~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
FLEET
#Scenario 44 - NOVEMBER 28, 2018 Fleet EVENT + Baseline (scaled for 74 chargers) 

Event: Fleet, November 28, 2018, TOU EV-4, $0.05 Discount (Load shift)

```{r Scenario 44}

#Scaled Baseline and November 28 event usage

#CHARGERS
Nov_28_18_Fleet_event <- Event_Chargers %>%
filter(Market_Segment=="Fleet") %>%
select(Nov_28_18_LS) %>%
unlist()


Nov_28_18_Fleet_scaled_baseline <- hourly_demand(
                    month = 11,
                    year= 2018,
                    seg =  "Fleet",
                    intervention_chargers =
                   Nov_28_18_Fleet_event,
                    int_equals_baseline = FALSE,
                   include_wknds = FALSE)



Nov_28_18_Fleet_Event_Usage <- filter(event_data, Date == "2018-11-28" & segment == "Fleet") %>%
select(Demand) %>%
unlist() 

Nov_28_18_Fleet_scaled_baseline$EV_Demand <- Nov_28_18_Fleet_scaled_baseline$EV_Demand %>%
  mutate(Event_Usage = Nov_28_18_Fleet_Event_Usage)


graph_table44 <- Nov_28_18_Fleet_scaled_baseline$EV_Demand[c("Hr","X0","Event_Usage")] %>%
  gather(condition,value,c("X0","Event_Usage")) %>%
  mutate(Theoretical_Max=Nov_28_18_Fleet_scaled_baseline$EV_Demand$MT[1])


Demand_Graph44 <- ggplot(data = graph_table44, aes(x = Hr)) +
  geom_line(aes(y = value, color=condition)) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
  panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  labs(title="Fleet Hourly Demand Forecast",
  subtitle="November 2018 Baseline Scaled for November 28, 2018 Event (74 Chargers) \n November 28, 2018 Event Usage (Load Shift)",
  y="EV Charging Demand (kW)",
  x="Hour",
  color=NULL) +
  geom_rect(aes(xmin=6,xmax=11,ymin=-Inf,ymax=Inf,fill="Throttle"),alpha=0.0075) +
  geom_rect(aes(xmin=11,xmax=15,ymin=-Inf,ymax=Inf, fill = "Discount"),alpha=0.0075) +
  scale_x_continuous(breaks = 1:24, limits = c(1,24), expand = c(0, 0)) +
  scale_color_manual(labels=c("Event Demand","Scaled Baseline Demand"), values = c("blue", "purple")) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.subtitle = element_text(hjust = 0.5))+
  theme(legend.position="bottom") +
  scale_fill_manual('Interventions',values = c('green','yellow'),  guide = guide_legend(override.aes = list(alpha = 0.15)))
  

Potential_Graph44 <- Demand_Graph44 +
geom_line(aes(y=Theoretical_Max))

Demand_Graph44

ggsave("Event Graphs/Nov_28_18_Fleet_Event_Usage.png", Demand_Graph44, device = "png", width = 8, height = 4.5)

#COST
Cost_Table44 <- Nov_28_18_Fleet_scaled_baseline$EV_Demand[c("Hr","X0","P0","Event_Usage","P1")] %>% 
  mutate(Cost0 = X0*P0) %>% 
  mutate(Cost1 = Event_Usage*P1) %>% 
  mutate(Cost_diff = Cost1-Cost0)
#View(Cost_Table44)



#Emissions Results
#View(Jul_11_18_DC_scaled_baseline$EV_Demand)
write_csv(Nov_28_18_Fleet_scaled_baseline$EV_Demand, "Event Results/Fleet_Nov_28_18_Demand_Summary.csv")
Nov_28_18_Fleet_output_table <- emissions_fcn_event(Nov_28_18_Fleet_scaled_baseline$EV_Demand, intervention_hours = c(12:15)) 
write_csv(Nov_28_18_Fleet_output_table$Emissions_Table, "Event Results/Fleet_Nov_28_18_Output_Summary.csv") #write emissions to csv
write_csv(Nov_28_18_Fleet_output_table$Emissions, "Event Results/Fleet_Nov_28_18_Output_All_Hours.csv")
```

#Scenario 28 - Nov 14, 2018 Fleet EVENT + Baseline (scaled for 68 chargers) 

Event: Fleet, Nov 14, 2018, TOU EV-4, $0.05 Discount (11AM-3PM)

```{r Scenario 27=8}

#Scaled Baseline and November 14 event usage

#CHARGERS
Nov_14_18_Fleet_event <- Event_Chargers %>%
filter(Market_Segment=="Fleet") %>%
select(Nov_14_18_LS) %>%
unlist()


Nov_14_18_Fleet_scaled_baseline <- hourly_demand(
                    month = 11,
                    year= 2018,
                    seg =  "Fleet",
                    intervention_chargers =
                   Nov_14_18_Fleet_event,
                    int_equals_baseline = FALSE,
                   include_wknds = FALSE)



Nov_14_18_Fleet_Event_Usage <- filter(event_data, Date == "2018-11-14" & segment == "Fleet") %>%
select(Demand) %>%
unlist() 

Nov_14_18_Fleet_scaled_baseline$EV_Demand <- Nov_14_18_Fleet_scaled_baseline$EV_Demand %>%
  mutate(Event_Usage = Nov_14_18_Fleet_Event_Usage)


graph_table28 <- Nov_14_18_Fleet_scaled_baseline$EV_Demand[c("Hr","X0","Event_Usage")] %>%
  gather(condition,value,c("X0","Event_Usage")) %>%
  mutate(Theoretical_Max=Nov_14_18_Fleet_scaled_baseline$EV_Demand$MT[1])


Demand_Graph28 <- ggplot(data = graph_table28, aes(x = Hr)) +
  geom_line(aes(y = value, color=condition)) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
  panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  labs(title="November 14, 2018 Event Hourly Demand Forecast",
  subtitle="November 2018 Baseline Scaled for Nov 14, 2018 Event (68 chargers) \n November 14, 2018 Event Usage (Load Shift)",
  y="EV Charging Demand (kW)",
  x="Hour",
  color=NULL) +
  geom_rect(aes(xmin=6,xmax=11,ymin=-Inf,ymax=Inf,fill="Throttle"),alpha=0.0075) +
  geom_rect(aes(xmin=11,xmax=15,ymin=-Inf,ymax=Inf, fill = "Discount"),alpha=0.0075) +
  scale_x_continuous(breaks = 1:24, limits = c(1,24), expand = c(0, 0)) +
  scale_color_manual(labels=c("Event Demand","Scaled Baseline Demand"), values = c("blue", "purple")) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.subtitle = element_text(hjust = 0.5))+
  theme(legend.position="bottom") +
  scale_fill_manual('Interventions',values = c('green','yellow'),  guide = guide_legend(override.aes = list(alpha = 0.15)))
  

Potential_Graph28 <- Demand_Graph28 +
geom_line(aes(y=Theoretical_Max))

Demand_Graph28

ggsave("Event Graphs/Nov_14_18_Fleet_Event_Usage.png", Demand_Graph28, device = "png", width = 8, height = 4.5)

#COST
Cost_Table28 <- Nov_14_18_Fleet_scaled_baseline$EV_Demand[c("Hr","X0","P0","Event_Usage","P1")] %>% 
  mutate(Cost0 = X0*P0) %>% 
  mutate(Cost1 = Event_Usage*P1) %>% 
  mutate(Cost_diff = Cost1-Cost0)
#View(Cost_Table28)




#Emissions Results
#View(Nov_14_18_Fleet_scaled_baseline$EV_Demand)
write_csv(Nov_14_18_Fleet_scaled_baseline$EV_Demand, "Event Results/Fleet_Nov_14_18_Demand_Summary.csv")
Nov_14_18_Fleet_output_table <- emissions_fcn_event(Nov_14_18_Fleet_scaled_baseline$EV_Demand, intervention_hours = c(12:15)) 
write_csv(Nov_14_18_Fleet_output_table$Emissions_Table, "Event Results/Fleet_Nov_14_18_Output_Summary.csv") #write emissions to csv
write_csv(Nov_14_18_Fleet_output_table$Emissions, "Event Results/Fleet_Nov_14_18_Output_All_Hours.csv")
```

#Scenario 29 - Oct 30, 2018 Fleet EVENT + Baseline (scaled for 67 chargers) 

Event: Fleet, Oct 30, 2018, TOU EV-4, $0.05 Discount (11AM-3PM)

```{r Scenario 29}

#Scaled Baseline and October 30 event usage

#CHARGERS
Oct_30_18_Fleet_event <- Event_Chargers %>%
filter(Market_Segment=="Fleet") %>%
select(Oct_30_18_LS) %>%
unlist()


Oct_30_18_Fleet_scaled_baseline <- hourly_demand(
                    month = 10,
                    year= 2018,
                    seg =  "Fleet",
                    intervention_chargers =
                   Oct_30_18_Fleet_event,
                    int_equals_baseline = FALSE,
                   include_wknds = FALSE)



Oct_30_18_Fleet_Event_Usage <- filter(event_data, Date == "2018-10-30" & segment == "Fleet") %>%
select(Demand) %>%
unlist() 

Oct_30_18_Fleet_scaled_baseline$EV_Demand <- Oct_30_18_Fleet_scaled_baseline$EV_Demand %>%
  mutate(Event_Usage = Oct_30_18_Fleet_Event_Usage)


graph_table29 <- Oct_30_18_Fleet_scaled_baseline$EV_Demand[c("Hr","X0","Event_Usage")] %>%
  gather(condition,value,c("X0","Event_Usage")) %>%
  mutate(Theoretical_Max=Oct_30_18_Fleet_scaled_baseline$EV_Demand$MT[1])


Demand_Graph29 <- ggplot(data = graph_table29, aes(x = Hr)) +
  geom_line(aes(y = value, color=condition)) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
  panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  labs(title="October 30, 2018 Event Hourly Demand Forecast",
  subtitle="October 2018 Baseline Scaled for Oct 30, 2018 Event (67 chargers) \n October 30, 2018 Event Usage (Load Shift)",
  y="EV Charging Demand (kW)",
  x="Hour",
  color=NULL) +
  geom_rect(aes(xmin=6,xmax=11,ymin=-Inf,ymax=Inf,fill="Throttle"),alpha=0.0075) +
  geom_rect(aes(xmin=11,xmax=15,ymin=-Inf,ymax=Inf, fill = "Discount"),alpha=0.0075) +
  scale_x_continuous(breaks = 1:24, limits = c(1,24), expand = c(0, 0)) +
  scale_color_manual(labels=c("Event Demand","Scaled Baseline Demand"), values = c("blue", "purple")) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.subtitle = element_text(hjust = 0.5))+
  theme(legend.position="bottom") +
  scale_fill_manual('Interventions',values = c('green','yellow'),  guide = guide_legend(override.aes = list(alpha = 0.15)))
  

Potential_Graph29 <- Demand_Graph29 +
geom_line(aes(y=Theoretical_Max))

Demand_Graph29

ggsave("Event Graphs/Oct_30_18_Fleet_Event_Usage.png", Demand_Graph29, device = "png", width = 8, height = 4.5)

#COST
Cost_Table29 <- Oct_30_18_Fleet_scaled_baseline$EV_Demand[c("Hr","X0","P0","Event_Usage","P1")] %>% 
  mutate(Cost0 = X0*P0) %>% 
  mutate(Cost1 = Event_Usage*P1) %>% 
  mutate(Cost_diff = Cost1-Cost0)
#View(Cost_Table29)



#Emissions Results
#View(Oct_30_18_Fleet_scaled_baseline$EV_Demand)
write_csv(Oct_30_18_Fleet_scaled_baseline$EV_Demand, "Event Results/Fleet_Oct_30_18_Demand_Summary.csv")
Oct_30_18_Fleet_output_table <- emissions_fcn_event(Oct_30_18_Fleet_scaled_baseline$EV_Demand, intervention_hours = c(12:15)) 
write_csv(Oct_30_18_Fleet_output_table$Emissions_Table, "Event Results/Fleet_Oct_30_18_Output_Summary.csv") #write emissions to csv
write_csv(Oct_30_18_Fleet_output_table$Emissions, "Event Results/Fleet_Oct_30_18_Output_All_Hours.csv")
```

#Scenario 30 - October 16, 2018 Fleet EVENT + Baseline (scaled for 83 chargers) 

Event: Fleet, Oct 16, 2018, TOU EV-4, $0.05 Discount (11AM-3PM)

```{r Scenario 27}

#Scaled Baseline and Oct 16 event usage

#CHARGERS
Oct_16_18_Fleet_event <- Event_Chargers %>%
filter(Market_Segment=="Fleet") %>%
select(Oct_16_18_LS) %>%
unlist()


Oct_16_18_Fleet_scaled_baseline <- hourly_demand(
                    month = 10,
                    year= 2018,
                    seg =  "Fleet",
                    intervention_chargers =
                   Oct_16_18_Fleet_event,
                    int_equals_baseline = FALSE,
                   include_wknds = FALSE)



Oct_16_18_Fleet_Event_Usage <- filter(event_data, Date == "2018-10-16" & segment == "Fleet") %>%
select(Demand) %>%
unlist() 

Oct_16_18_Fleet_scaled_baseline$EV_Demand <- Oct_16_18_Fleet_scaled_baseline$EV_Demand %>%
  mutate(Event_Usage = Oct_16_18_Fleet_Event_Usage)


graph_table30 <- Oct_16_18_Fleet_scaled_baseline$EV_Demand[c("Hr","X0","Event_Usage")] %>%
  gather(condition,value,c("X0","Event_Usage")) %>%
  mutate(Theoretical_Max=Oct_16_18_Fleet_scaled_baseline$EV_Demand$MT[1])


Demand_Graph30 <- ggplot(data = graph_table30, aes(x = Hr)) +
  geom_line(aes(y = value, color=condition)) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
  panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  labs(title="Destination Center Hourly Demand Forecast",
  subtitle="October 2018 Baseline Scaled for July 31, 2018 Event (83 Chargers) \n October 16, 2018 Event Usage (Load Shift)",
  y="EV Charging Demand (kW)",
  x="Hour",
  color=NULL) +
  geom_rect(aes(xmin=6,xmax=11,ymin=-Inf,ymax=Inf,fill="Throttle"),alpha=0.0075) +
  geom_rect(aes(xmin=11,xmax=15,ymin=-Inf,ymax=Inf, fill = "Discount"),alpha=0.0075) +
  scale_x_continuous(breaks = 1:24, limits = c(1,24), expand = c(0, 0)) +
  scale_color_manual(labels=c("Event Demand","Scaled Baseline Demand"), values = c("blue", "purple")) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.subtitle = element_text(hjust = 0.5))+
  theme(legend.position="bottom") +
  scale_fill_manual('Interventions',values = c('green','yellow'),  guide = guide_legend(override.aes = list(alpha = 0.15)))
  

Potential_Graph30 <- Demand_Graph30 +
geom_line(aes(y=Theoretical_Max))

Demand_Graph30

ggsave("Event Graphs/Oct_16_18_Fleet_Event_Usage.png", Demand_Graph28, device = "png", width = 8, height = 4.5)

#COST
Cost_Table30 <- Oct_16_18_Fleet_scaled_baseline$EV_Demand[c("Hr","X0","P0","Event_Usage","P1")] %>% 
  mutate(Cost0 = X0*P0) %>% 
  mutate(Cost1 = Event_Usage*P1) %>% 
  mutate(Cost_diff = Cost1-Cost0)
#View(Cost_Table30)



#Emissions Results
#View(Oct_16_18_Fleet_scaled_baseline$EV_Demand)
write_csv(Oct_16_18_Fleet_scaled_baseline$EV_Demand, "Event Results/Fleet_Oct_16_18_Demand_Summary.csv")
Oct_16_18_Fleet_output_table <- emissions_fcn_event(Oct_16_18_Fleet_scaled_baseline$EV_Demand, intervention_hours = c(12:15)) 
write_csv(Oct_16_18_Fleet_output_table$Emissions_Table, "Event Results/Fleet_Oct_16_18_Output_Summary.csv") #write emissions to csv
write_csv(Oct_16_18_Fleet_output_table$Emissions, "Event Results/Fleet_Oct_16_18_Output_All_Hours.csv")
```

#Scenario 31 - September 27, 2018 Fleet EVENT + Baseline (scaled for 24 chargers) 

Event: Fleet, September 27, 2018, TOU EV-4, $0.10 Rebate (4PM-9PM)

```{r Scenario 27}

#Scaled Baseline and Sep 27th event usage

#CHARGERS
Sep_27_18_Fleet_event <- Event_Chargers %>%
filter(Market_Segment=="Fleet") %>%
select(Sep_27_18_LR) %>%
unlist()


Sep_27_18_Fleet_scaled_baseline <- hourly_demand(
                    month = 9,
                    year= 2018,
                    seg =  "Fleet",
                    intervention_chargers =
                   Sep_27_18_Fleet_event,
                    int_equals_baseline = FALSE,
                   include_wknds = FALSE)



Sep_27_18_Fleet_Event_Usage <- filter(event_data, Date == "2018-9-27" & segment == "Fleet") %>%
select(Demand) %>%
unlist() 

Sep_27_18_Fleet_scaled_baseline$EV_Demand <- Sep_27_18_Fleet_scaled_baseline$EV_Demand %>%
  mutate(Event_Usage = Sep_27_18_Fleet_Event_Usage)


graph_table31 <- Sep_27_18_Fleet_scaled_baseline$EV_Demand[c("Hr","X0","Event_Usage")] %>%
  gather(condition,value,c("X0","Event_Usage")) %>%
  mutate(Theoretical_Max=Sep_27_18_Fleet_scaled_baseline$EV_Demand$MT[1])


Demand_Graph31 <- ggplot(data = graph_table31, aes(x = Hr)) +
  geom_line(aes(y = value, color=condition)) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
  panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  labs(title="Fleet Hourly Demand Forecast",
  subtitle="September 2018 Baseline Scaled for September 27, 2018 Event (24 chargers) \n September 27, 2018 Event Usage (Load Reduction)",
  y="EV Charging Demand (kW)",
  x="Hour",
  color=NULL) +
  geom_rect(aes(xmin=16,xmax=21,ymin=-Inf,ymax=Inf,fill="Throttle"),alpha=0.0075) +
  geom_rect(aes(xmin=16,xmax=21,ymin=-Inf,ymax=Inf, fill = "Rebate"),alpha=0.0075) +
  scale_x_continuous(breaks = 1:24, limits = c(1,24), expand = c(0, 0)) +
  scale_color_manual(labels=c("Event Demand","Scaled Baseline Demand"), values = c("blue", "purple")) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.subtitle = element_text(hjust = 0.5))+
  theme(legend.position="bottom") +
  scale_fill_manual('Interventions',values = c('green','yellow'),  guide = guide_legend(override.aes = list(alpha = 0.15)))
  

Potential_Graph31 <- Demand_Graph31 +
geom_line(aes(y=Theoretical_Max))

Demand_Graph31

ggsave("Event Graphs/Sep_27_18_Fleet_Event_Usage.png", Demand_Graph31, device = "png", width = 8, height = 4.5)

#COST
Cost_Table31 <- Sep_27_18_Fleet_scaled_baseline$EV_Demand[c("Hr","X0","P0","Event_Usage","P1")] %>% 
  mutate(Cost0 = X0*P0) %>% 
  mutate(Cost1 = Event_Usage*P1) %>% 
  mutate(Cost_diff = Cost1-Cost0)
#View(Cost_Table31)



#Emissions Results
#View(Sep_27_18_Fleet_scaled_baseline$EV_Demand)
write_csv(Sep_27_18_Fleet_scaled_baseline$EV_Demand, "Event Results/Fleet_Sep_27_18_Demand_Summary.csv")
Sep_27_18_Fleet_output_table <- emissions_fcn_event(Sep_27_18_Fleet_scaled_baseline$EV_Demand, intervention_hours = c(17:21)) 
write_csv(Sep_27_18_Fleet_output_table$Emissions_Table, "Event Results/Fleet_Sep_27_18_Output_Summary.csv") #write emissions to csv
write_csv(Sep_27_18_Fleet_output_table$Emissions, "Event Results/Fleet_Sep_27_18_Output_All_Hours.csv")
```
#Scenario 32 - August 30, 2018 Fleet EVENT + Baseline (scaled for X chargers) 

Event: Fleet, August 30, 2018, TOU EV-4, $0.10 Rebate (4PM-9PM)

```{r Scenario 27}

#Scaled Baseline and Aug 30 event usage

#CHARGERS
Aug_30_18_Fleet_event <- Event_Chargers %>%
filter(Market_Segment=="Fleet") %>%
select(Aug_30_18_LR) %>%
unlist()


Aug_30_18_Fleet_scaled_baseline <- hourly_demand(
                    month = 8,
                    year= 2018,
                    seg =  "Fleet",
                    intervention_chargers =
                   Aug_30_18_Fleet_event,
                    int_equals_baseline = FALSE,
                   include_wknds = FALSE)



Aug_30_18_Fleet_Event_Usage <- filter(event_data, Date == "2018-8-30" & segment == "Fleet") %>%
select(Demand) %>%
unlist() 

Aug_30_18_Fleet_scaled_baseline$EV_Demand <- Aug_30_18_Fleet_scaled_baseline$EV_Demand %>%
  mutate(Event_Usage = Aug_30_18_Fleet_Event_Usage)


graph_table32 <- Aug_30_18_Fleet_scaled_baseline$EV_Demand[c("Hr","X0","Event_Usage")] %>%
  gather(condition,value,c("X0","Event_Usage")) %>%
  mutate(Theoretical_Max=Aug_30_18_Fleet_scaled_baseline$EV_Demand$MT[1])


Demand_Graph32 <- ggplot(data = graph_table32, aes(x = Hr)) +
  geom_line(aes(y = value, color=condition)) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
  panel.background = element_blank(), axis.line = element_line(colour = "black")) +
  labs(title="Fleet Hourly Demand Forecast",
  subtitle="August 2018 Baseline Scaled for August 30, 2018 Event (10 chargers) \n August 30, 2018 Event Usage (Load Reduction)",
  y="EV Charging Demand (kW)",
  x="Hour",
  color=NULL) +
  geom_rect(aes(xmin=16,xmax=21,ymin=-Inf,ymax=Inf,fill="Throttle"),alpha=0.0075) +
  geom_rect(aes(xmin=16,xmax=21,ymin=-Inf,ymax=Inf, fill = "Rebate"),alpha=0.0075) +
  scale_x_continuous(breaks = 1:24, limits = c(1,24), expand = c(0, 0)) +
  scale_color_manual(labels=c("Event Demand","Scaled Baseline Demand"), values = c("blue", "purple")) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.subtitle = element_text(hjust = 0.5))+
  theme(legend.position="bottom") +
  scale_fill_manual('Interventions',values = c('green','yellow'),  guide = guide_legend(override.aes = list(alpha = 0.15)))
  

Potential_Graph32 <- Demand_Graph32 +
geom_line(aes(y=Theoretical_Max))

Demand_Graph32

ggsave("Event Graphs/Aug_30_18_Fleet_Event_Usage.png", Demand_Graph32, device = "png", width = 8, height = 4.5)

#COST
Cost_Table32 <- Aug_30_18_Fleet_scaled_baseline$EV_Demand[c("Hr","X0","P0","Event_Usage","P1")] %>% 
  mutate(Cost0 = X0*P0) %>% 
  mutate(Cost1 = Event_Usage*P1) %>% 
  mutate(Cost_diff = Cost1-Cost0)
#View(Cost_Table32)


#Emissions Results
#View(Aug_30_18_Fleet_scaled_baseline$EV_Demand)
write_csv(Aug_30_18_Fleet_scaled_baseline$EV_Demand, "Event Results/Fleet_Aug_30_18_Demand_Summary.csv")
Aug_30_18_Fleet_output_table <- emissions_fcn_event(Aug_30_18_Fleet_scaled_baseline$EV_Demand, intervention_hours = c(17:21)) 
write_csv(Aug_30_18_Fleet_output_table$Emissions_Table, "Event Results/Fleet_Aug_30_18_Output_Summary.csv") #write emissions to csv
write_csv(Aug_30_18_Fleet_output_table$Emissions, "Event Results/Fleet_Aug_30_18_Output_All_Hours.csv")

```

#Scenario 33 - July 31, 2018 Fleet EVENT + Baseline (scaled for 52 chargers) 

Event: Fleet, July 31, 2018, TOU EV-4, $0.10 Rebate (4PM-9PM)

```{r Scenario 27}

#Scaled Baseline and July 31 event usage

#CHARGERS
Jul_31_18_Fleet_event <- Event_Chargers %>%
filter(Market_Segment=="Fleet") %>%
select(Jul_31_18_LR) %>%
unlist()


Jul_31_18_Fleet_scaled_baseline <- hourly_demand(
                    month = 7,
                    year= 2018,
                    seg =  "Fleet",
                    intervention_chargers =
                   Jul_31_18_Fleet_event,
                    int_equals_baseline = FALSE,
                   include_wknds = FALSE)



Jul_31_18_Fleet_Event_Usage <- filter(event_data, Date == "2018-7-31" & segment == "Fleet") %>%
select(Demand) %>%
unlist() 

Jul_31_18_Fleet_scaled_baseline$EV_Demand <- Jul_31_18_Fleet_scaled_baseline$EV_Demand %>%
  mutate(Event_Usage = Jul_31_18_Fleet_Event_Usage)


graph_table33 <- Jul_31_18_Fleet_scaled_baseline$EV_Demand[c("Hr","X0","Event_Usage")] #%>%
  #gather(condition,value,c("X0","Event_Usage")) %>%
  #mutate(Theoretical_Max=Jul_31_18_Fleet_scaled_baseline$EV_Demand$MT[1])

hr_24<- graph_table33[24,]
hr_24[1,1] <- 0
graph_table33 <- rbind(hr_24,graph_table33)

Demand_Graph33 <- ggplot(data = graph_table33, aes(x = Hr)) +
  geom_line(aes(x = Hr, 
                  y = Event_Usage, 
                  color = "Event Demand"), 
                  size = 0.9, 
                  alpha = 0.75) + #This is the Xf line
    geom_line(aes(x = Hr,
                  y = X0,
                  color = "Scaled Baseline Demand"),
                  size = 0.9, 
                  alpha = 0.75) + #This is the X0 line
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +
      xlab("Hour of the Day") +
      ylab("Electricity Demand (kW)") +
  geom_rect(aes(xmin = 16,
                  xmax = 21,
                  ymin = -Inf,
                  ymax = Inf,
                  fill = "Throttle and Rebate"),alpha = 0.01) + #this is the throttle + rebate rectangle REMOVE IF NO THROTTLING + REBATE
      scale_x_continuous(limits = c(0,24),breaks = c(0:24), expand = c(0,0)) +
      scale_fill_manual('Interventions', values = c("Discount" = 'green',"Throttle" = 'red1', "Rebate" = 'yellow1', "Throttle and Rebate" = "#C7B19C"),  guide = guide_legend(override.aes = list(alpha = 0.1))) +
      theme(legend.position = "bottom") +
      scale_color_manual('Demand', values = c("Scaled Baseline Demand" = "red3", "Event Demand" ="dodgerblue2"))
  

#Potential_Graph33 <- Demand_Graph33 +
#geom_line(aes(y=Theoretical_Max))

Demand_Graph33
ggsave("Event Graphs/Jul_31_18_Fleet_Event_Usage.png", Demand_Graph33, device = "png", width = 8, height = 4.5)

# COPIED TEMPLATE BEGINNING
hr_24<- graph_tablePW1S[24,]
hr_24[1,1] <- 0
graph_tablePW1S <- rbind(hr_24,graph_tablePW1S)


Demand_GraphPW1S <- ggplot(data = graph_tablePW1S, aes(x = Hr)) +
    geom_line(aes(x = Hr, 
                  y = Event_Usage, 
                  color = "Event Demand"), 
                  size = 0.9, 
                  alpha = 0.75) + #This is the Xf line
    geom_line(aes(x = Hr,
                  y = X0,
                  color = "Scaled Baseline Demand"),
                  size = 0.9, 
                  alpha = 0.75) + #This is the X0 line
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +
      xlab("Hour of the Day") +
      ylab("Electricity Demand (kW)") +
    geom_rect(aes(xmin = 11,
                  xmax = 15,
                  ymin = -Inf,
                  ymax = Inf,
                  fill = "Discount"),alpha = 0.005) + #this is the discount rectangle REMOVE IF NO DISCOUNT
    geom_rect(aes(xmin = 6,
                  xmax = 11,
                  ymin = -Inf,
                  ymax = Inf,
                  fill = "Throttle"),alpha = 0.005) + #this is the throttle rectangle REMOVE IF NO THROTTLING
    geom_rect(aes(xmin = 16,
                  xmax = 21,
                  ymin = -Inf,
                  ymax = Inf,
                  fill = "Rebate"),alpha = 0.005) + #this is the rebate rectangle REMOVE IF NO REBATE
    geom_rect(aes(xmin = 16,
                  xmax = 21,
                  ymin = -Inf,
                  ymax = Inf,
                  fill = "Throttle and Rebate"),alpha = 0.01) + #this is the throttle + rebate rectangle REMOVE IF NO THROTTLING + REBATE
      scale_x_continuous(limits = c(0,24),breaks = c(0:24), expand = c(0,0)) +
      scale_fill_manual('Interventions', values = c("Discount" = 'green',"Throttle" = 'red1', "Rebate" = 'yellow1', "Throttle and Rebate" = "#C7B19C"),  guide = guide_legend(override.aes = list(alpha = 0.1))) +
      theme(legend.position = "bottom") +
      scale_color_manual('Demand', values = c("Scaled Baseline Demand" = "red3", "Event Demand" ="dodgerblue2"))
# COPIED TEMPLATE END

#COST
Cost_Table33 <- Jul_31_18_Fleet_scaled_baseline$EV_Demand[c("Hr","X0","P0","Event_Usage","P1")] %>% 
  mutate(Cost0 = X0*P0) %>% 
  mutate(Cost1 = Event_Usage*P1) %>% 
  mutate(Cost_diff = Cost1-Cost0)
#View(Cost_Table33)




#Emissions Results
#View(Jul_31_18_Fleet_scaled_baseline$EV_Demand)
write_csv(Jul_31_18_Fleet_scaled_baseline$EV_Demand, "Event Results/Fleet_Jul_31_18_Demand_Summary.csv")
Jul_31_18_Fleet_output_table <- emissions_fcn_event(Jul_31_18_Fleet_scaled_baseline$EV_Demand, intervention_hours = c(17:21)) 
write_csv(Jul_31_18_Fleet_output_table$Emissions_Table, "Event Results/Fleet_Jul_31_18_Output_Summary.csv") #write emissions to csv
write_csv(Jul_31_18_Fleet_output_table$Emissions, "Event Results/Fleet_Jul_31_18_Output_All_Hours.csv")
```

#Scenario 34 - July 11, 2018 Fleet EVENT + Baseline (scaled for 32 chargers) 

Event: Fleet, July 11, 2018, TOU EV-4, $0.10 Rebate (4PM-9PM)

```{r Scenario 27}

#Scaled Baseline and July 11 event usage

#CHARGERS
Jul_11_18_Fleet_event <- Event_Chargers %>%
filter(Market_Segment=="Fleet") %>%
select(Jul_11_18_LR) %>%
unlist()


Jul_11_18_Fleet_scaled_baseline <- hourly_demand(
                    month = 7,
                    year= 2018,
                    seg =  "Fleet",
                    intervention_chargers =
                   Jul_11_18_Fleet_event,
                    int_equals_baseline = FALSE,
                   include_wknds = FALSE)



Jul_11_18_Fleet_Event_Usage <- filter(event_data, Date == "2018-7-11" & segment == "Fleet") %>%
select(Demand) %>%
unlist() 

Jul_11_18_Fleet_scaled_baseline$EV_Demand <- Jul_11_18_Fleet_scaled_baseline$EV_Demand %>%
  mutate(Event_Usage = Jul_11_18_Fleet_Event_Usage)


graph_table34 <- Jul_11_18_Fleet_scaled_baseline$EV_Demand[c("Hr","X0","Event_Usage")] #%>%
  #gather(condition,value,c("X0","Event_Usage")) %>%
  #mutate(Theoretical_Max=Jul_31_18_Fleet_scaled_baseline$EV_Demand$MT[1])

hr_24<- graph_table34[24,]
hr_24[1,1] <- 0
graph_table34 <- rbind(hr_24,graph_table34)

Demand_Graph34 <- ggplot(data = graph_table34, aes(x = Hr)) +
  geom_line(aes(x = Hr, 
                  y = Event_Usage, 
                  color = "Event Demand"), 
                  size = 0.9, 
                  alpha = 0.75) + #This is the Xf line
    geom_line(aes(x = Hr,
                  y = X0,
                  color = "Scaled Baseline Demand"),
                  size = 0.9, 
                  alpha = 0.75) + #This is the X0 line
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +
      xlab("Hour of the Day") +
      ylab("Electricity Demand (kW)") +
  geom_rect(aes(xmin = 16,
                  xmax = 21,
                  ymin = -Inf,
                  ymax = Inf,
                  fill = "Throttle and Rebate"),alpha = 0.01) + #this is the throttle + rebate rectangle REMOVE IF NO THROTTLING + REBATE
      scale_x_continuous(limits = c(0,24),breaks = c(0:24), expand = c(0,0)) +
      scale_fill_manual('Interventions', values = c("Discount" = 'green',"Throttle" = 'red1', "Rebate" = 'yellow1', "Throttle and Rebate" = "#C7B19C"),  guide = guide_legend(override.aes = list(alpha = 0.1))) +
      theme(legend.position = "bottom") +
      scale_color_manual('Demand', values = c("Scaled Baseline Demand" = "red3", "Event Demand" ="dodgerblue2"))

#Potential_Graph34 <- Demand_Graph34 +
#geom_line(aes(y=Theoretical_Max))

Demand_Graph34
ggsave("Event Graphs/Jul_11_18_Fleet_Event_Usage.png", Demand_Graph34, device = "png", width = 8, height = 4.5)

#COST
Cost_Table34 <- Jul_11_18_Fleet_scaled_baseline$EV_Demand[c("Hr","X0","P0","Event_Usage","P1")] %>% 
  mutate(Cost0 = X0*P0) %>% 
  mutate(Cost1 = Event_Usage*P1) %>% 
  mutate(Cost_diff = Cost1-Cost0)
#View(Cost_Table34)


#Emissions Results
#View(Jul_11_18_Fleet_scaled_baseline$EV_Demand)
write_csv(Jul_11_18_Fleet_scaled_baseline$EV_Demand, "Event Results/Fleet_Jul_11_18_Demand_Summary.csv")
Jul_11_18_Fleet_output_table <- emissions_fcn_event(Jul_11_18_Fleet_scaled_baseline$EV_Demand, intervention_hours = c(17:21)) 
write_csv(Jul_11_18_Fleet_output_table$Emissions_Table, "Event Results/Fleet_Jul_11_18_Output_Summary.csv") #write emissions to csv
write_csv(Jul_11_18_Fleet_output_table$Emissions, "Event Results/Fleet_Jul_11_18_Output_All_Hours.csv")
```



MUD
~~~~~~~~~~~~~~~~


#Scenario 35 - November 28, 2018 MUD EVENT + Baseline (scaled for 10 chargers) 

Event: MUD, November 28, 2018, TOU EV-4, $0.05 Discount (11AM-3PM)

```{r Scenario 27}

#Scaled Baseline and November 28 event usage

#CHARGERS
Nov_28_18_MUD_event <- Event_Chargers %>%
filter(Market_Segment=="MUD") %>%
select(Nov_28_18_LS) %>%
unlist()


Nov_28_18_MUD_scaled_baseline <- hourly_demand(
                    month = 11,
                    year= 2018,
                    seg =  "Multi Unit Dwelling",
                    intervention_chargers =
                   Nov_28_18_MUD_event,
                    int_equals_baseline = FALSE,
                   include_wknds = FALSE)



Nov_28_18_MUD_Event_Usage <- filter(event_data, Date == "2018-11-28" & segment == "Multi Unit Dwelling") %>%
select(Demand) %>%
unlist() 

Nov_28_18_MUD_scaled_baseline$EV_Demand <- Nov_28_18_MUD_scaled_baseline$EV_Demand %>%
  mutate(Event_Usage = Nov_28_18_MUD_Event_Usage)


graph_table35 <- Nov_28_18_MUD_scaled_baseline$EV_Demand[c("Hr","X0","Event_Usage")] #%>%
  #gather(condition,value,c("X0","Event_Usage")) %>%
  #mutate(Theoretical_Max=Nov_28_18_MUD_scaled_baseline$EV_Demand$MT[1])

hr_24<- graph_table35[24,]
hr_24[1,1] <- 0
graph_table35 <- rbind(hr_24,graph_table35)

Demand_Graph35 <- ggplot(data = graph_table35, aes(x = Hr)) +
  geom_line(aes(x = Hr, 
                y = Event_Usage, 
                color = "Event Demand"), 
                size = 0.9, 
                alpha = 0.75) + #This is the Xf line
  geom_line(aes(x = Hr,
                y = X0,
                color = "Scaled Baseline Demand"),
                size = 0.9, 
                alpha = 0.75) + #This is the X0 line
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +
      xlab("Hour of the Day") +
      ylab("Electricity Demand (kW)") +
  geom_rect(aes(xmin = 11,
                xmax = 15,
                ymin = -Inf,
                ymax = Inf,
                fill = "Discount"),alpha = 0.005) +
  geom_rect(aes(xmin = 6,
                xmax = 11,
                ymin = -Inf,
                ymax = Inf,
                fill = "Throttle"),alpha = 0.005) +
  scale_x_continuous(limits = c(0,24),breaks = c(0:24), expand = c(0,0)) +
      scale_fill_manual('Interventions', values = c("Discount" = 'green',"Throttle" = 'red1', "Rebate" = 'yellow1', "Throttle and Rebate" = "#C7B19C"),  guide = guide_legend(override.aes = list(alpha = 0.1))) +
      theme(legend.position = "bottom") +
      scale_color_manual('Demand', values = c("Scaled Baseline Demand" = "red3", "Event Demand" ="dodgerblue2"))


#Potential_Graph35 <- Demand_Graph35 +
#geom_line(aes(y=Theoretical_Max))

Demand_Graph35
ggsave("Event Graphs/Nov_28_18_MUD_Event_Usage.png", Demand_Graph35, device = "png", width = 8, height = 4.5)

#COST
Cost_Table35 <- Nov_28_18_MUD_scaled_baseline$EV_Demand[c("Hr","X0","P0","Event_Usage","P1")] %>% 
  mutate(Cost0 = X0*P0) %>% 
  mutate(Cost1 = Event_Usage*P1) %>% 
  mutate(Cost_diff = Cost1-Cost0)
#View(Cost_Table35)


#Emissions Results
#View(Nov_28_18_MUD_scaled_baseline$EV_Demand)
write_csv(Nov_28_18_MUD_scaled_baseline$EV_Demand, "Event Results/MUD_Nov_28_18_Demand_Summary.csv")
Nov_28_18_MUD_output_table <- emissions_fcn_event(Nov_28_18_MUD_scaled_baseline$EV_Demand, intervention_hours = c(12:15)) 
write_csv(Nov_28_18_MUD_output_table$Emissions_Table, "Event Results/MUD_Nov_28_18_Output_Summary.csv") #write emissions to csv
write_csv(Nov_28_18_MUD_output_table$Emissions, "Event Results/MUD_Nov_28_18_Output_All_Hours.csv")
```

#Scenario 36 - November 14, 2018 MUD EVENT + Baseline (scaled for 10 chargers) 

Event: MUD, November 14, 2018, TOU EV-4, $0.05 Discount (11AM-3PM), 50% Throttling

```{r Scenario 36}

#Scaled Baseline and November 14 event usage

#CHARGERS
Nov_14_18_MUD_event <- Event_Chargers %>%
filter(Market_Segment=="MUD") %>%
select(Nov_14_18_LS) %>%
unlist()


Nov_14_18_MUD_scaled_baseline <- hourly_demand(
                    month = 11,
                    year= 2018,
                    seg =  "Multi Unit Dwelling",
                    intervention_chargers =
                   Nov_14_18_MUD_event,
                    int_equals_baseline = FALSE,
                   include_wknds = FALSE)



Nov_14_18_MUD_Event_Usage <- filter(event_data, Date == "2018-11-14" & segment == "Multi Unit Dwelling") %>%
select(Demand) %>%
unlist() 

Nov_14_18_MUD_scaled_baseline$EV_Demand <- Nov_14_18_MUD_scaled_baseline$EV_Demand %>%
  mutate(Event_Usage = Nov_14_18_MUD_Event_Usage)


graph_table36 <- Nov_14_18_MUD_scaled_baseline$EV_Demand[c("Hr","X0","Event_Usage")] #%>%
  #gather(condition,value,c("X0","Event_Usage")) %>%
  #mutate(Theoretical_Max=Nov_14_18_MUD_scaled_baseline$EV_Demand$MT[1])

hr_24<- graph_table36[24,]
hr_24[1,1] <- 0
graph_table36 <- rbind(hr_24,graph_table36)

Demand_Graph36 <- ggplot(data = graph_table36, aes(x = Hr)) +
  geom_line(aes(x = Hr, 
                y = Event_Usage, 
                color = "Event Demand"), 
                size = 0.9, 
                alpha = 0.75) + #This is the Xf line
  geom_line(aes(x = Hr,
                y = X0,
                color = "Scaled Baseline Demand"),
                size = 0.9, 
                alpha = 0.75) + #This is the X0 line
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +
      xlab("Hour of the Day") +
      ylab("Electricity Demand (kW)") +
  geom_rect(aes(xmin = 11,
                xmax = 15,
                ymin = -Inf,
                ymax = Inf,
                fill = "Discount"),alpha = 0.005) +
  geom_rect(aes(xmin = 6,
                xmax = 11,
                ymin = -Inf,
                ymax = Inf,
                fill = "Throttle"),alpha = 0.005) +
      scale_x_continuous(limits = c(0,24),breaks = c(0:24), expand = c(0,0)) +
      scale_fill_manual('Interventions', values = c("Discount" = 'green',"Throttle" = 'red1', "Rebate" = 'yellow1', "Throttle and Rebate" = "#C7B19C"),  guide = guide_legend(override.aes = list(alpha = 0.1))) +
      theme(legend.position = "bottom") +
      scale_color_manual('Demand', values = c("Scaled Baseline Demand" = "red3", "Event Demand" ="dodgerblue2"))

##Potential_Graph36 <- Demand_Graph36 +
#geom_line(aes(y=Theoretical_Max))

Demand_Graph36
ggsave("Event Graphs/Nov_14_18_MUD_Event_Usage.png", Demand_Graph36, device = "png", width = 8, height = 4.5)

#COST
Cost_Table35 <- Nov_14_18_MUD_scaled_baseline$EV_Demand[c("Hr","X0","P0","Event_Usage","P1")] %>% 
  mutate(Cost0 = X0*P0) %>% 
  mutate(Cost1 = Event_Usage*P1) %>% 
  mutate(Cost_diff = Cost1-Cost0)
#View(Cost_Table36)


#Emissions Results
#View(Nov_14_18_MUD_scaled_baseline$EV_Demand)
write_csv(Nov_14_18_MUD_scaled_baseline$EV_Demand, "Event Results/MUD_Nov_14_18_Demand_Summary.csv")
Nov_14_18_MUD_output_table <- emissions_fcn_event(Nov_14_18_MUD_scaled_baseline$EV_Demand, intervention_hours = c(12:15)) 
write_csv(Nov_14_18_MUD_output_table$Emissions_Table, "Event Results/MUD_Nov_14_18_Output_Summary.csv") #write emissions to csv
write_csv(Nov_14_18_MUD_output_table$Emissions, "Event Results/MUD_Nov_14_18_Output_All_Hours.csv")
```


#Scenario 37 - October 30, 2018 MUD EVENT + Baseline (scaled for X chargers) 

Event: MUD, October 30, 2018, TOU EV-4, $0.05 Discount (11AM-3PM)

```{r Scenario 37}

#Scaled Baseline and Octobr 30 event usage

#CHARGERS
Oct_30_18_MUD_event <- Event_Chargers %>%
filter(Market_Segment=="MUD") %>%
select(Oct_30_18_LS) %>%
unlist()


Oct_30_18_MUD_scaled_baseline <- hourly_demand(
                    month = 10,
                    year= 2018,
                    seg =  "Multi Unit Dwelling",
                    intervention_chargers =
                   Oct_30_18_MUD_event,
                    int_equals_baseline = FALSE,
                   include_wknds = FALSE)



Oct_30_18_MUD_Event_Usage <- filter(event_data, Date == "2018-10-30" & segment == "Multi Unit Dwelling") %>%
select(Demand) %>%
unlist() 


Oct_30_18_MUD_scaled_baseline$EV_Demand <- Oct_30_18_MUD_scaled_baseline$EV_Demand %>%
  mutate(Event_Usage = Oct_30_18_MUD_Event_Usage)


graph_table37 <- Oct_30_18_MUD_scaled_baseline$EV_Demand[c("Hr","X0","Event_Usage")] #%>%
  #gather(condition,value,c("X0","Event_Usage")) %>%
  #mutate(Theoretical_Max=Oct_30_18_MUD_scaled_baseline$EV_Demand$MT[1])

hr_24<- graph_table37[24,]
hr_24[1,1] <- 0
graph_table37 <- rbind(hr_24,graph_table37)

Demand_Graph37 <- ggplot(data = graph_table37, aes(x = Hr)) +
  geom_line(aes(x = Hr, 
                y = Event_Usage, 
                color = "Event Demand"), 
                size = 0.9, 
                alpha = 0.75) + #This is the Xf line
  geom_line(aes(x = Hr,
                y = X0,
                color = "Scaled Baseline Demand"),
                size = 0.9, 
                alpha = 0.75) + #This is the X0 line
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +
      xlab("Hour of the Day") +
      ylab("Electricity Demand (kW)") +
  geom_rect(aes(xmin = 11,
                xmax = 15,
                ymin = -Inf,
                ymax = Inf,
                fill = "Discount"),alpha = 0.005) +
  geom_rect(aes(xmin = 6,
                xmax = 11,
                ymin = -Inf,
                ymax = Inf,
                fill = "Throttle"),alpha = 0.005) +
      scale_x_continuous(limits = c(0,24),breaks = c(0:24), expand = c(0,0)) +
      scale_fill_manual('Interventions', values = c("Discount" = 'green',"Throttle" = 'red1', "Rebate" = 'yellow1', "Throttle and Rebate" = "#C7B19C"),  guide = guide_legend(override.aes = list(alpha = 0.1))) +
      theme(legend.position = "bottom") +
      scale_color_manual('Demand', values = c("Scaled Baseline Demand" = "red3", "Event Demand" ="dodgerblue2"))

#Potential_Graph37 <- Demand_Graph37 +
#geom_line(aes(y=Theoretical_Max))

Demand_Graph37
ggsave("Event Graphs/Oct_30_18_MUD_Event_Usage.png", Demand_Graph37, device = "png", width = 8, height = 4.5)

#COST
Cost_Table37 <- Oct_30_18_MUD_scaled_baseline$EV_Demand[c("Hr","X0","P0","Event_Usage","P1")] %>% 
  mutate(Cost0 = X0*P0) %>% 
  mutate(Cost1 = Event_Usage*P1) %>% 
  mutate(Cost_diff = Cost1-Cost0)
#View(Cost_Table37)


#Emissions Results
#View(Oct_30_18_MUD_scaled_baseline$EV_Demand)
write_csv(Oct_30_18_MUD_scaled_baseline$EV_Demand, "Event Results/MUD_Oct_30_18_Demand_Summary.csv")
Oct_30_18_MUD_output_table <- emissions_fcn_event(Oct_30_18_MUD_scaled_baseline$EV_Demand, intervention_hours = c(12:15)) 
write_csv(Oct_30_18_MUD_output_table$Emissions_Table, "Event Results/MUD_Oct_30_18_Output_Summary.csv") #write emissions to csv
write_csv(Oct_30_18_MUD_output_table$Emissions, "Event Results/MUD_Oct_30_18_Output_All_Hours.csv")
```


#Scenario 38 - October 16, 2018 MUD EVENT + Baseline (scaled for X chargers) 

Event: MUD, October 16, 2018, TOU EV-4, $0.05 Discount (11AM-3PM)

```{r Scenario 38}

#Scaled Baseline and October 16 event usage

#CHARGERS
Oct_16_18_MUD_event <- Event_Chargers %>%
filter(Market_Segment=="MUD") %>%
select(Oct_16_18_LS) %>%
unlist()


Oct_16_18_MUD_scaled_baseline <- hourly_demand(
                    month = 10,
                    year= 2018,
                    seg =  "Multi Unit Dwelling",
                    intervention_chargers =
                   Oct_16_18_MUD_event,
                    int_equals_baseline = FALSE,
                   include_wknds = FALSE)



Oct_16_18_MUD_Event_Usage <- filter(event_data, Date == "2018-10-16" & segment == "Multi Unit Dwelling") %>%
select(Demand) %>%
unlist() 

Oct_16_18_MUD_scaled_baseline$EV_Demand <- Oct_16_18_MUD_scaled_baseline$EV_Demand %>%
  mutate(Event_Usage = Oct_16_18_MUD_Event_Usage)


graph_table38 <- Oct_16_18_MUD_scaled_baseline$EV_Demand[c("Hr","X0","Event_Usage")] #%>%
  #gather(condition,value,c("X0","Event_Usage")) %>%
  #mutate(Theoretical_Max=Oct_16_18_MUD_scaled_baseline$EV_Demand$MT[1])

hr_24<- graph_table38[24,]
hr_24[1,1] <- 0
graph_table38 <- rbind(hr_24,graph_table38)

Demand_Graph38 <- ggplot(data = graph_table38, aes(x = Hr)) +
  geom_line(aes(x = Hr, 
                y = Event_Usage, 
                color = "Event Demand"), 
                size = 0.9, 
                alpha = 0.75) + #This is the Xf line
  geom_line(aes(x = Hr,
                y = X0,
                color = "Scaled Baseline Demand"),
                size = 0.9, 
                alpha = 0.75) + #This is the X0 line
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +
      xlab("Hour of the Day") +
      ylab("Electricity Demand (kW)") +
  geom_rect(aes(xmin = 11,
                xmax = 15,
                ymin = -Inf,
                ymax = Inf,
                fill = "Discount"),alpha = 0.005) +
  geom_rect(aes(xmin = 6,
                xmax = 11,
                ymin = -Inf,
                ymax = Inf,
                fill = "Throttle"),alpha = 0.005) +
  scale_x_continuous(limits = c(0,24),breaks = c(0:24), expand = c(0,0)) +
      scale_fill_manual('Interventions', values = c("Discount" = 'green',"Throttle" = 'red1', "Rebate" = 'yellow1', "Throttle and Rebate" = "#C7B19C"),  guide = guide_legend(override.aes = list(alpha = 0.1))) +
      theme(legend.position = "bottom") +
      scale_color_manual('Demand', values = c("Scaled Baseline Demand" = "red3", "Event Demand" ="dodgerblue2"))

#Potential_Graph38 <- Demand_Graph38 +
#geom_line(aes(y=Theoretical_Max))

Demand_Graph38
ggsave("Event Graphs/Oct_16_18_MUD_Event_Usage.png", Demand_Graph38, device = "png", width = 8, height = 4.5)

#COST
Cost_Table38 <- Oct_16_18_MUD_scaled_baseline$EV_Demand[c("Hr","X0","P0","Event_Usage","P1")] %>% 
  mutate(Cost0 = X0*P0) %>% 
  mutate(Cost1 = Event_Usage*P1) %>% 
  mutate(Cost_diff = Cost1-Cost0)
#View(Cost_Table38)


#Emissions Results
#View(Oct_16_18_MUD_scaled_baseline$EV_Demand)
write_csv(Oct_16_18_MUD_scaled_baseline$EV_Demand, "Event Results/MUD_Oct_16_18_Demand_Summary.csv")
Oct_16_18_MUD_output_table <- emissions_fcn_event(Oct_16_18_MUD_scaled_baseline$EV_Demand, intervention_hours = c(12:15)) 
write_csv(Oct_16_18_MUD_output_table$Emissions_Table, "Event Results/MUD_Oct_16_18_Output_Summary.csv") #write emissions to csv
write_csv(Oct_16_18_MUD_output_table$Emissions, "Event Results/MUD_Oct_16_18_Output_All_Hours.csv")
```

#Scenario 39 - September 27, 2018 MUD EVENT + Baseline (scaled for 22 chargers) 

Event: MUD, September 27, 2018, TOU EV-4, $0.10 Rebate (4PM-9PM)

```{r Scenario 38}

#Scaled Baseline andSeptember 27 event usage

#CHARGERS
Sep_27_18_MUD_event <- Event_Chargers %>%
filter(Market_Segment=="MUD") %>%
select(Sep_27_18_LR) %>%
unlist()


Sep_27_18_MUD_scaled_baseline <- hourly_demand(
                    month = 9,
                    year= 2018,
                    seg =  "Multi Unit Dwelling",
                    intervention_chargers =
                   Sep_27_18_MUD_event,
                    int_equals_baseline = FALSE,
                   include_wknds = FALSE)



Sep_27_18_MUD_Event_Usage <- filter(event_data, Date == "2018-9-27" & segment == "Multi Unit Dwelling") %>%
select(Demand) %>%
unlist() 

Sep_27_18_MUD_scaled_baseline$EV_Demand <- Sep_27_18_MUD_scaled_baseline$EV_Demand %>%
  mutate(Event_Usage = Sep_27_18_MUD_Event_Usage)


graph_table39 <-Sep_27_18_MUD_scaled_baseline$EV_Demand[c("Hr","X0","Event_Usage")] #%>%
  #gather(condition,value,c("X0","Event_Usage")) %>%
  #mutate(Theoretical_Max=Sep_27_18_MUD_scaled_baseline$EV_Demand$MT[1])

hr_24<- graph_table39[24,]
hr_24[1,1] <- 0
graph_table39 <- rbind(hr_24,graph_table39)

Demand_Graph39 <- ggplot(data = graph_table39, aes(x = Hr)) +
  geom_line(aes(x = Hr, 
                y = Event_Usage, 
                color = "Event Demand"), 
                size = 0.9, 
                alpha = 0.75) + #This is the Xf line
  geom_line(aes(x = Hr,
                y = X0,
                color = "Scaled Baseline Demand"),
                size = 0.9, 
                alpha = 0.75) + #This is the X0 line
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +
      xlab("Hour of the Day") +
      ylab("Electricity Demand (kW)") +
  geom_rect(aes(xmin = 16,
                xmax = 21,
                ymin = -Inf,
                ymax = Inf,
                fill = "Throttle and Rebate"),alpha = 0.01) + #this is the throttle + rebate rectangle REMOVE IF NO THROTTLING + REBATE
      scale_x_continuous(limits = c(0,24),breaks = c(0:24), expand = c(0,0)) +
      scale_fill_manual('Interventions', values = c("Discount" = 'green',"Throttle" = 'red1', "Rebate" = 'yellow1', "Throttle and Rebate" = "#C7B19C"),  guide = guide_legend(override.aes = list(alpha = 0.1))) +
      theme(legend.position = "bottom") +
      scale_color_manual('Demand', values = c("Scaled Baseline Demand" = "red3", "Event Demand" ="dodgerblue2"))

#Potential_Graph39 <- Demand_Graph39 +
#geom_line(aes(y=Theoretical_Max))

Demand_Graph39
ggsave("Event Graphs/Sep_27_18_MUD_Event_Usage.png", Demand_Graph39, device = "png", width = 8, height = 4.5)

#COST
Cost_Table39 <- Sep_27_18_MUD_scaled_baseline$EV_Demand[c("Hr","X0","P0","Event_Usage","P1")] %>% 
  mutate(Cost0 = X0*P0) %>% 
  mutate(Cost1 = Event_Usage*P1) %>% 
  mutate(Cost_diff = Cost1-Cost0)
#View(Cost_Table39)



#Emissions Results
#View(Sep_27_18_MUD_scaled_baseline$EV_Demand)
write_csv(Sep_27_18_MUD_scaled_baseline$EV_Demand, "Event Results/MUD_Sep_27_18_Demand_Summary.csv")
Sep_27_18_MUD_output_table <- emissions_fcn_event(Sep_27_18_MUD_scaled_baseline$EV_Demand, intervention_hours = c(17:21)) 
write_csv(Sep_27_18_MUD_output_table$Emissions_Table, "Event Results/MUD_Sep_27_18_Output_Summary.csv") #write emissions to csv
write_csv(Sep_27_18_MUD_output_table$Emissions, "Event Results/MUD_Sep_27_18_Output_All_Hours.csv")
```

#Scenario 40 - August 30, 2018 MUD EVENT + Baseline (scaled for 10 chargers) 

Event: MUD, August 30, 2018, TOU EV-4, $0.10 Rebate (4PM-9PM)

```{r Scenario 40}

#Scaled Baseline and August 30, event usage

#CHARGERS
Aug_30_18_MUD_event <- Event_Chargers %>%
filter(Market_Segment=="MUD") %>%
select(Aug_30_18_LR) %>%
unlist()


Aug_30_18_MUD_scaled_baseline <- hourly_demand(
                    month = 8,
                    year= 2018,
                    seg =  "Multi Unit Dwelling",
                    intervention_chargers =
                    Aug_30_18_MUD_event,
                    int_equals_baseline = FALSE,
                    include_wknds = FALSE)



Aug_30_18_MUD_Event_Usage <- filter(event_data, Date == "2018-8-30" & segment == "Multi Unit Dwelling") %>%
select(Demand) %>%
unlist() 

Aug_30_18_MUD_scaled_baseline$EV_Demand <- Aug_30_18_MUD_scaled_baseline$EV_Demand %>%
  mutate(Event_Usage = Aug_30_18_MUD_Event_Usage)


graph_table40 <-Aug_30_18_MUD_scaled_baseline$EV_Demand[c("Hr","X0","Event_Usage")] #%>%
  #gather(condition,value,c("X0","Event_Usage")) %>%
  #mutate(Theoretical_Max=Aug_30_18_MUD_scaled_baseline$EV_Demand$MT[1])

hr_24<- graph_table40[24,]
hr_24[1,1] <- 0
graph_table40 <- rbind(hr_24,graph_table40)

Demand_Graph40 <- ggplot(data = graph_table40, aes(x = Hr)) +
  geom_line(aes(x = Hr, 
                y = Event_Usage, 
                color = "Event Demand"), 
                size = 0.9, 
                alpha = 0.75) + #This is the Xf line
  geom_line(aes(x = Hr,
                y = X0,
                color = "Scaled Baseline Demand"),
                size = 0.9, 
                alpha = 0.75) + #This is the X0 line
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +
      xlab("Hour of the Day") +
      ylab("Electricity Demand (kW)") +
  geom_rect(aes(xmin = 16,
                xmax = 21,
                ymin = -Inf,
                ymax = Inf,
                fill = "Throttle and Rebate"),alpha = 0.01) +
      scale_x_continuous(limits = c(0,24),breaks = c(0:24), expand = c(0,0)) +
      scale_fill_manual('Interventions', values = c("Discount" = 'green',"Throttle" = 'red1', "Rebate" = 'yellow1', "Throttle and Rebate" = "#C7B19C"),  guide = guide_legend(override.aes = list(alpha = 0.1))) +
      theme(legend.position = "bottom") +
      scale_color_manual('Demand', values = c("Scaled Baseline Demand" = "red3", "Event Demand" ="dodgerblue2"))

#Potential_Graph40 <- Demand_Graph40 +
#geom_line(aes(y=Theoretical_Max))

Demand_Graph40
ggsave("Event Graphs/Aug_30_18_MUD_Event_Usage.png", Demand_Graph40, device = "png", width = 8, height = 4.5)

#COST
Cost_Table40 <- Aug_30_18_MUD_scaled_baseline$EV_Demand[c("Hr","X0","P0","Event_Usage","P1")] %>% 
  mutate(Cost0 = X0*P0) %>% 
  mutate(Cost1 = Event_Usage*P1) %>% 
  mutate(Cost_diff = Cost1-Cost0)
#View(Cost_Table40)


#Emissions Results
#View(Aug_30_18_MUD_scaled_baseline$EV_Demand)
write_csv(Aug_30_18_MUD_scaled_baseline$EV_Demand, "Event Results/MUD_Aug_30_18_Demand_Summary.csv")
Aug_30_18_MUD_output_table <- emissions_fcn_event(Aug_30_18_MUD_scaled_baseline$EV_Demand, intervention_hours = c(17:21)) 
write_csv(Aug_30_18_MUD_output_table$Emissions_Table, "Event Results/MUD_Aug_30_18_Output_Summary.csv") #write emissions to csv
write_csv(Aug_30_18_MUD_output_table$Emissions, "Event Results/MUD_Aug_30_18_Output_All_Hours.csv")
```

#Scenario 41 - July 31, 2018 MUD EVENT + Baseline (scaled for 22 chargers) 

Event: MUD, July 31, 2018, TOU EV-4, $0.10 Rebate (4PM-9PM)

```{r Scenario 41}

#Scaled Baseline and July 31, event usage

#CHARGERS
Jul_31_18_MUD_event <- Event_Chargers %>%
filter(Market_Segment=="MUD") %>%
select(Jul_31_18_LR) %>%
unlist()


Jul_31_18_MUD_scaled_baseline <- hourly_demand(
                    month = 7,
                    year= 2018,
                    seg =  "Multi Unit Dwelling",
                    intervention_chargers =
                    Jul_31_18_MUD_event,
                    int_equals_baseline = FALSE, price_change = 0)



Jul_31_18_MUD_Event_Usage <- filter(event_data, Date == "2018-7-31" & segment == "Multi Unit Dwelling") %>%
select(Demand) %>%
unlist() 

Jul_31_18_MUD_scaled_baseline$EV_Demand <- Jul_31_18_MUD_scaled_baseline$EV_Demand %>%
  mutate(Event_Usage = Jul_31_18_MUD_Event_Usage)

graph_table41 <-Jul_31_18_MUD_scaled_baseline$EV_Demand[c("Hr","X0","Event_Usage")] #%>%
  #gather(condition,value,c("X0","Event_Usage")) %>%
  #mutate(Theoretical_Max=Jul_31_18_MUD_scaled_baseline$EV_Demand$MT[1])

hr_24<- graph_table41[24,]
hr_24[1,1] <- 0
graph_table41S <- rbind(hr_24,graph_table41)

Demand_Graph41 <- ggplot(data = graph_table41, aes(x = Hr)) +
  geom_line(aes(x = Hr, 
                y = Event_Usage, 
                color = "Event Demand"), 
                size = 0.9, 
                alpha = 0.75) + #This is the Xf line
  geom_line(aes(x = Hr,
                y = X0,
                color = "Scaled Baseline Demand"),
                size = 0.9, 
                alpha = 0.75) + #This is the X0 line
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +
      xlab("Hour of the Day") +
      ylab("Electricity Demand (kW)") +
  geom_rect(aes(xmin = 16,
                xmax = 21,
                ymin = -Inf,
                ymax = Inf,
                fill = "Throttle and Rebate"),alpha = 0.01) +
      scale_x_continuous(limits = c(0,24),breaks = c(0:24), expand = c(0,0)) +
      scale_fill_manual('Interventions', values = c("Discount" = 'green',"Throttle" = 'red1', "Rebate" = 'yellow1', "Throttle and Rebate" = "#C7B19C"),  guide = guide_legend(override.aes = list(alpha = 0.1))) +
      theme(legend.position = "bottom") +
      scale_color_manual('Demand', values = c("Scaled Baseline Demand" = "red3", "Event Demand" ="dodgerblue2"))
  
#Potential_Graph41 <- Demand_Graph41 +
#geom_line(aes(y=Theoretical_Max))

Demand_Graph41
ggsave("Event Graphs/Jul_31_18_MUD_Event_Usage.png", Demand_Graph41, device = "png", width = 8, height = 4.5)

#COST
Cost_Table41 <- Jul_31_18_MUD_scaled_baseline$EV_Demand[c("Hr","X0","P0","Event_Usage","P1")] %>% 
  mutate(Cost0 = X0*P0) %>% 
  mutate(Cost1 = Event_Usage*P1) %>% 
  mutate(Cost_diff = Cost1-Cost0)
#View(Cost_Table41)



#Emissions Results
#View(Jul_31_18_MUD_scaled_baseline$EV_Demand)
write_csv(Jul_31_18_MUD_scaled_baseline$EV_Demand, "Event Results/MUD_Jul_31_18_Demand_Summary.csv")
Jul_31_18_MUD_output_table <- emissions_fcn_event(Jul_31_18_MUD_scaled_baseline$EV_Demand, intervention_hours = c(17:21)) 
write_csv(Jul_31_18_MUD_output_table$Emissions_Table, "Event Results/MUD_Jul_31_18_Output_Summary.csv") #write emissions to csv
write_csv(Jul_31_18_MUD_output_table$Emissions, "Event Results/MUD_Jul_31_18_Output_All_Hours.csv")
```

#Scenario 42 - July 11, 2018 MUD EVENT + Baseline (scaled for 23 chargers) 

Event: MUD, July 11, 2018, TOU EV-4, $0.10 Rebate (4PM-9PM)

```{r Scenario 42}

#Scaled Baseline and July 11, event usage

#CHARGERS
Jul_11_18_MUD_event <- Event_Chargers %>%
filter(Market_Segment=="MUD") %>%
select(Jul_11_18_LR) %>%
unlist()


Jul_11_18_MUD_scaled_baseline <- hourly_demand(
                    month = 7,
                    year= 2018,
                    seg =  "Multi Unit Dwelling",
                    intervention_chargers =
                    Jul_11_18_MUD_event,
                    int_equals_baseline = FALSE,
                    include_wknds = FALSE)



Jul_11_18_MUD_Event_Usage <- filter(event_data, Date == "2018-7-11" & segment == "Multi Unit Dwelling") %>%
select(Demand) %>%
unlist() 

Jul_11_18_MUD_scaled_baseline$EV_Demand <- Jul_11_18_MUD_scaled_baseline$EV_Demand %>%
  mutate(Event_Usage = Jul_11_18_MUD_Event_Usage)

graph_table42 <-Jul_11_18_MUD_scaled_baseline$EV_Demand[c("Hr","X0","Event_Usage")] #%>%
  #gather(condition,value,c("X0","Event_Usage")) %>%
  #mutate(Theoretical_Max=Jul_11_18_MUD_scaled_baseline$EV_Demand$MT[1])

hr_24<- graph_table42[24,]
hr_24[1,1] <- 0
graph_table42 <- rbind(hr_24,graph_table42)

Demand_Graph42 <- ggplot(data = graph_table42, aes(x = Hr)) +
  geom_line(aes(x = Hr, 
                y = Event_Usage, 
                color = "Event Demand"), 
                size = 0.9, 
                alpha = 0.75) + #This is the Xf line
  geom_line(aes(x = Hr,
                y = X0,
                color = "Scaled Baseline Demand"),
                size = 0.9, 
                alpha = 0.75) + #This is the X0 line
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +
      xlab("Hour of the Day") +
      ylab("Electricity Demand (kW)") +
  geom_rect(aes(xmin = 16,
                xmax = 21,
                ymin = -Inf,
                ymax = Inf,
                fill = "Throttle and Rebate"),alpha = 0.01) + #this is the throttle + rebate rectangle REMOVE IF NO THROTTLING + REBATE
      scale_x_continuous(limits = c(0,24),breaks = c(0:24), expand = c(0,0)) +
      scale_fill_manual('Interventions', values = c("Discount" = 'green',"Throttle" = 'red1', "Rebate" = 'yellow1', "Throttle and Rebate" = "#C7B19C"),  guide = guide_legend(override.aes = list(alpha = 0.1))) +
      theme(legend.position = "bottom") +
      scale_color_manual('Demand', values = c("Scaled Baseline Demand" = "red3", "Event Demand" ="dodgerblue2"))

#Potential_Graph42 <- Demand_Graph42 +
#geom_line(aes(y=Theoretical_Max))

Demand_Graph42
ggsave("Event Graphs/Jul_11_18_MUD_Event_Usage.png", Demand_Graph42, device = "png", width = 8, height = 4.5)

#COST
Cost_Table42 <- Jul_11_18_MUD_scaled_baseline$EV_Demand[c("Hr","X0","P0","Event_Usage","P1")] %>% 
  mutate(Cost0 = X0*P0) %>% 
  mutate(Cost1 = Event_Usage*P1) %>% 
  mutate(Cost_diff = Cost1-Cost0)
#View(Cost_Table42)


#Emissions Results
#View(Jul_11_18_MUD_scaled_baseline$EV_Demand)
write_csv(Jul_11_18_MUD_scaled_baseline$EV_Demand, "Event Results/MUD_Jul_11_18_Demand_Summary.csv")
Jul_11_18_MUD_output_table <- emissions_fcn_event(Jul_11_18_MUD_scaled_baseline$EV_Demand, intervention_hours = c(17:21)) 
write_csv(Jul_11_18_MUD_output_table$Emissions_Table, "Event Results/MUD_Jul_11_18_Output_Summary.csv") #write emissions to csv
write_csv(Jul_11_18_MUD_output_table$Emissions, "Event Results/MUD_Jul_11_18_Output_All_Hours.csv")
```


#WORKPLACE COST TABLES
```{r}
Cost_Table <- rbind(sum(Cost_Table13$Cost_diff), 
                    sum(Cost_Table14$Cost_diff),
                    sum(Cost_Table15$Cost_diff),
                    sum(Cost_Table16$Cost_diff),
                    sum(Cost_Table17$Cost_diff),
                    sum(Cost_Table18$Cost_diff)) %>% 
              mutate()
View(Cost_Table)
```






```{r explore}



# plot of monte carlo output
library(ggplot2)
freq_graph <- ggplot(sim1, aes(x = Hr, y = X0))+
  geom_line(aes(y = Hr_avg)) +
  geom_ribbon(aes(ymin = min, ymax = max))+
  geom_jitter(aes(y = Xf, color = Xf>X0), alpha = 0.5, width = 0.3) +
  geom_line(aes(x = Hr, y = X0), alpha = 0.5, color = "blue")+
  geom_point(aes(x = Hr, y = X0), alpha = 0.5, color = "blue")+
  #geom_ribbon(aes(ymin = min, ymax = max), alpha = 0.5, color ="blue") +
  #geom_line(aes(x = Hr, y = Hr_avg), alpha = 0.5, color = "red")+
  #geom_smooth(model = "lm") +
  theme_minimal() +
  xlab("Hour of the Day") +
  ylab("Charging Demand (kW)") +
  ggtitle("Monte Carlo Simulation of Charging Demand Per Hour")

freq_graph
```



```{r hypothetical_scenarios}

Total_max_theory <- pwr*Chargers$Nov_18[5]
Workplace_max_theory <- pwr*Chargers$Nov_18[4]
MUD_max_theory <- pwr*Chargers$Nov_18[3]
Fleet_max_theory <- pwr*Chargers$Nov_18[2]
DC_max_theory <- pwr*Chargers$Nov_18[1]

Max_theory_table <- Chargers %>% 
  select(Market_Segment, Nov_18) %>% 
  mutate(Theoretical_Max = pwr*Nov_18)

Max_theory_table #This shows the theoretical max per market segment (and total) for the SCE Charge Ready Pilot for ONE hour.

```



```{r new_Graph_design}

library(wesanderson)
library(extrafont)
loadfonts(device = "win")

Method1_test <- hourly_demand(method = 1, include_wknds = FALSE, price_comm = FALSE, elasticity_schedule = 7)
Method1_test_for_graph <- Method1_test$EV_Demand

Test_example_graph <- ggplot(Method1_test_for_graph) +
      geom_line(aes(x = Hr, y = Xf,color = "Intervention Demand"), 
                size = 0.9, 
                alpha = 0.75) + #This is the Xf line
      geom_line(aes(x = Hr,
                    y = X0,
                    color = "Baseline Demand"), #linetype = "dashed",
               size = 0.9, 
                alpha = 0.75) + #This is the X0 line
      ggtitle("Method 1") +
      xlab("Hour of the Day") +
      ylab("Electricity Demand (kW)") +
      geom_rect(aes(xmin= 11,
                    xmax=15,
                    ymin=-Inf,
                    ymax=Inf,
                    fill = "Discount"),
                alpha=0.005) + #this is the discount rectangle REMOVE IF NO DISCOUNT
geom_rect(aes(xmin= 16,
                   xmax=21,
                   ymin=-Inf,
                   ymax=Inf,
                    fill = "Rebate"),
                alpha=0.005) + 
  geom_rect(aes(xmin= 6,
                   xmax=11,
                    ymin=-Inf,
                    ymax=Inf,
                    fill = "Throttle"),
                alpha=0.005) + 
  geom_rect(aes(xmin= 22,
                    xmax=24,
                   ymin=-Inf,
                    ymax=Inf,
                    fill = "Throttle and Rebate"),
                alpha=0.01) +
      scale_x_continuous(limits = c(1,24),breaks = c(1:24), expand = c(0,0)) +
      scale_y_continuous(expand = c(0,0)) +
      scale_fill_manual('Interventions', values = c("Discount" = 'green',"Throttle" = 'red1', "Rebate" = 'yellow1', "Throttle and Rebate" = "#C7B19C"),  guide = guide_legend(override.aes = list(alpha = 0.1))) +
   scale_color_manual('Demand', values = c("Baseline Demand" = "red3", "Intervention Demand" ="dodgerblue2")) +
      theme(legend.position = "bottom") +
      theme_classic(base_family = "Helvetica")

Test_example_graph
ggsave("Results Graphs/test_graph.png", Test_example_graph, device = "png", width = 8, height = 4.5)


# COPIED TEMPLATE BEGINNING
hr_24<- graph_tablePW1S[24,]
hr_24[1,1] <- 0
graph_tablePW1S <- rbind(hr_24,graph_tablePW1S)


Demand_GraphPW1S <- ggplot(data = graph_tablePW1S, aes(x = Hr)) +
    geom_line(aes(x = Hr, 
                  y = Xf_mean, 
                  color = "Intervention Demand"), 
                  size = 0.9, 
                  alpha = 0.75) + #This is the Xf line
    geom_line(aes(x = Hr,
                  y = X0_mean,
                  color = "Baseline Demand"),
                  size = 0.9, 
                  alpha = 0.75) + #This is the X0 line
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
      panel.background = element_blank(), axis.line = element_line(colour = "black")) +
      xlab("Hour of the Day") +
      ylab("Electricity Demand (kW)") +
    geom_rect(aes(xmin = 11,
                  xmax = 15,
                  ymin = -Inf,
                  ymax = Inf,
                  fill = "Discount"),alpha = 0.005) + #this is the discount rectangle REMOVE IF NO DISCOUNT
    geom_rect(aes(xmin = 6,
                  xmax = 11,
                  ymin = -Inf,
                  ymax = Inf,
                  fill = "Throttle"),alpha = 0.005) + #this is the throttle rectangle REMOVE IF NO THROTTLING
    geom_rect(aes(xmin = 16,
                  xmax = 21,
                  ymin = -Inf,
                  ymax = Inf,
                  fill = "Rebate"),alpha = 0.005) + #this is the rebate rectangle REMOVE IF NO REBATE
    geom_rect(aes(xmin = 16,
                  xmax = 21,
                  ymin = -Inf,
                  ymax = Inf,
                  fill = "Throttle and Rebate"),alpha = 0.01) + #this is the throttle + rebate rectangle REMOVE IF NO THROTTLING + REBATE
      scale_x_continuous(limits = c(0,24),breaks = c(0:24), expand = c(0,0)) +
      scale_fill_manual('Interventions', values = c("Discount" = 'green',"Throttle" = 'red1', "Rebate" = 'yellow1', "Throttle and Rebate" = "#C7B19C"),  guide = guide_legend(override.aes = list(alpha = 0.1))) +
      theme(legend.position = "bottom") +
      scale_color_manual('Demand', values = c("Baseline Demand" = "red3", "Intervention Demand" ="dodgerblue2"))
# COPIED TEMPLATE END


```


